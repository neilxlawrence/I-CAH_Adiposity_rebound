
```{r, load software packages}
rm(list = ls())

#take the working directory otherwise, which should work every time?
if(!exists("location_of_main_folder")){
  location_of_main_folder <- 
    getwd()
}
#paste the name of our functions folder into the path name
location_of_functions_folder <-
  paste0(location_of_main_folder, "/ar_functions_folder/")

#load the function that loads all the libraries and sources
source(paste0(location_of_functions_folder, "load_ar_libraries_and_sources_function.R"))

#paste together the location of the data files - we don't load in the first file, but we need this location for the end
location_of_data_files <-
  paste0(location_of_main_folder, "/ar_data_files_to_load/")

#run the function, pointing it towards the functions folder
load_ar_libraries_and_sources_function(
  location_of_functions_folder=location_of_functions_folder,
  location_of_data_files=location_of_data_files
)

load_ar_files_function(previous_file_name = "file_21",
  parent_directory = location_of_data_files,
  list_of_data_frames_to_load=list("ar_data"))

```


```{r, define our optimum restrictions manually and extract all of our frames relating to the model with those restrictions for each of both_sexes male and fema}
suffix_of_optimum_weight_model_restrictions <- 
  "_weight_sitar_min_visits_6_min_age_0.2_max_age_20_df_6"
#then create each one through pasting
name_of_optimum_weight_model_restrictions_male <-
  paste0("male", suffix_of_optimum_weight_model_restrictions)
name_of_optimum_weight_model_restrictions_fema <-
  paste0("fema", suffix_of_optimum_weight_model_restrictions)
name_of_optimum_weight_model_restrictions_both_sexes <-
  paste0("both_sexes", suffix_of_optimum_weight_model_restrictions)

```

```{r}
#to calculate the who zscores for both sexes we need to add a column that has the data on all patients sex
#take sex from the main frame
ar_data_id_sex <-
  unique(
  ar_data[,c(
    "id",
    "sex_1_for_M_2_for_F"
  )]
  )
ar_data_id_sex$id <- as.character(ar_data_id_sex$id)
ar_data_id_sex$sex_1_for_M_2_for_F <- as.numeric(ar_data_id_sex$sex_1_for_M_2_for_F)
```


```{r, load our sitar model frames for male}
load(   
     file = paste0("ar_data_files_to_load/list_of_male_sitar_models_weight.Rdata"))
load(   
     file = paste0("ar_data_files_to_load/list_of_male_overall_fixed_effects_weight.Rdata"))
load(   
     file = paste0("ar_data_files_to_load/list_of_male_random_effects_weight.Rdata"))
load(   
     file = paste0("ar_data_files_to_load/list_of_male_patient_data_with_sitar_predictions_weight.Rdata"))
load(   
     file = paste0("ar_data_files_to_load/list_of_male_individual_patient_random_effects_for_curves_weight.Rdata"))
load(   
     file = paste0("ar_data_files_to_load/list_of_male_fitting_results_weight.Rdata"))
load(   
     file = paste0("ar_data_files_to_load/list_of_male_error_messages_weight.Rdata"))
```


```{r, extract our optimum fits for male from the lists}
male_sitar_model <-
  list_of_male_sitar_models_weight[[name_of_optimum_weight_model_restrictions_male]]
male_overall_fixed_effects_weight <-
  list_of_male_overall_fixed_effects_weight[[name_of_optimum_weight_model_restrictions_male]]
male_random_effects_weight_metrics <-
  list_of_male_random_effects_weight[[name_of_optimum_weight_model_restrictions_male]]
male_patient_data_with_sitar_predictions_weight <-
  list_of_male_patient_data_with_sitar_predictions_weight[[name_of_optimum_weight_model_restrictions_male]]
male_individual_patient_random_effects_for_curves_weight <-
  list_of_male_individual_patient_random_effects_for_curves_weight[[name_of_optimum_weight_model_restrictions_male]]
male_fitting_results_weight <-
  list_of_male_fitting_results_weight[[name_of_optimum_weight_model_restrictions_male]]
male_error_messages_weight <-
  list_of_male_error_messages_weight[[name_of_optimum_weight_model_restrictions_male]]

```


```{r, extract the spline basis for male and formulate table for sitar model estimates}
# Get the predvars attribute
predvars <- attr(male_sitar_model$ns$terms, "predvars")

# Extract knots and boundary knots
# Extract from the call directly
spline_call <- attr(male_sitar_model$ns$terms, "predvars")[[3]]

# Evaluate components
internal_knots_male <- eval(spline_call$knots)
boundary_knots_male <- eval(spline_call$Boundary.knots)

library(splines)

# x-values used in the model
x <- seq(0, 20, by=0.1)

# Rebuild the spline basis matrix exactly as used in the model
spline_basis_male <- ns(
  x,
  knots = internal_knots_male,
  Boundary.knots = boundary_knots_male,
  intercept = FALSE
)


df_plot <- data.frame(
  x = x,
  spline_basis_male
) %>%
  pivot_longer(-x, names_to = "basis", values_to = "value")

ggplot(df_plot, aes(x = x, y = value, color = basis)) +
  geom_line() +
  labs(title = "Spline Basis Functions from sitar Model") +
  theme_minimal()


dir.create("SITAR_model_parameters")
sitar_coefficients_male <- 
  summary(male_sitar_model)$tTable
#coef(male_sitar_model) gives you all the random effects and takes ages!

#extract standard deviation of random effects
std_dev_random_effects <- 
  (VarCorr(male_sitar_model)[, "StdDev"])

fixed_effects_male <-
  fixed.effects(male_sitar_model)


decimal_places <- 3

sitar_model_parameters_weight_male <-
data.frame(

  sitar_internal_knots = paste0(
    round(internal_knots_male[[1]], digits=decimal_places),
    ",\n",
    round(internal_knots_male[[2]], digits=decimal_places),
    ",\n",
    round(internal_knots_male[[3]], digits=decimal_places),
    ",\n",
    round(internal_knots_male[[4]], digits=decimal_places),
    ",\n",
    round(internal_knots_male[[5]], digits=decimal_places)),
    
  sitar_boundary_knots = paste0(
    round(boundary_knots_male[[1]], digits=decimal_places),
    ",\n",
    round(boundary_knots_male[[2]], digits=decimal_places)),
  
  sitar_fixed_s1 = 
    round(fixed_effects_male[["s1"]], digits=decimal_places),
  
  sitar_fixed_s2 = 
    round(fixed_effects_male[["s2"]], digits=decimal_places),
  
  sitar_fixed_s3 = 
    round(fixed_effects_male[["s3"]], digits=decimal_places),
  
  sitar_fixed_s4 = 
    round(fixed_effects_male[["s4"]], digits=decimal_places),
  
  sitar_fixed_s5 = 
    round(fixed_effects_male[["s5"]], digits=decimal_places),
  
  sitar_fixed_s6 = 
    round(fixed_effects_male[["s6"]], digits=decimal_places),
  
  sitar_fixed_a = 
    round(fixed_effects_male[["a"]], digits=decimal_places),

  sitar_fixed_b = 
    round(fixed_effects_male[["b"]], digits=decimal_places),

  sitar_fixed_c = 
    round(fixed_effects_male[["c"]], digits=decimal_places),
    
  sitar_random_a_se = 
    round(as.numeric(std_dev_random_effects[["a"]]), digits=decimal_places),
    
  sitar_random_b_se = 
    round(as.numeric(std_dev_random_effects[["b"]]), digits=decimal_places),
    
  sitar_random_c_se = 
    round(as.numeric(std_dev_random_effects[["c"]]), digits=decimal_places)
)

sitar_model_parameters_weight_male_t <- 
  rownames_to_column(as.data.frame(t(sitar_model_parameters_weight_male)))
write.csv(
  sitar_model_parameters_weight_male_t,
  "SITAR_model_parameters/sitar_model_parameters_weight_male.csv")

ft <- flextable(sitar_model_parameters_weight_male_t)
  
  # Customize the table appearance
  ft <- ft %>%
    theme_vanilla() %>%
    align(align = "center", part = "header") %>%
    align(align = "center", part = "body") %>%  
    autofit()
  
  # Define paragraph formatting with centered alignment
  centered_paragraph <- fp_par(text.align = "center")
  
  doc <- read_docx() %>%
    body_add_flextable(ft) 
  
  print(
    doc, 
    target = file.path(paste0("SITAR_model_parameters/sitar_model_parameters_weight_male_t", ".docx")))

```


```{r}
#first we start by only extracting the id a b and c from the random effects frame. This way if we run this file multiple times, we don't get stacking of extra columns adding each thing again and again
male_random_effects_weight_metrics <-
  male_random_effects_weight_metrics[,1:4]

if (is.null(male_random_effects_weight_metrics$a_)){
#rename the random effects to weight
male_random_effects_weight_metrics <-
dplyr::rename(
  male_random_effects_weight_metrics, 
    c("a_weight"="a", 
      "b_weight"="b",
      "c_weight"="c"))
}
```


```{r, use our random effects curve frames to calculate salient metrics of growth for interpretation on the absolute scale for male}

#join in the sex to the random effects frame
male_individual_patient_random_effects_for_curves_weight$id <-
  as.character(male_individual_patient_random_effects_for_curves_weight$id)
male_individual_patient_random_effects_for_curves_weight <-
  left_join(
    male_individual_patient_random_effects_for_curves_weight,
    ar_data_id_sex,
    by="id"
  )

#add the weight velocity
male_individual_patient_random_effects_for_curves_weight <- 
  male_individual_patient_random_effects_for_curves_weight %>%
        mutate(
          years_to_next_reading = 
            lead(age) - age,
          weight_to_next_reading = 
            lead(random_sitar_prediction) - random_sitar_prediction,
          weight_velocity_to_next_reading = 
            weight_to_next_reading / years_to_next_reading,
          lead_id =
            lead(id))

#correct to NA if the lead_id is different for years_to_next_reading
male_individual_patient_random_effects_for_curves_weight$years_to_next_reading <-
  ifelse(male_individual_patient_random_effects_for_curves_weight$lead_id!=
           male_individual_patient_random_effects_for_curves_weight$id,
         NA,
         male_individual_patient_random_effects_for_curves_weight$years_to_next_reading)
#correct to NA if the lead_id is different for weight_to_next_reading
male_individual_patient_random_effects_for_curves_weight$weight_to_next_reading <-
  ifelse(male_individual_patient_random_effects_for_curves_weight$lead_id!=
           male_individual_patient_random_effects_for_curves_weight$id,
         NA,
         male_individual_patient_random_effects_for_curves_weight$weight_to_next_reading)
#correct to NA if the lead_id is different for weight_velocity_to_next_reading
male_individual_patient_random_effects_for_curves_weight$weight_velocity_to_next_reading <-
  ifelse(male_individual_patient_random_effects_for_curves_weight$lead_id!=
           male_individual_patient_random_effects_for_curves_weight$id,
         NA,
         male_individual_patient_random_effects_for_curves_weight$weight_velocity_to_next_reading)
      
#calculate the salient metrics for this patient
#take out just data after 6 years of age
male_individual_patient_random_effects_over_six_years <-
  subset(
    male_individual_patient_random_effects_for_curves_weight,
    age >= 6)
      
#take out the whole row for each patient with maximum weight velocity after 6
male_individual_patient_random_effects_fastest_over_six_years <-
  male_individual_patient_random_effects_over_six_years %>%
  group_by(id) %>%
  slice_max(n=1, with_ties = F, weight_velocity_to_next_reading)
#then rename the random_sitar_prediction as max_weight_velocity_at_pubertal_spurt_after_six
names(male_individual_patient_random_effects_fastest_over_six_years)[
  names(male_individual_patient_random_effects_fastest_over_six_years)=="weight_velocity_to_next_reading"] <- 
  "max_weight_velocity_at_pubertal_spurt_after_six"
#and rename the age as age_at_max_weight_velocity_at_pubertal_spurt_after_six
names(male_individual_patient_random_effects_fastest_over_six_years)[
  names(male_individual_patient_random_effects_fastest_over_six_years)=="age"] <- 
  "age_at_max_weight_velocity_at_pubertal_spurt_after_six"
#then just extract those two columns that we want
male_individual_patient_random_effects_fastest_over_six_years <-
  male_individual_patient_random_effects_fastest_over_six_years[,c(
    "id",
    "max_weight_velocity_at_pubertal_spurt_after_six",
    "age_at_max_weight_velocity_at_pubertal_spurt_after_six"
  )]

#loop around a load of individual ages we want to extract 
for (age_to_extract in c(seq(0.5,20, by=0.5))){

    #extract the weight at that age
male_individual_patient_random_effects_at_specific_age <-
  subset(male_individual_patient_random_effects_for_curves_weight,
         dplyr::near(age, age_to_extract, tol = 1e-6))[,c(
           "id",
           "age",
           "sex_1_for_M_2_for_F",
           "random_sitar_prediction"
         )]

#insert a rescue clause here for random effects that are out of range before we calculate the z score turning any ridiculous weight into NA
male_individual_patient_random_effects_at_specific_age$random_sitar_prediction <-
  ifelse(male_individual_patient_random_effects_at_specific_age$random_sitar_prediction < 1 |
           male_individual_patient_random_effects_at_specific_age$random_sitar_prediction > 300,
         NA,
         male_individual_patient_random_effects_at_specific_age$random_sitar_prediction)

#give us an indicator variable also telling us these weights are spurious
male_individual_patient_random_effects_at_specific_age$spurious_sitar_weight <-
  ifelse(
    is.na(male_individual_patient_random_effects_at_specific_age$random_sitar_prediction)  ,
    1,
    0
  )
#calculate the who z score at this weight for age
#if the age is 5 or older we use this:
if (age_to_extract>=5){
male_individual_patient_random_effects_at_specific_age$who_z_sitar_weight_for_age_at_specific_age <-
  anthroplus::anthroplus_zscores(
   sex =                male_individual_patient_random_effects_at_specific_age$sex_1_for_M_2_for_F,
   age_in_months =      male_individual_patient_random_effects_at_specific_age$age * 12,
#   height_in_cm =             ar_data$interpolated_weight,
   weight_in_kg =             male_individual_patient_random_effects_at_specific_age$random_sitar_prediction
)$zwfa
}
#if it is less than five the we use the other anthro package
if (age_to_extract<5){
male_individual_patient_random_effects_at_specific_age$who_z_sitar_weight_for_age_at_specific_age <-
  anthro::anthro_zscores(
   sex =                male_individual_patient_random_effects_at_specific_age$sex_1_for_M_2_for_F,
   age =      male_individual_patient_random_effects_at_specific_age$age * 12,
#   lenhei =             ar_data$interpolated_weight,
   weight =             as.numeric(male_individual_patient_random_effects_at_specific_age$random_sitar_prediction), 
          is_age_in_month = T 
)$zwei
}



#now we have used the sex column we can get rid of it to stop it duplicating 
male_individual_patient_random_effects_at_specific_age$sex_1_for_M_2_for_F <- NULL

#rename that column to tell us the age at which the weight was spurious
names(male_individual_patient_random_effects_at_specific_age)[
  names(male_individual_patient_random_effects_at_specific_age)=="spurious_sitar_weight"] <- 
  paste0("sitar_weight_spurious_at_age_", age_to_extract)
#rename that column to tell us the age at who_z_sitar_weight_for_age_at_specific_age
names(male_individual_patient_random_effects_at_specific_age)[
  names(male_individual_patient_random_effects_at_specific_age)=="who_z_sitar_weight_for_age_at_specific_age"] <- 
  paste0("who_z_sitar_weight_for_age_at_age_", age_to_extract)

#then rename the random_sitar_prediction as sitar_weight_at_age whatever it is
names(male_individual_patient_random_effects_at_specific_age)[
  names(male_individual_patient_random_effects_at_specific_age)=="random_sitar_prediction"] <- 
  paste0("sitar_weight_at_age_", age_to_extract)

#then rename the age to give us the precise age at whatever it is
names(male_individual_patient_random_effects_at_specific_age)[
  names(male_individual_patient_random_effects_at_specific_age)=="age"] <- 
  paste0("precise_age_at_sitar_weight_at_age_", age_to_extract)


#join the extracted age in
male_individual_patient_random_effects_at_specific_age$id <-
  as.character(male_individual_patient_random_effects_at_specific_age$id)
male_random_effects_weight_metrics <-
  left_join(
    male_random_effects_weight_metrics, 
    male_individual_patient_random_effects_at_specific_age,
    by = join_by(id))
}

```

```{r, join our other calculated metrics into the overall random effects frame to have them available next to a b and c for male}
male_individual_patient_random_effects_fastest_over_six_years$id <-
  as.character(male_individual_patient_random_effects_fastest_over_six_years$id)
male_random_effects_weight_metrics <-
  left_join(
    male_random_effects_weight_metrics, 
    male_individual_patient_random_effects_fastest_over_six_years,
    by = join_by(id))
```



```{r, replace the version of our random effects data within our list for male}
#first remove the sex column so that when we join it back into the main frame in future we don't get a duplication of the sex column 
male_random_effects_weight_metrics$sex_1_for_M_2_for_F <- NULL

list_of_male_random_effects_weight[[name_of_optimum_weight_model_restrictions_male]] <-
  as.data.frame(male_random_effects_weight_metrics)
```

```{r, save our list of random effects again for male}
#we can save this list here again, because when we load it above if we rerun the file, we remove the calculated columns
save(list_of_male_random_effects_weight,   
     file = paste0("ar_data_files_to_load/list_of_male_random_effects_weight.Rdata"))
```









```{r, load our sitar model frames for fema}
load(   
     file = paste0("ar_data_files_to_load/list_of_fema_sitar_models_weight.Rdata"))
load(   
     file = paste0("ar_data_files_to_load/list_of_fema_overall_fixed_effects_weight.Rdata"))
load(   
     file = paste0("ar_data_files_to_load/list_of_fema_random_effects_weight.Rdata"))
load(   
     file = paste0("ar_data_files_to_load/list_of_fema_patient_data_with_sitar_predictions_weight.Rdata"))
load(   
     file = paste0("ar_data_files_to_load/list_of_fema_individual_patient_random_effects_for_curves_weight.Rdata"))
load(   
     file = paste0("ar_data_files_to_load/list_of_fema_fitting_results_weight.Rdata"))
load(   
     file = paste0("ar_data_files_to_load/list_of_fema_error_messages_weight.Rdata"))
```


```{r, extract our optimum fits for fema from the lists}
fema_sitar_model <-
  list_of_fema_sitar_models_weight[[name_of_optimum_weight_model_restrictions_fema]]
fema_overall_fixed_effects_weight <-
  list_of_fema_overall_fixed_effects_weight[[name_of_optimum_weight_model_restrictions_fema]]
fema_random_effects_weight_metrics <-
  list_of_fema_random_effects_weight[[name_of_optimum_weight_model_restrictions_fema]]
fema_patient_data_with_sitar_predictions_weight <-
  list_of_fema_patient_data_with_sitar_predictions_weight[[name_of_optimum_weight_model_restrictions_fema]]
fema_individual_patient_random_effects_for_curves_weight <-
  list_of_fema_individual_patient_random_effects_for_curves_weight[[name_of_optimum_weight_model_restrictions_fema]]
fema_fitting_results_weight <-
  list_of_fema_fitting_results_weight[[name_of_optimum_weight_model_restrictions_fema]]
fema_error_messages_weight <-
  list_of_fema_error_messages_weight[[name_of_optimum_weight_model_restrictions_fema]]

```


```{r, extract the spline basis for fema and formulate table for sitar model estimates}
# Get the predvars attribute
predvars <- attr(fema_sitar_model$ns$terms, "predvars")

# Extract knots and boundary knots
# Extract from the call directly
spline_call <- attr(fema_sitar_model$ns$terms, "predvars")[[3]]

# Evaluate components
internal_knots_fema <- eval(spline_call$knots)
boundary_knots_fema <- eval(spline_call$Boundary.knots)

library(splines)

# x-values used in the model
x <- seq(0, 20, by=0.1)

# Rebuild the spline basis matrix exactly as used in the model
spline_basis_fema <- ns(
  x,
  knots = internal_knots_fema,
  Boundary.knots = boundary_knots_fema,
  intercept = FALSE
)


df_plot <- data.frame(
  x = x,
  spline_basis_fema
) %>%
  pivot_longer(-x, names_to = "basis", values_to = "value")

ggplot(df_plot, aes(x = x, y = value, color = basis)) +
  geom_line() +
  labs(title = "Spline Basis Functions from sitar Model") +
  theme_minimal()


dir.create("SITAR_model_parameters")
sitar_coefficients_fema <- 
  summary(fema_sitar_model)$tTable
#coef(fema_sitar_model) gives you all the random effects and takes ages!

#extract standard deviation of random effects
std_dev_random_effects <- 
  (VarCorr(fema_sitar_model)[, "StdDev"])

fixed_effects_fema <-
  fixed.effects(fema_sitar_model)


decimal_places <- 3

sitar_model_parameters_weight_fema <-
data.frame(

  sitar_internal_knots = paste0(
    round(internal_knots_fema[[1]], digits=decimal_places),
    ",\n",
    round(internal_knots_fema[[2]], digits=decimal_places),
    ",\n",
    round(internal_knots_fema[[3]], digits=decimal_places),
    ",\n",
    round(internal_knots_fema[[4]], digits=decimal_places),
    ",\n",
    round(internal_knots_fema[[5]], digits=decimal_places)),
    
  sitar_boundary_knots = paste0(
    round(boundary_knots_fema[[1]], digits=decimal_places),
    ",\n",
    round(boundary_knots_fema[[2]], digits=decimal_places)),
  
  sitar_fixed_s1 = 
    round(fixed_effects_fema[["s1"]], digits=decimal_places),
  
  sitar_fixed_s2 = 
    round(fixed_effects_fema[["s2"]], digits=decimal_places),
  
  sitar_fixed_s3 = 
    round(fixed_effects_fema[["s3"]], digits=decimal_places),
  
  sitar_fixed_s4 = 
    round(fixed_effects_fema[["s4"]], digits=decimal_places),
  
  sitar_fixed_s5 = 
    round(fixed_effects_fema[["s5"]], digits=decimal_places),
  
  sitar_fixed_s6 = 
    round(fixed_effects_fema[["s6"]], digits=decimal_places),
  
  sitar_fixed_a = 
    round(fixed_effects_fema[["a"]], digits=decimal_places),

  sitar_fixed_b = 
    round(fixed_effects_fema[["b"]], digits=decimal_places),

  sitar_fixed_c = 
    round(fixed_effects_fema[["c"]], digits=decimal_places),
    
  sitar_random_a_se = 
    round(as.numeric(std_dev_random_effects[["a"]]), digits=decimal_places),
    
  sitar_random_b_se = 
    round(as.numeric(std_dev_random_effects[["b"]]), digits=decimal_places),
    
  sitar_random_c_se = 
    round(as.numeric(std_dev_random_effects[["c"]]), digits=decimal_places)
)

sitar_model_parameters_weight_fema_t <- 
  rownames_to_column(as.data.frame(t(sitar_model_parameters_weight_fema)))
write.csv(
  sitar_model_parameters_weight_fema_t,
  "SITAR_model_parameters/sitar_model_parameters_weight_fema.csv")

ft <- flextable(sitar_model_parameters_weight_fema_t)
  
  # Customize the table appearance
  ft <- ft %>%
    theme_vanilla() %>%
    align(align = "center", part = "header") %>%
    align(align = "center", part = "body") %>%  
    autofit()
  
  # Define paragraph formatting with centered alignment
  centered_paragraph <- fp_par(text.align = "center")
  
  doc <- read_docx() %>%
    body_add_flextable(ft) 
  
  print(
    doc, 
    target = file.path(paste0("SITAR_model_parameters/sitar_model_parameters_weight_fema_t", ".docx")))

```


```{r}
#first we start by only extracting the id a b and c from the random effects frame. This way if we run this file multiple times, we don't get stacking of extra columns adding each thing again and again
fema_random_effects_weight_metrics <-
  fema_random_effects_weight_metrics[,1:4]

if (is.null(fema_random_effects_weight_metrics$a_)){
#rename the random effects to weight
fema_random_effects_weight_metrics <-
dplyr::rename(
  fema_random_effects_weight_metrics, 
    c("a_weight"="a", 
      "b_weight"="b",
      "c_weight"="c"))
}
```


```{r, use our random effects curve frames to calculate salient metrics of growth for interpretation on the absolute scale for fema}

#join in the sex to the random effects frame
fema_individual_patient_random_effects_for_curves_weight$id <-
  as.character(fema_individual_patient_random_effects_for_curves_weight$id)
fema_individual_patient_random_effects_for_curves_weight <-
  left_join(
    fema_individual_patient_random_effects_for_curves_weight,
    ar_data_id_sex,
    by="id"
  )

#add the weight velocity
fema_individual_patient_random_effects_for_curves_weight <- 
  fema_individual_patient_random_effects_for_curves_weight %>%
        mutate(
          years_to_next_reading = 
            lead(age) - age,
          weight_to_next_reading = 
            lead(random_sitar_prediction) - random_sitar_prediction,
          weight_velocity_to_next_reading = 
            weight_to_next_reading / years_to_next_reading,
          lead_id =
            lead(id))

#correct to NA if the lead_id is different for years_to_next_reading
fema_individual_patient_random_effects_for_curves_weight$years_to_next_reading <-
  ifelse(fema_individual_patient_random_effects_for_curves_weight$lead_id!=
           fema_individual_patient_random_effects_for_curves_weight$id,
         NA,
         fema_individual_patient_random_effects_for_curves_weight$years_to_next_reading)
#correct to NA if the lead_id is different for weight_to_next_reading
fema_individual_patient_random_effects_for_curves_weight$weight_to_next_reading <-
  ifelse(fema_individual_patient_random_effects_for_curves_weight$lead_id!=
           fema_individual_patient_random_effects_for_curves_weight$id,
         NA,
         fema_individual_patient_random_effects_for_curves_weight$weight_to_next_reading)
#correct to NA if the lead_id is different for weight_velocity_to_next_reading
fema_individual_patient_random_effects_for_curves_weight$weight_velocity_to_next_reading <-
  ifelse(fema_individual_patient_random_effects_for_curves_weight$lead_id!=
           fema_individual_patient_random_effects_for_curves_weight$id,
         NA,
         fema_individual_patient_random_effects_for_curves_weight$weight_velocity_to_next_reading)
      
#calculate the salient metrics for this patient
#take out just data after 6 years of age
fema_individual_patient_random_effects_over_six_years <-
  subset(
    fema_individual_patient_random_effects_for_curves_weight,
    age >= 6)
      
#take out the whole row for each patient with maximum weight velocity after 6
fema_individual_patient_random_effects_fastest_over_six_years <-
  fema_individual_patient_random_effects_over_six_years %>%
  group_by(id) %>%
  slice_max(n=1, with_ties = F, weight_velocity_to_next_reading)
#then rename the random_sitar_prediction as max_weight_velocity_at_pubertal_spurt_after_six
names(fema_individual_patient_random_effects_fastest_over_six_years)[
  names(fema_individual_patient_random_effects_fastest_over_six_years)=="weight_velocity_to_next_reading"] <- 
  "max_weight_velocity_at_pubertal_spurt_after_six"
#and rename the age as age_at_max_weight_velocity_at_pubertal_spurt_after_six
names(fema_individual_patient_random_effects_fastest_over_six_years)[
  names(fema_individual_patient_random_effects_fastest_over_six_years)=="age"] <- 
  "age_at_max_weight_velocity_at_pubertal_spurt_after_six"
#then just extract those two columns that we want
fema_individual_patient_random_effects_fastest_over_six_years <-
  fema_individual_patient_random_effects_fastest_over_six_years[,c(
    "id",
    "max_weight_velocity_at_pubertal_spurt_after_six",
    "age_at_max_weight_velocity_at_pubertal_spurt_after_six"
  )]

#loop around a load of individual ages we want to extract 
for (age_to_extract in c(seq(0.5,20, by=0.5))){

    #extract the weight at that age
fema_individual_patient_random_effects_at_specific_age <-
  subset(fema_individual_patient_random_effects_for_curves_weight,
         dplyr::near(age, age_to_extract, tol = 1e-6))[,c(
           "id",
           "age",
           "sex_1_for_M_2_for_F",
           "random_sitar_prediction"
         )]

#insert a rescue clause here for random effects that are out of range before we calculate the z score turning any ridiculous weight into NA
fema_individual_patient_random_effects_at_specific_age$random_sitar_prediction <-
  ifelse(fema_individual_patient_random_effects_at_specific_age$random_sitar_prediction < 1 |
           fema_individual_patient_random_effects_at_specific_age$random_sitar_prediction > 300,
         NA,
         fema_individual_patient_random_effects_at_specific_age$random_sitar_prediction)

#give us an indicator variable also telling us these weights are spurious
fema_individual_patient_random_effects_at_specific_age$spurious_sitar_weight <-
  ifelse(
    is.na(fema_individual_patient_random_effects_at_specific_age$random_sitar_prediction)  ,
    1,
    0
  )
#calculate the who z score at this weight
#if the age is 5 or older we use this:
if (age_to_extract>=5){
fema_individual_patient_random_effects_at_specific_age$who_z_sitar_weight_for_age_at_specific_age <-
  anthroplus::anthroplus_zscores(
   sex =                fema_individual_patient_random_effects_at_specific_age$sex_1_for_M_2_for_F,
   age_in_months =      fema_individual_patient_random_effects_at_specific_age$age * 12,
#   height_in_cm =             ar_data$interpolated_weight,
   weight_in_kg =             fema_individual_patient_random_effects_at_specific_age$random_sitar_prediction
)$zwfa
}
#if it is less than five the we use the other anthro package
if (age_to_extract<5){
fema_individual_patient_random_effects_at_specific_age$who_z_sitar_weight_for_age_at_specific_age <-
  anthro::anthro_zscores(
   sex =                fema_individual_patient_random_effects_at_specific_age$sex_1_for_M_2_for_F,
   age =      fema_individual_patient_random_effects_at_specific_age$age * 12,
#   lenhei =             ar_data$interpolated_weight,
   weight =             as.numeric(fema_individual_patient_random_effects_at_specific_age$random_sitar_prediction), 
          is_age_in_month = T 
)$zwei
}

#now we have used the sex column we can get rid of it to stop it duplicating 
fema_individual_patient_random_effects_at_specific_age$sex_1_for_M_2_for_F <- NULL

#rename that column to tell us the age at which the weight was spurious
names(fema_individual_patient_random_effects_at_specific_age)[
  names(fema_individual_patient_random_effects_at_specific_age)=="spurious_sitar_weight"] <- 
  paste0("sitar_weight_spurious_at_age_", age_to_extract)
#rename that column to tell us the age at who_z_sitar_weight_for_age_at_specific_age
names(fema_individual_patient_random_effects_at_specific_age)[
  names(fema_individual_patient_random_effects_at_specific_age)=="who_z_sitar_weight_for_age_at_specific_age"] <- 
  paste0("who_z_sitar_weight_for_age_at_age_", age_to_extract)

#then rename the random_sitar_prediction as sitar_weight_at_age whatever it is
names(fema_individual_patient_random_effects_at_specific_age)[
  names(fema_individual_patient_random_effects_at_specific_age)=="random_sitar_prediction"] <- 
  paste0("sitar_weight_at_age_", age_to_extract)

#then rename the age to give us the precise age at whatever it is
names(fema_individual_patient_random_effects_at_specific_age)[
  names(fema_individual_patient_random_effects_at_specific_age)=="age"] <- 
  paste0("precise_age_at_sitar_weight_at_age_", age_to_extract)


#join the extracted age in
fema_individual_patient_random_effects_at_specific_age$id <-
  as.character(fema_individual_patient_random_effects_at_specific_age$id)
fema_random_effects_weight_metrics <-
  left_join(
    fema_random_effects_weight_metrics, 
    fema_individual_patient_random_effects_at_specific_age,
    by = join_by(id))
}

```

```{r, join our other calculated metrics into the overall random effects frame to have them available next to a b and c for fema}
fema_individual_patient_random_effects_fastest_over_six_years$id <-
  as.character(fema_individual_patient_random_effects_fastest_over_six_years$id)
fema_random_effects_weight_metrics <-
  left_join(
    fema_random_effects_weight_metrics, 
    fema_individual_patient_random_effects_fastest_over_six_years,
    by = join_by(id))
```



```{r, replace the version of our random effects data within our list for fema}
#first remove the sex column so that when we join it back into the main frame in future we don't get a duplication of the sex column 
fema_random_effects_weight_metrics$sex_1_for_M_2_for_F <- NULL

list_of_fema_random_effects_weight[[name_of_optimum_weight_model_restrictions_fema]] <-
  as.data.frame(fema_random_effects_weight_metrics)
```

```{r, save our list of random effects again for fema}
#we can save this list here again, because when we load it above if we rerun the file, we remove the calculated columns
save(list_of_fema_random_effects_weight,   
     file = paste0("ar_data_files_to_load/list_of_fema_random_effects_weight.Rdata"))
```



```{r, load our sitar model frames for both_sexes}
load(   
     file = paste0("ar_data_files_to_load/list_of_both_sexes_sitar_models_weight.Rdata"))
load(   
     file = paste0("ar_data_files_to_load/list_of_both_sexes_overall_fixed_effects_weight.Rdata"))
load(   
     file = paste0("ar_data_files_to_load/list_of_both_sexes_random_effects_weight.Rdata"))
load(   
     file = paste0("ar_data_files_to_load/list_of_both_sexes_patient_data_with_sitar_predictions_weight.Rdata"))
load(   
     file = paste0("ar_data_files_to_load/list_of_both_sexes_individual_patient_random_effects_for_curves_weight.Rdata"))
load(   
     file = paste0("ar_data_files_to_load/list_of_both_sexes_fitting_results_weight.Rdata"))
load(   
     file = paste0("ar_data_files_to_load/list_of_both_sexes_error_messages_weight.Rdata"))
```


```{r, extract our optimum fits for both_sexes from the lists}
both_sexes_sitar_model <-
  list_of_both_sexes_sitar_models_weight[[name_of_optimum_weight_model_restrictions_both_sexes]]
both_sexes_overall_fixed_effects_weight <-
  list_of_both_sexes_overall_fixed_effects_weight[[name_of_optimum_weight_model_restrictions_both_sexes]]
both_sexes_random_effects_weight_metrics <-
  list_of_both_sexes_random_effects_weight[[name_of_optimum_weight_model_restrictions_both_sexes]]
both_sexes_patient_data_with_sitar_predictions_weight <-
  list_of_both_sexes_patient_data_with_sitar_predictions_weight[[name_of_optimum_weight_model_restrictions_both_sexes]]
both_sexes_individual_patient_random_effects_for_curves_weight <-
  list_of_both_sexes_individual_patient_random_effects_for_curves_weight[[name_of_optimum_weight_model_restrictions_both_sexes]]
both_sexes_fitting_results_weight <-
  list_of_both_sexes_fitting_results_weight[[name_of_optimum_weight_model_restrictions_both_sexes]]
both_sexes_error_messages_weight <-
  list_of_both_sexes_error_messages_weight[[name_of_optimum_weight_model_restrictions_both_sexes]]

```

```{r}
#first we start by only extracting the id a b and c from the random effects frame. This way if we run this file multiple times, we don't get stacking of extra columns adding each thing again and again
both_sexes_random_effects_weight_metrics <-
  both_sexes_random_effects_weight_metrics[,1:4]

if (is.null(both_sexes_random_effects_weight_metrics$a_)){
#rename the random effects to weight
both_sexes_random_effects_weight_metrics <-
dplyr::rename(
  both_sexes_random_effects_weight_metrics, 
    c("a_weight"="a", 
      "b_weight"="b",
      "c_weight"="c"))
}
```


```{r, use our random effects curve frames to calculate salient metrics of growth for interpretation on the absolute scale for both_sexes}

#join in the sex to the random effects frame
both_sexes_individual_patient_random_effects_for_curves_weight$id <-
  as.character(both_sexes_individual_patient_random_effects_for_curves_weight$id)
both_sexes_individual_patient_random_effects_for_curves_weight <-
  left_join(
    both_sexes_individual_patient_random_effects_for_curves_weight,
    ar_data_id_sex,
    by="id"
  )

#add the weight velocity
both_sexes_individual_patient_random_effects_for_curves_weight <- 
  both_sexes_individual_patient_random_effects_for_curves_weight %>%
        mutate(
          years_to_next_reading = 
            lead(age) - age,
          weight_to_next_reading = 
            lead(random_sitar_prediction) - random_sitar_prediction,
          weight_velocity_to_next_reading = 
            weight_to_next_reading / years_to_next_reading,
          lead_id =
            lead(id))

#correct to NA if the lead_id is different for years_to_next_reading
both_sexes_individual_patient_random_effects_for_curves_weight$years_to_next_reading <-
  ifelse(both_sexes_individual_patient_random_effects_for_curves_weight$lead_id!=
           both_sexes_individual_patient_random_effects_for_curves_weight$id,
         NA,
         both_sexes_individual_patient_random_effects_for_curves_weight$years_to_next_reading)
#correct to NA if the lead_id is different for weight_to_next_reading
both_sexes_individual_patient_random_effects_for_curves_weight$weight_to_next_reading <-
  ifelse(both_sexes_individual_patient_random_effects_for_curves_weight$lead_id!=
           both_sexes_individual_patient_random_effects_for_curves_weight$id,
         NA,
         both_sexes_individual_patient_random_effects_for_curves_weight$weight_to_next_reading)
#correct to NA if the lead_id is different for weight_velocity_to_next_reading
both_sexes_individual_patient_random_effects_for_curves_weight$weight_velocity_to_next_reading <-
  ifelse(both_sexes_individual_patient_random_effects_for_curves_weight$lead_id!=
           both_sexes_individual_patient_random_effects_for_curves_weight$id,
         NA,
         both_sexes_individual_patient_random_effects_for_curves_weight$weight_velocity_to_next_reading)
      
#calculate the salient metrics for this patient
#take out just data after 6 years of age
both_sexes_individual_patient_random_effects_over_six_years <-
  subset(
    both_sexes_individual_patient_random_effects_for_curves_weight,
    age >= 6)
      
#take out the whole row for each patient with maximum weight velocity after 6
both_sexes_individual_patient_random_effects_fastest_over_six_years <-
  both_sexes_individual_patient_random_effects_over_six_years %>%
  group_by(id) %>%
  slice_max(n=1, with_ties = F, weight_velocity_to_next_reading)
#then rename the random_sitar_prediction as max_weight_velocity_at_pubertal_spurt_after_six
names(both_sexes_individual_patient_random_effects_fastest_over_six_years)[
  names(both_sexes_individual_patient_random_effects_fastest_over_six_years)=="weight_velocity_to_next_reading"] <- 
  "max_weight_velocity_at_pubertal_spurt_after_six"
#and rename the age as age_at_max_weight_velocity_at_pubertal_spurt_after_six
names(both_sexes_individual_patient_random_effects_fastest_over_six_years)[
  names(both_sexes_individual_patient_random_effects_fastest_over_six_years)=="age"] <- 
  "age_at_max_weight_velocity_at_pubertal_spurt_after_six"
#then just extract those two columns that we want
both_sexes_individual_patient_random_effects_fastest_over_six_years <-
  both_sexes_individual_patient_random_effects_fastest_over_six_years[,c(
    "id",
    "max_weight_velocity_at_pubertal_spurt_after_six",
    "age_at_max_weight_velocity_at_pubertal_spurt_after_six"
  )]

#loop around a load of individual ages we want to extract 
for (age_to_extract in c(seq(0.5,20, by=0.5))){

    #extract the weight at that age
both_sexes_individual_patient_random_effects_at_specific_age <-
  subset(both_sexes_individual_patient_random_effects_for_curves_weight,
         dplyr::near(age, age_to_extract, tol = 1e-6))[,c(
           "id",
           "age",
           "sex_1_for_M_2_for_F",
           "random_sitar_prediction"
         )]

#insert a rescue clause here for random effects that are out of range before we calculate the z score turning any ridiculous weight into NA
both_sexes_individual_patient_random_effects_at_specific_age$random_sitar_prediction <-
  ifelse(both_sexes_individual_patient_random_effects_at_specific_age$random_sitar_prediction < 1 |
           both_sexes_individual_patient_random_effects_at_specific_age$random_sitar_prediction > 300,
         NA,
         both_sexes_individual_patient_random_effects_at_specific_age$random_sitar_prediction)

#give us an indicator variable also telling us these weights are spurious
both_sexes_individual_patient_random_effects_at_specific_age$spurious_sitar_weight <-
  ifelse(
    is.na(both_sexes_individual_patient_random_effects_at_specific_age$random_sitar_prediction)  ,
    1,
    0
  )
#calculate the who z score at this weight
#if the age is 5 or older we use this:
if (age_to_extract>=5){
both_sexes_individual_patient_random_effects_at_specific_age$who_z_sitar_weight_for_age_at_specific_age <-
  anthroplus::anthroplus_zscores(
   sex =                both_sexes_individual_patient_random_effects_at_specific_age$sex_1_for_M_2_for_F,
   age_in_months =      both_sexes_individual_patient_random_effects_at_specific_age$age * 12,
#   height_in_cm =             ar_data$interpolated_weight,
   weight_in_kg =             both_sexes_individual_patient_random_effects_at_specific_age$random_sitar_prediction
)$zwfa
}
#if it is less than five the we use the other anthro package
if (age_to_extract<5){
both_sexes_individual_patient_random_effects_at_specific_age$who_z_sitar_weight_for_age_at_specific_age <-
  anthro::anthro_zscores(
   sex =                both_sexes_individual_patient_random_effects_at_specific_age$sex_1_for_M_2_for_F,
   age =      both_sexes_individual_patient_random_effects_at_specific_age$age * 12,
#   lenhei =             ar_data$interpolated_weight,
   weight =             as.numeric(both_sexes_individual_patient_random_effects_at_specific_age$random_sitar_prediction), 
          is_age_in_month = T 
)$zwei
}

#now we have used the sex column we can get rid of it to stop it duplicating 
both_sexes_individual_patient_random_effects_at_specific_age$sex_1_for_M_2_for_F <- NULL

#rename that column to tell us the age at which the weight was spurious
names(both_sexes_individual_patient_random_effects_at_specific_age)[
  names(both_sexes_individual_patient_random_effects_at_specific_age)=="spurious_sitar_weight"] <- 
  paste0("sitar_weight_spurious_at_age_", age_to_extract)
#rename that column to tell us the age at who_z_sitar_weight_for_age_at_specific_age
names(both_sexes_individual_patient_random_effects_at_specific_age)[
  names(both_sexes_individual_patient_random_effects_at_specific_age)=="who_z_sitar_weight_for_age_at_specific_age"] <- 
  paste0("who_z_sitar_weight_for_age_at_age_", age_to_extract)

#then rename the random_sitar_prediction as sitar_weight_at_age whatever it is
names(both_sexes_individual_patient_random_effects_at_specific_age)[
  names(both_sexes_individual_patient_random_effects_at_specific_age)=="random_sitar_prediction"] <- 
  paste0("sitar_weight_at_age_", age_to_extract)

#then rename the age to give us the precise age at whatever it is
names(both_sexes_individual_patient_random_effects_at_specific_age)[
  names(both_sexes_individual_patient_random_effects_at_specific_age)=="age"] <- 
  paste0("precise_age_at_sitar_weight_at_age_", age_to_extract)


#join the extracted age in
both_sexes_individual_patient_random_effects_at_specific_age$id <-
  as.character(both_sexes_individual_patient_random_effects_at_specific_age$id)
both_sexes_random_effects_weight_metrics <-
  left_join(
    both_sexes_random_effects_weight_metrics, 
    both_sexes_individual_patient_random_effects_at_specific_age,
    by = join_by(id))
}

```

```{r, join our other calculated metrics into the overall random effects frame to have them available next to a b and c for both_sexes}
both_sexes_individual_patient_random_effects_fastest_over_six_years$id <-
  as.character(both_sexes_individual_patient_random_effects_fastest_over_six_years$id)
both_sexes_random_effects_weight_metrics <-
  left_join(
    both_sexes_random_effects_weight_metrics, 
    both_sexes_individual_patient_random_effects_fastest_over_six_years,
    by = join_by(id))
```



```{r, replace the version of our random effects data within our list for both_sexes}
#first remove the sex column so that when we join it back into the main frame in future we don't get a duplication of the sex column 
both_sexes_random_effects_weight_metrics$sex_1_for_M_2_for_F <- NULL

list_of_both_sexes_random_effects_weight[[name_of_optimum_weight_model_restrictions_both_sexes]] <-
  as.data.frame(both_sexes_random_effects_weight_metrics)
```

```{r, save our list of random effects again for both_sexes}
#we can save this list here again, because when we load it above if we rerun the file, we remove the calculated columns
save(list_of_both_sexes_random_effects_weight,   
     file = paste0("ar_data_files_to_load/list_of_both_sexes_random_effects_weight.Rdata"))
```














************************************
plot sitar fixed and random effects over raw data for weight
************************************

```{r, plot individual patient sitar fits over patient raw data}
for (each_group in c(
  "male",
  "fema",
  "both_sexes"
)){
  


#default to both_sexes
all_patient_data <-
  both_sexes_sitar_model$data
random_effects_curve_data <-
  both_sexes_individual_patient_random_effects_for_curves_weight
fixed_effects_curve_data <-
  both_sexes_overall_fixed_effects_weight
fixed_effects_colour<-"darkgreen"
name_of_model <-
  name_of_optimum_weight_model_restrictions_both_sexes

if (each_group=="male"){
  fixed_effects_colour <- "blue"
all_patient_data <-
  male_sitar_model$data
random_effects_curve_data <-
  male_individual_patient_random_effects_for_curves_weight
fixed_effects_curve_data <-
  male_overall_fixed_effects_weight
name_of_model <-
  name_of_optimum_weight_model_restrictions_male
}
if (each_group=="fema"){
  fixed_effects_colour<-"red"
all_patient_data <-
  fema_sitar_model$data
random_effects_curve_data <-
  fema_individual_patient_random_effects_for_curves_weight
fixed_effects_curve_data <-
  fema_overall_fixed_effects_weight
name_of_model <-
  name_of_optimum_weight_model_restrictions_fema
}


#then plot it
all_patient_plot <- 
  ggplot(data=fixed_effects_curve_data, 
         aes(x=age, 
             y=weight)) + 
  geom_point(data=all_patient_data,
    aes(x=age_to_use,
        y=interpolated_weight), 
    size=2,
    alpha=0.2, 
    colour="black") +
  geom_line(data=random_effects_curve_data,
    aes(
      x=age,
      y=random_sitar_prediction,
      group=id), 
    alpha=0.1, 
    linewidth=0.5,
    colour="black") +
  geom_line(
    aes(), 
    linewidth=1.5,
    linetype="longdash",
    alpha=0.8, 
    colour=fixed_effects_colour) +
  coord_cartesian(ylim=c(0,150)) +
  labs(title=name_of_model,
       subtitle="Dashed line = Fixed Effects, Solid line = Patient Random Effects",
       y= "Weight (kg)",
       x= "Age (years)") +
  themepowerpointtitle
all_patient_plot
dir.create(
  paste0("all_patient_sitar_plots")
  )
dir.create(
  paste0("all_patient_sitar_plots/", 
         name_of_model)
  )
cat(paste0("printing ", each_group, "\n"))
ggsave(filename=paste0(each_group, "_all.png"), 
       path=
         paste0(
         "all_patient_sitar_plots/", 
         name_of_model),
       plot = all_patient_plot, 
       device="png",  
       width=10, height=5, 
       limitsize=F)
}

```






***********************************
Plot individual ggplots of sitar optimum model fit for each of male fema and both_sexes along with original patient data
***********************************

this will loop around and plot patients individually, so this will take a while


ungrey this as it takes a long time to run
``{r, plot individual patient sitar fits over patient raw data}
for (each_group in c(
  "male",
  "fema",
  "both_sexes"
)){
  


#default to both_sexes
all_patient_data <-
  both_sexes_sitar_model$data
random_effects_curve_data <-
  both_sexes_individual_patient_random_effects_for_curves_weight
fixed_effects_curve_data <-
  both_sexes_overall_fixed_effects_weight
fixed_effects_colour<-"darkgreen"
name_of_model <-
  name_of_optimum_weight_model_restrictions_both_sexes

if (each_group=="male"){
  fixed_effects_colour <- "blue"
all_patient_data <-
  male_sitar_model$data
random_effects_curve_data <-
  male_individual_patient_random_effects_for_curves_weight
fixed_effects_curve_data <-
  male_overall_fixed_effects_weight
name_of_model <-
  name_of_optimum_weight_model_restrictions_male
}
if (each_group=="fema"){
  fixed_effects_colour<-"red"
all_patient_data <-
  fema_sitar_model$data
random_effects_curve_data <-
  fema_individual_patient_random_effects_for_curves_weight
fixed_effects_curve_data <-
  fema_overall_fixed_effects_weight
name_of_model <-
  name_of_optimum_weight_model_restrictions_fema
}

#then we loop around the patient ids
for (each_patient in c(
  unique(all_patient_data$id)
)){
  
#each_patient <- 557 #practice patient
  #take out the patient data
  individual_patient_data <-
    subset(all_patient_data, id==each_patient)
  individual_random_effects_curve <-
    subset(random_effects_curve_data, id==each_patient)
  
#then plot it
individual_patient_plot <- 
  ggplot(data=fixed_effects_curve_data, 
         aes(x=age, 
             y=weight)) + 
  geom_line(
    aes(), 
    linewidth=1.5,
    linetype="longdash",
    alpha=0.5, 
    colour=fixed_effects_colour) +
  geom_point(data=individual_patient_data,
    aes(x=age_to_use,
        y=interpolated_weight), 
    size=2,
    alpha=0.5, 
    colour="black") +
  geom_line(data=individual_random_effects_curve,
    aes(
      x=age,
      y=random_sitar_prediction), 
    alpha=0.5, 
    linewidth=1.5,
    colour="black") +
  coord_cartesian(ylim=c(0,150)) +
  labs(title=name_of_model,
       subtitle="Dashed line = Fixed Effects, Solid line = Patient Random Effects",
       y= "Weight (kg)",
       x= "Age (years)") +
  themewithlegend

dir.create(
  paste0("individual_patient_sitar_plots")
  )
dir.create(
  paste0("individual_patient_sitar_plots/", 
         name_of_model)
  )
cat(paste0("printing ", each_group, " specifically the patient ", each_patient, "\n"))
print(paste0(Sys.time(), "\n"))
ggsave(filename=paste0("id_", each_patient, ".png"), 
       path=
         paste0(
         "individual_patient_sitar_plots/", 
         name_of_model),
       plot = individual_patient_plot, 
       device="png",  
       width=10, height=5, 
       limitsize=F)
}
}
``


```{r, calculate R2 for sitar models}
sink("summary_of_r2_from_sitar_weight_models.txt", split=T)
print("R² for male weight SITAR model:")
residual_variance_male <- male_sitar_model$sigma^2
random_variance_male <- sum(as.numeric(VarCorr(male_sitar_model)[, "Variance"]))
fitted_values_male <- fitted(male_sitar_model, level = 0)  # Fitted values without random effects
fixed_variance_male <- var(fitted_values_male)
cat("Marginal:")
(r2_marginal_male_weight <- 
  fixed_variance_male / 
  (fixed_variance_male + random_variance_male + residual_variance_male))
cat("Conditional:")
(r2_conditional_male_weight <- 
  (fixed_variance_male + random_variance_male) / 
  (fixed_variance_male + random_variance_male + residual_variance_male))

print("R² for fema weight SITAR model:")
residual_variance_fema <- fema_sitar_model$sigma^2
random_variance_fema <- sum(as.numeric(VarCorr(fema_sitar_model)[, "Variance"]))
fitted_values_fema <- fitted(fema_sitar_model, level = 0)  # Fitted values without random effects
fixed_variance_fema <- var(fitted_values_fema)
cat("Marginal:")
(r2_marginal_fema_weight <- 
  fixed_variance_fema / 
  (fixed_variance_fema + random_variance_fema + residual_variance_fema))
cat("Conditional:")
(r2_conditional_fema_weight <- 
  (fixed_variance_fema + random_variance_fema) / 
  (fixed_variance_fema + random_variance_fema + residual_variance_fema))

print("R² for both_sexes weight SITAR model:")
residual_variance_both_sexes <- both_sexes_sitar_model$sigma^2
random_variance_both_sexes <- sum(as.numeric(VarCorr(both_sexes_sitar_model)[, "Variance"]))
fitted_values_both_sexes <- fitted(both_sexes_sitar_model, level = 0)  # Fitted values without random effects
fixed_variance_both_sexes <- var(fitted_values_both_sexes)
cat("Marginal:")
(r2_marginal_both_sexes_weight <- 
  fixed_variance_both_sexes / 
  (fixed_variance_both_sexes + random_variance_both_sexes + residual_variance_both_sexes))
cat("Conditional:")
(r2_conditional_both_sexes_weight <- 
  (fixed_variance_both_sexes + random_variance_both_sexes) / 
  (fixed_variance_both_sexes + random_variance_both_sexes + residual_variance_both_sexes))
sink()
```

```{r, summary stats of data points and patients for weight model}
sink("summary_of_data_into_sitar_weight_models.txt", split=T)
print("Number of data points used in male SITAR weight model")
nrow(male_sitar_model$data)
print("Number of patients used in male SITAR weight model")
length(unique(male_sitar_model$data$id))

print("Number of data points used in fema SITAR weight model")
nrow(fema_sitar_model$data)
print("Number of patients used in fema SITAR weight model")
length(unique(fema_sitar_model$data$id))

print("Number of data points used in both_sexes SITAR weight model")
nrow(both_sexes_sitar_model$data)
print("Number of patients used in both_sexes SITAR weight model")
length(unique(both_sexes_sitar_model$data$id))
sink()
```


```{r, function to calculate weight rmse}
calculate_weight_rmse <- 
  function(model, data) {
    predictions <- predict(model, newdata = data, type = "response")
    actuals <- data$interpolated_weight
    sqrt(mean((predictions - actuals)^2))
  }
```


```{r, calculate weight rmse}
male_weight_rmse <-
calculate_weight_rmse(
  model=male_sitar_model, 
  data=male_sitar_model$data)
fema_weight_rmse <-
calculate_weight_rmse(
  model=fema_sitar_model, 
  data=fema_sitar_model$data)
cat(paste0("Male weight RMSE is ", male_weight_rmse, "\n"))
cat(paste0("Fema weight RMSE is ", fema_weight_rmse))
```

```{r, summary statistics for weight in kg at 18}
print("SORRY: You can't report weight z score over 10")
descr(male_random_effects_weight_metrics$sitar_weight_at_age_18)

cat("Simple description of SITAR predicted weight at 18 in male patients\n")
cat(
  paste0(
    round(
      mean(
        male_random_effects_weight_metrics$sitar_weight_at_age_18, na.rm=T), digits=2),
    ("\n("),
    round(
      as.numeric(
        sd(
          male_random_effects_weight_metrics$sitar_weight_at_age_18, na.rm=T)), digits=2),
    (")")
  ))

cat("Simple description of SITAR predicted weight at 18 in fema patients\n")
cat(
  paste0(
    round(
      mean(
        fema_random_effects_weight_metrics$sitar_weight_at_age_18, na.rm=T), digits=2),
    ("\n("),
    round(
      as.numeric(
        sd(
          fema_random_effects_weight_metrics$sitar_weight_at_age_18, na.rm=T)), digits=2),
    (")")
  ))
```


```{r, summary statistics for weight z-score at 18}
descr(male_random_effects_weight_metrics$who_z_sitar_weight_for_age_at_age_18)

cat("Simple description of SITAR predicted weight z-score at 18 in male patients\n")
cat(
  paste0(
    round(
      mean(
        male_random_effects_weight_metrics$who_z_sitar_weight_for_age_at_age_18, na.rm=T), digits=2),
    ("\n("),
    round(
      as.numeric(
        sd(
          male_random_effects_weight_metrics$who_z_sitar_weight_for_age_at_age_18, na.rm=T)), digits=2),
    (")")
  ))

cat("Simple description of SITAR predicted weight z-score at 18 in fema patients\n")
cat(
  paste0(
    round(
      mean(
        fema_random_effects_weight_metrics$who_z_sitar_weight_for_age_at_age_18, na.rm=T), digits=2),
    ("\n("),
    round(
      as.numeric(
        sd(
          fema_random_effects_weight_metrics$who_z_sitar_weight_for_age_at_age_18, na.rm=T)), digits=2),
    (")")
  ))
```


```{r, end of file so save all the listed dataframes into the parent directory}
rm(ar_data)
save_ar_files_function(
  parent_directory=location_of_data_files,
  parent_file="file_24")
Sys.time()
```