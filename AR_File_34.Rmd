
```{r, load software packages}
rm(list = ls())

#take the working directory otherwise, which should work every time?
if(!exists("location_of_main_folder")){
  location_of_main_folder <- 
    getwd()
}
#paste the name of our functions folder into the path name
location_of_functions_folder <-
  paste0(location_of_main_folder, "/ar_functions_folder/")

#load the function that loads all the libraries and sources
source(paste0(location_of_functions_folder, "load_ar_libraries_and_sources_function.R"))

#paste together the location of the data files - we don't load in the first file, but we need this location for the end
location_of_data_files <-
  paste0(location_of_main_folder, "/ar_data_files_to_load/")

#run the function, pointing it towards the functions folder
load_ar_libraries_and_sources_function(
  location_of_functions_folder=location_of_functions_folder,
  location_of_data_files=location_of_data_files
)

load_ar_files_function(previous_file_name = "file_30",
  parent_directory = location_of_data_files,
  list_of_data_frames_to_load=list("ar_data"))
```

```{r, make sure our sex number category is a character so that it doesnt get modelled on the continuous scale}
ar_data$sex_1_for_M_2_for_F <- 
  as.character(ar_data$sex_1_for_M_2_for_F)
```


```{r, tell me the whole data set}
print("Total number of visits in final dataset:")
nrow(ar_data)
print("Number of patients:")
print(length(unique(ar_data$id)))

print("Number of centres:")
print(length(unique(ar_data$Centre.Name...Centre)))

print("Total male visits in final dataset:")
nrow(subset(ar_data, sex_1_for_M_2_for_F==1))
print("Number of male patients:")
print(length(unique(subset(ar_data, sex_1_for_M_2_for_F==1)$id)))

print("Total fema visits in final dataset:")
nrow(subset(ar_data, sex_1_for_M_2_for_F==2))
print("Number of fema patients:")
print(length(unique(subset(ar_data, sex_1_for_M_2_for_F==2)$id)))
```

```{r, restrict the data that we want to run}
data_frame_with_both_sexes_refined_to_covariates_we_are_assessing <-
  subset(ar_data,
           !is.na(age_to_use) & 
           !is.na(interpolated_height) &
           !is.na(interpolated_weight) &
           !is.na(total_daily_hydrocortisone_equivalent_at_visit_carried_to_use) &
           !is.na(total_daily_fludro_dose_with_zero_carried_to_use) &
           !is.na(ln_converted_17OHP_nmol_l_imputed_units_0) 
           )

print("Total number of visits we are assessing:")
nrow(data_frame_with_both_sexes_refined_to_covariates_we_are_assessing)
print("Total male visits we are assessing:")
nrow(subset(data_frame_with_both_sexes_refined_to_covariates_we_are_assessing, sex_1_for_M_2_for_F==1))
print("Total fema visits we are assessing:")
nrow(subset(data_frame_with_both_sexes_refined_to_covariates_we_are_assessing, sex_1_for_M_2_for_F==2))

print("set our dependent variable in this chunk as well to ensure correct points get plotted in background")

```


```{r, tell us how much data we have in the subset}
print("Total number of visits we are assessing:")
nrow(data_frame_with_both_sexes_refined_to_covariates_we_are_assessing)
print("Total number of  patients we are assessing:")
length(unique(data_frame_with_both_sexes_refined_to_covariates_we_are_assessing)$id)



print("Number of centres:")
print(length(unique(data_frame_with_both_sexes_refined_to_covariates_we_are_assessing$Centre.Name...Centre)))

print("Total male visits we are assessing:")
nrow(subset(data_frame_with_both_sexes_refined_to_covariates_we_are_assessing, sex_1_for_M_2_for_F==1))
print("Total male patients we are assessing:")
length(unique(subset(data_frame_with_both_sexes_refined_to_covariates_we_are_assessing, sex_1_for_M_2_for_F==1))$id)


print("Total fema visits we are assessing:")
nrow(subset(data_frame_with_both_sexes_refined_to_covariates_we_are_assessing, sex_1_for_M_2_for_F==2))
print("Total fema patients we are assessing:")
length(unique(subset(data_frame_with_both_sexes_refined_to_covariates_we_are_assessing, sex_1_for_M_2_for_F==2))$id)

print("set our dependent variable in this chunk as well to ensure correct points get plotted in background")

```


```{r, function to bootstrap ids from the data that are dependent upon the data that we are assessing}
bootstrap_patient_ids <- function (
    number_of_bootstraps, 
    data_frame_with_both_sexes_refined_to_covariates_we_are_assessing
    ){
  
all_ids_in_data <- 
  unique(data_frame_with_both_sexes_refined_to_covariates_we_are_assessing$id)

male_ids_in_data <- 
  unique(subset(data_frame_with_both_sexes_refined_to_covariates_we_are_assessing, sex_1_for_M_2_for_F==1)$id)

fema_ids_in_data <- 
  unique(subset(data_frame_with_both_sexes_refined_to_covariates_we_are_assessing, sex_1_for_M_2_for_F==2)$id)

print("Number of male patients in data:")
length(male_ids_in_data)
print("Number of fema patients in data:")
length(fema_ids_in_data)
print("This number should be zero:")
length(all_ids_in_data) - length(male_ids_in_data) - length(fema_ids_in_data)


male_id_bootstrap_list <-
  vector("list", number_of_bootstraps)

fema_id_bootstrap_list <-
  vector("list", number_of_bootstraps)

set.seed(1983)

for (i in 1:number_of_bootstraps) {

  male_id_bootstrap_list[[i]] <- 
    as.character(sample(male_ids_in_data, 
           length(male_ids_in_data), 
           replace = TRUE))

  fema_id_bootstrap_list[[i]] <- 
    as.character(sample(fema_ids_in_data, 
           length(fema_ids_in_data), 
           replace = TRUE))
}

return(list(male_id_bootstrap_list=male_id_bootstrap_list, fema_id_bootstrap_list=fema_id_bootstrap_list))

print("Created list of fema and male ids all the same length as the ids in data, but bootstrapped so that bootstrapped versions of the data can be created with these patient ids")

}
```

```{r, function to create complete data to model spline interactions}
create_data_to_model_spline_interactions <- 
  function(
    data_frame_with_both_sexes = data_frame_with_both_sexes_refined_to_covariates_we_are_assessing,
    spline_df,
    list_of_variables,
    lower_age,
    upper_age
) {

    name_of_model <- paste0("s_df", spline_df, "_")
    
    directory_name_to_save_plots <- paste0("s_df", spline_df, "_")
    
    covariates_to_interact_with_spline <- list()
    
    if (!is.null(list_of_variables$hydrocortisone_variable)){
      
      covariates_to_interact_with_spline[length(covariates_to_interact_with_spline)+1] <- list_of_variables$hydrocortisone_variable
      
      cat("\n")
      cat("\nHydrocortisone is a covariate")
      cat("\n")
      
      name_of_model <- directory_name_to_save_plots <- paste0(name_of_model, "hydro_")
      
    }
    
    if (!is.null(list_of_variables$fludrocortisone_variable)){
      
      covariates_to_interact_with_spline[length(covariates_to_interact_with_spline)+1] <- list_of_variables$fludrocortisone_variable
      
      cat("\n")
      cat("\nFludrocortisone is a covariate")
      cat("\n")
      
     name_of_model <-  directory_name_to_save_plots <- paste0(name_of_model, "fludro_")
    }
    
    if (!is.null(list_of_variables$ohp_variable)){
      
      covariates_to_interact_with_spline[length(covariates_to_interact_with_spline)+1] <- list_of_variables$ohp_variable
      
      cat("\n")
      cat("\n17 OHP is a covariate")
      cat("\n") 
      
      name_of_model <-  directory_name_to_save_plots <- paste0(name_of_model, "ohp_")
    }
    
    if (!is.null(list_of_variables$androstenedione_variable)){
      
      covariates_to_interact_with_spline[length(covariates_to_interact_with_spline)+1] <- list_of_variables$androstenedione_variable
      
      cat("\n")
      cat("\nAndrostenedione is a covariate")
      cat("\n")
      
      name_of_model <-  directory_name_to_save_plots <- paste0(name_of_model, "andro_")
    }
    

    
dir.create(showWarnings = F,directory_name_to_save_plots)


data_frame_with_both_sexes$absolute_age <-
  data_frame_with_both_sexes[[list_of_variables$age_variable]]

data_frame_with_both_sexes$ln_post_conceptual_age <-
  log(data_frame_with_both_sexes[[list_of_variables$age_variable]] + 0.75)

cat("\n ################################################################ \n ################################################################ \n ")

cat(paste0("\n model name is: ", directory_name_to_save_plots, "; \n\n Degrees of freedom is: ", spline_df, "; \n\n Running ages from ", lower_age, " to ", upper_age))
  
sub_directory_to_save_plots <- 
  paste0(directory_name_to_save_plots, "/df_", spline_df, "_ages_", lower_age, "_", upper_age)

dir.create(showWarnings = F, sub_directory_to_save_plots)

data_to_model_both_sexes <-
  subset(
    data_frame_with_both_sexes, 
    data_frame_with_both_sexes[[list_of_variables$age_variable]] > 
      lower_age & 
      data_frame_with_both_sexes[[list_of_variables$age_variable]] < 
      upper_age
  )

data_to_model_both_sexes <-
  data_to_model_both_sexes[,c(
    "id",
    "Centre.Name...Centre",
    "absolute_age",
    "ln_post_conceptual_age",
    list_of_variables$age_variable,
    list_of_variables$sex_variable,
    list_of_variables$hydrocortisone_variable,
    list_of_variables$fludrocortisone_variable,
    list_of_variables$ohp_variable,
    list_of_variables$androstenedione_variable,
    list_of_variables$dependent_height,
    list_of_variables$dependent_weight,
    list_of_variables$dependent_bmi,
  )]

data_to_model_both_sexes_complete <- 
  subset(data_to_model_both_sexes,
         !is.na(data_to_model_both_sexes[[list_of_variables$age_variable]]) & 
         !is.na(data_to_model_both_sexes[[list_of_variables$sex_variable]]) & 
         !is.na(data_to_model_both_sexes[[list_of_variables$dependent_height]]) & 
         !is.na(data_to_model_both_sexes[[list_of_variables$dependent_weight]]) 
         )

if (!is.null(list_of_variables$fludrocortisone_variable)){
data_to_model_both_sexes_complete <- 
  subset(data_to_model_both_sexes_complete,
          !is.na(data_to_model_both_sexes_complete[[list_of_variables$fludrocortisone_variable]])) 
}

if (!is.null(list_of_variables$hydrocortisone_variable)){
data_to_model_both_sexes_complete <- 
  subset(data_to_model_both_sexes_complete,
          !is.na(data_to_model_both_sexes_complete[[list_of_variables$hydrocortisone_variable]])) 
}

if (!is.null(list_of_variables$androstenedione_variable)){
data_to_model_both_sexes_complete <- 
  subset(data_to_model_both_sexes_complete,
          !is.na(data_to_model_both_sexes_complete[[list_of_variables$androstenedione_variable]])) 
}

if (!is.null(list_of_variables$ohp_variable)){
data_to_model_both_sexes_complete <- 
  subset(data_to_model_both_sexes_complete,
          !is.na(data_to_model_both_sexes_complete[[list_of_variables$ohp_variable]])) 
}


return(
  list(data_to_model_both_sexes_complete = data_to_model_both_sexes_complete,
       covariates_to_interact_with_spline = covariates_to_interact_with_spline,
       sub_directory_to_save_plots = sub_directory_to_save_plots)
  )
}
```

```{r, function to add spline basis functions on absolute age and ln age within sexes individually}

add_spline_basis_functions_to_data <- 
  function(
    data_to_model_both_sexes_complete,
    
    spline_df,
    
    list_of_variables
) {
    
data_to_model_male_complete <-
  subset(
    data_to_model_both_sexes_complete,
    data_to_model_both_sexes_complete[[list_of_variables$sex_variable]]==1
  )

data_to_model_fema_complete <-
  subset(
    data_to_model_both_sexes_complete,
    data_to_model_both_sexes_complete[[list_of_variables$sex_variable]]==2
  )

if (spline_df == 0) {
  absolute_spline_basis_male <- 
    data.frame(spline_0=model.matrix(~ absolute_age, data = data_to_model_male_complete)[, -1])
} else {
absolute_spline_basis_male <- 
  ns(data_to_model_male_complete$absolute_age, df = spline_df)

absolute_spline_knots_male <- 
  attr(ns(data_to_model_male_complete$absolute_age, df = spline_df), "knots")

absolute_boundary_knots_male <- 
  attr(ns(data_to_model_male_complete$absolute_age, df = spline_df), "Boundary.knots")

colnames(absolute_spline_basis_male) <- 
  paste0("absolute_spline_", 1:spline_df)

}
data_to_model_male_complete <- 
  cbind(data_to_model_male_complete, absolute_spline_basis_male)

if (spline_df == 0) {
  absolute_spline_basis_fema <- 
    data.frame(spline_0=model.matrix(~ absolute_age, data = data_to_model_fema_complete)[, -1])
} else {
  absolute_spline_basis_fema <- 
  ns(data_to_model_fema_complete$absolute_age, df = spline_df)

absolute_spline_knots_fema <- 
  attr(ns(data_to_model_fema_complete$absolute_age, df = spline_df), "knots")

absolute_boundary_knots_fema <- 
  attr(ns(data_to_model_fema_complete$absolute_age, df = spline_df), "Boundary.knots")

colnames(absolute_spline_basis_fema) <- 
  paste0("absolute_spline_", 1:spline_df)
}

data_to_model_fema_complete <- 
  cbind(data_to_model_fema_complete, absolute_spline_basis_fema)



if (spline_df == 0) {
  lnpca_spline_basis_male <- 
    data.frame(spline_0=model.matrix(~ ln_post_conceptual_age, data = data_to_model_male_complete)[, -1])
} else {
lnpca_spline_basis_male <- 
  ns(data_to_model_male_complete$ln_post_conceptual_age, df = spline_df)

lnpca_spline_knots_male <- 
  attr(ns(data_to_model_male_complete$ln_post_conceptual_age, df = spline_df), "knots")

lnpca_boundary_knots_male <- 
  attr(ns(data_to_model_male_complete$ln_post_conceptual_age, df = spline_df), "Boundary.knots")

colnames(lnpca_spline_basis_male) <- 
  paste0("lnpca_spline_", 1:spline_df)
}

data_to_model_male_complete_with_knots <- 
  cbind(data_to_model_male_complete, lnpca_spline_basis_male)

if (spline_df == 0) {
  lnpca_spline_basis_fema <- 
    data.frame(spline_0=model.matrix(~ ln_post_conceptual_age, data = data_to_model_fema_complete)[, -1])
} else {
lnpca_spline_basis_fema <- 
  ns(data_to_model_fema_complete$ln_post_conceptual_age, df = spline_df)

lnpca_spline_knots_fema <- 
  attr(ns(data_to_model_fema_complete$ln_post_conceptual_age, df = spline_df), "knots")

lnpca_boundary_knots_fema <- 
  attr(ns(data_to_model_fema_complete$ln_post_conceptual_age, df = spline_df), "Boundary.knots")
colnames(lnpca_spline_basis_fema) <- 
  paste0("lnpca_spline_", 1:spline_df)
}

data_to_model_fema_complete_with_knots <- 
  cbind(data_to_model_fema_complete, lnpca_spline_basis_fema)

data_to_model_both_sexes_complete <-
  rbind(data_to_model_male_complete_with_knots, data_to_model_fema_complete_with_knots)

spline_basis_data <-
  list(
    absolute_spline_basis_male = absolute_spline_basis_male,
    absolute_spline_knots_male = absolute_spline_knots_male,
    absolute_boundary_knots_male = absolute_boundary_knots_male,
    absolute_spline_basis_fema = absolute_spline_basis_fema,
    absolute_spline_knots_fema = absolute_spline_knots_fema,
    absolute_boundary_knots_fema = absolute_boundary_knots_fema,
    lnpca_spline_basis_male = lnpca_spline_basis_male,
    lnpca_spline_knots_male = lnpca_spline_knots_male,
    lnpca_boundary_knots_male = lnpca_boundary_knots_male,
    lnpca_spline_basis_fema = lnpca_spline_basis_fema,
    lnpca_spline_knots_fema = lnpca_spline_knots_fema,
    lnpca_boundary_knots_fema = lnpca_boundary_knots_fema
  )

data_and_spline_details <-
  list(
    data_to_model_both_sexes_complete = data_to_model_both_sexes_complete,
    spline_basis_data = spline_basis_data
  )

return(data_and_spline_details)

  }
```

```{r, function to create spline interaction models on absolute age and ln age modelling sexes individually with bootstrapping}
bootstrap_and_create_spline_models <- 
  function(
    data_to_model_both_sexes_complete,
    male_id_bootstrap_list,
    fema_id_bootstrap_list,
    formula_string_random, 
    spline_df,
    list_of_variables,
    covariates_to_interact_with_spline,
    lower_age, 
    upper_age,
    sub_directory_to_save_plots
) {

data_to_model_male_complete <-
  subset(
    data_to_model_both_sexes_complete,
    data_to_model_both_sexes_complete[[list_of_variables$sex_variable]]==1
  )

data_to_model_fema_complete <-
  subset(
    data_to_model_both_sexes_complete,
    data_to_model_both_sexes_complete[[list_of_variables$sex_variable]]==2
  )

male_bootstrap_data_list <- vector("list", number_of_bootstraps)

fema_bootstrap_data_list <- vector("list", number_of_bootstraps)

for (this_bootstrap_number in 1:number_of_bootstraps) {
  message("Creating datasets for bootstrap replication number: ", this_bootstrap_number, 
          " out of ", number_of_bootstraps)
  
  male_id_list_this_bootstrap <- male_id_bootstrap_list[[this_bootstrap_number]]
  
  fema_id_list_this_bootstrap <- fema_id_bootstrap_list[[this_bootstrap_number]]

  male_data_this_bootstrap <- rbindlist(lapply(seq_along(male_id_list_this_bootstrap), function(i) {
    id_val <- male_id_list_this_bootstrap[i]
    dt <- data_to_model_male_complete[data_to_model_male_complete$id == id_val, ]
    dt$new_id <- i
    dt$original_id <- dt$id # Assign new ID to avoid duplication clash
    return(dt)
  }))
  
  fema_data_this_bootstrap <- rbindlist(lapply(seq_along(fema_id_list_this_bootstrap), function(i) {
    id_val <- fema_id_list_this_bootstrap[i]
    dt <- data_to_model_fema_complete[data_to_model_fema_complete$id == id_val, ]
    dt$new_id <- i
    dt$original_id <- dt$id  # Assign new ID to avoid duplication clash
    return(dt)
  }))
  
  #add the data to a list
  male_bootstrap_data_list[[this_bootstrap_number]] <- male_data_this_bootstrap
  
  fema_bootstrap_data_list[[this_bootstrap_number]] <- fema_data_this_bootstrap
  
}

generate_spline_null_independent_variables <- function(
  spline_df,
  spline_prefix = "absolute_spline_"
) {
  null_independent_variables <- c()
  for (df in seq_len(spline_df)) {
    null_independent_variables <- c(
      null_independent_variables,
      paste0(spline_prefix, df)
    )
  }
  combined_null_independent_variables <- 
    paste(null_independent_variables, 
          collapse = " + ")
  
  return(combined_null_independent_variables)
}
  
generate_spline_interaction_variables <- 
  function(
    spline_df,
    variables_to_interact_with_each_spline,
    spline_prefix = "absolute_spline_"
) {
  variables_interacted_with_each_spline <- c()

  for (var in variables_to_interact_with_each_spline) {
    if (!is.null(var)) {
      for (df in seq_len(spline_df)) {
        variables_interacted_with_each_spline <- c(
          variables_interacted_with_each_spline,
          paste0(var, " * ", spline_prefix, df)
        )
      }
    }
  }

  combined_variables_interacted_with_each_spline <- 
    paste(variables_interacted_with_each_spline, collapse = " + ")
  
  return(combined_variables_interacted_with_each_spline)
}

null_independent_variables <- 
  generate_spline_null_independent_variables(
  spline_df = spline_df,
)

only_covariates_interacted_with_each_spline <- 
  generate_spline_interaction_variables(
  spline_df = spline_df,
  variables_to_interact_with_each_spline = covariates_to_interact_with_spline
)

dependent_height_interacted_with_each_spline <- 
  generate_spline_interaction_variables(
  spline_df = spline_df,
  variables_to_interact_with_each_spline = list_of_variables$dependent_height
)

dependent_weight_interacted_with_each_spline <- 
  generate_spline_interaction_variables(
  spline_df = spline_df,
  variables_to_interact_with_each_spline = list_of_variables$dependent_weight
)




list_of_absolute_model_formulas <- list()

list_of_absolute_model_formulas[["dependent_height_null_absolute"]] <-
  paste0(list_of_variables$dependent_height, " ~ ", null_independent_variables)

list_of_absolute_model_formulas[["dependent_weight_null_absolute"]] <-
  paste0(list_of_variables$dependent_weight, " ~ ", null_independent_variables)

list_of_absolute_model_formulas[["dependent_bmi_null_absolute"]] <-
  paste0(list_of_variables$dependent_bmi, " ~ ", null_independent_variables)

list_of_absolute_model_formulas[["dependent_height_only_covariates_formula_absolute"]] <-
  paste0(list_of_variables$dependent_height, " ~ ", only_covariates_interacted_with_each_spline)

list_of_absolute_model_formulas[["dependent_weight_only_covariates_formula_absolute"]] <-
  paste0(list_of_variables$dependent_weight, " ~ ", only_covariates_interacted_with_each_spline)

list_of_absolute_model_formulas[["dependent_bmi_only_covariates_formula_absolute"]] <-
  paste0(list_of_variables$dependent_bmi, " ~ ", only_covariates_interacted_with_each_spline)


list_of_absolute_model_formulas[["dependent_height_on_weight_with_covariates_formula_absolute"]] <-
  paste0(list_of_variables$dependent_height, " ~ ", only_covariates_interacted_with_each_spline, 
         " + ", dependent_weight_interacted_with_each_spline)

list_of_absolute_model_formulas[["dependent_weight_on_height_with_covariates_formula_absolute"]] <-
  paste0(list_of_variables$dependent_weight, " ~ ", only_covariates_interacted_with_each_spline, 
         " + ", dependent_height_interacted_with_each_spline)





list_of_lnpca_model_formulas <- setNames(
  lapply(list_of_absolute_model_formulas, function(formula_string) {
    gsub("absolute", "lnpca", formula_string)
  }),
  nm = gsub("absolute", "lnpca", names(list_of_absolute_model_formulas))
)


print("Created all formulas") #debugging message

print(paste0("Data points in the both sexes models: ", 
             nrow(data_to_model_both_sexes_complete)))

print(paste0("Patients in the both sexes models: ",
             length(unique(data_to_model_both_sexes_complete$id))))

print(paste0("Data points for both sexes: ", nrow(data_to_model_both_sexes_complete)))

print(paste0("Patients for both sexes: ", length(unique(data_to_model_both_sexes_complete$id))))



fit_lme_model_and_store_metrics <- function(formula_name, data, this_bootstrap_number, formula_string_random) {
  
  if (grepl(x=formula_name, pattern="absolute")){
    formula_string <- list_of_absolute_model_formulas[[formula_name]]
  }
  if (grepl(x=formula_name, pattern="lnpca")){
    formula_string <- list_of_lnpca_model_formulas[[formula_name]]
  }
  
  sex_code <- mean(as.numeric(data[[list_of_variables$sex_variable]]), na.rm=T)
  
  model <- NA
  R2 <- NA
  BIC <- NA
  
  tryCatch({
    model <- lme(
      data = data,
      fixed = as.formula(formula_string),
      random = as.formula(formula_string_random)
    )
    model$call$fixed <- as.formula(formula_string)
    
    model$call$random <- as.formula(formula_string_random)
    
    R2 <- MuMIn::r.squaredGLMM(model)
    
    BIC <- BIC(model)
    
  }, error = function(e) {
    message("Model failed for formula: ", formula_name)
    model <- NA
    R2 <- NA
    BIC <- NA
  })
  
    return(
      list(
        formula_name = formula_name,
        list_of_variables = list_of_variables,
        lower_age = lower_age, 
        upper_age = upper_age,
        spline_df = spline_df,
        sex_code = sex_code, 
        bootstrap_number = this_bootstrap_number,
        formula_string = formula_string ,
        formula_string_random = formula_string_random,
        model = model , 
        BIC = BIC, 
        R2 = R2, 
        sub_directory_to_save_plots = sub_directory_to_save_plots))
}

fit_all_models <- function(male_bootstrap_data_list=male_bootstrap_data_list, fema_bootstrap_data_list=fema_bootstrap_data_list) {
  
  male_model_results_all_bootstraps <- list()
  fema_model_results_all_bootstraps <- list()
  
  for (this_bootstrap_number in (1:number_of_bootstraps)){
    
  message("Bootstrap replication number is: ", this_bootstrap_number, 
          " out of ", number_of_bootstraps)
  
  male_data_this_bootstrap <- male_bootstrap_data_list[[this_bootstrap_number]] 
  
  fema_data_this_bootstrap <- fema_bootstrap_data_list[[this_bootstrap_number]]
  
  male_model_results_this_bootstrap <- list()
  for (formula_name in c(names(list_of_absolute_model_formulas), names(list_of_lnpca_model_formulas))) {
  male_model_results_this_bootstrap[[formula_name]] <-
    fit_lme_model_and_store_metrics(
      formula_name = formula_name,
      data = male_data_this_bootstrap,
      this_bootstrap_number = this_bootstrap_number,
      formula_string_random = formula_string_random
    )
  }
  
  fema_model_results_this_bootstrap <- list()
  for (formula_name in c(names(list_of_absolute_model_formulas), names(list_of_lnpca_model_formulas))) {
  fema_model_results_this_bootstrap[[formula_name]] <-
    fit_lme_model_and_store_metrics(
      formula_name = formula_name,
      data = fema_data_this_bootstrap,
      this_bootstrap_number = this_bootstrap_number,
      formula_string_random = formula_string_random
    )
  }
  
  male_model_results_all_bootstraps[[length(male_model_results_all_bootstraps)+1]] <- male_model_results_this_bootstrap
  fema_model_results_all_bootstraps[[length(fema_model_results_all_bootstraps)+1]] <- fema_model_results_this_bootstrap
  }
  
  
  return(
    list(
      male_model_results_all_bootstraps = male_model_results_all_bootstraps,
      fema_model_results_all_bootstraps = fema_model_results_all_bootstraps,
      list_of_absolute_model_formulas = list_of_absolute_model_formulas,
      list_of_lnpca_model_formulas = list_of_lnpca_model_formulas
    )
  )
}



all_bootstrap_model_results <-
  fit_all_models(male_bootstrap_data_list=male_bootstrap_data_list, fema_bootstrap_data_list=fema_bootstrap_data_list)

print("Final save of all variables to the .Rdata files completed")

cat(paste0("Finished running all of the models and they are saved in ", sub_directory_to_save_plots, " at time ", Sys.time()))

return(all_bootstrap_model_results)

}
```

```{r, function to bootstrap all model fit statistics}
create_all_model_fit_statistics <- 
  function(all_bootstrap_model_results){

    all_model_fit_statistics <- list()

counter <- 1
    
list_of_models_male <- all_bootstrap_model_results$male_model_results_all_bootstraps
list_of_models_fema <- all_bootstrap_model_results$fema_model_results_all_bootstraps
    

for (each_bootstrap in 1:length(list_of_models_male)) {
  print(paste0("Collating bootstrap ", each_bootstrap))
  
  for (each_model_number in 1:length(list_of_models_male[[each_bootstrap]])) {
    
    this_model_male <- list_of_models_male[[each_bootstrap]][[each_model_number]]
    this_model_fema <- list_of_models_fema[[each_bootstrap]][[each_model_number]]
    
    model_name <- this_model_male$formula_name
    sub_directory_to_save_plots <- this_model_male$sub_directory_to_save_plots
    formula_string_random <- this_model_male$formula_string_random
    male_BIC <- this_model_male$BIC
    male_R2_marginal <- this_model_male$R2[1]
    male_R2_conditional <- this_model_male$R2[2]
    fema_BIC <- this_model_fema$BIC
    fema_R2_marginal <- this_model_fema$R2[1]
    fema_R2_conditional <- this_model_fema$R2[2]


        all_model_fit_statistics[[counter]] <- data.frame(
      model_name = model_name,
      sub_directory_to_save_plots = sub_directory_to_save_plots,
      formula_string_random = formula_string_random,
      male_BIC = male_BIC,
      male_R2_marginal = male_R2_marginal,
      male_R2_conditional = male_R2_conditional,
      fema_BIC = fema_BIC,
      fema_R2_marginal = fema_R2_marginal,
      fema_R2_conditional = fema_R2_conditional
    )
    counter <- counter + 1
  }
}


all_model_fit_statistics <- bind_rows(all_model_fit_statistics)

str(all_model_fit_statistics)


bootstrapped_fit_statistics <- all_model_fit_statistics %>%
  group_by(model_name, sub_directory_to_save_plots, formula_string_random) %>%
  dplyr::summarise(
    male_BIC_median = median(male_BIC, na.rm = TRUE),
    male_BIC_q2.5 = quantile(male_BIC, 0.025, na.rm = TRUE),
    male_BIC_q97.5 = quantile(male_BIC, 0.975, na.rm = TRUE),
    male_R2_marginal_median = median(male_R2_marginal, na.rm = TRUE),
    male_R2_marginal_q2.5 = quantile(male_R2_marginal, 0.025, na.rm = TRUE),
    male_R2_marginal_q97.5 = quantile(male_R2_marginal, 0.975, na.rm = TRUE),
    male_R2_conditional_median = median(male_R2_conditional, na.rm = TRUE),
    male_R2_conditional_q2.5 = quantile(male_R2_conditional, 0.025, na.rm = TRUE),
    male_R2_conditional_q97.5 = quantile(male_R2_conditional, 0.975, na.rm = TRUE),
    fema_BIC_median = median(fema_BIC, na.rm = TRUE),
    fema_BIC_q2.5 = quantile(fema_BIC, 0.025, na.rm = TRUE),
    fema_BIC_q97.5 = quantile(fema_BIC, 0.975, na.rm = TRUE),
    fema_R2_marginal_median = median(fema_R2_marginal, na.rm = TRUE),
    fema_R2_marginal_q2.5 = quantile(fema_R2_marginal, 0.025, na.rm = TRUE),
    fema_R2_marginal_q97.5 = quantile(fema_R2_marginal, 0.975, na.rm = TRUE),
    fema_R2_conditional_median = median(fema_R2_conditional, na.rm = TRUE),
    fema_R2_conditional_q2.5 = quantile(fema_R2_conditional, 0.025, na.rm = TRUE),
    fema_R2_conditional_q97.5 = quantile(fema_R2_conditional, 0.975, na.rm = TRUE)
  )


dir.create(paste0(sub_directory_to_save_plots), showWarnings = FALSE)
dir.create(paste0(sub_directory_to_save_plots, "/model_fit_statistics"), showWarnings = FALSE)
write.csv(
  all_model_fit_statistics, 
  paste0(sub_directory_to_save_plots, "/model_fit_statistics/all_model_fit_statistics_", 
         gsub(Sys.time(), pattern=" |:", replacement=""), ".csv"), 
  row.names = FALSE)
write.csv(
  bootstrapped_fit_statistics, 
  paste0(sub_directory_to_save_plots, "/model_fit_statistics/bootstrapped_fit_statistics_", 
         gsub(Sys.time(), pattern=" |:", replacement=""), ".csv"), 
  row.names = FALSE)

print("Model fit statistics successfully saved.")
}
```

```{r, function to calculate residuals from spline interaction models and create list of bootstrapped data frames}

calculate_residuals_from_spline_models <- function(
    all_bootstrap_model_results){
  
  

    male_bootstrap_data_list <- vector("list", number_of_bootstraps)

  fema_bootstrap_data_list <- vector("list", number_of_bootstraps)
  

    spline_df <- all_bootstrap_model_results[[1]][[1]][[1]]$spline_df
  sub_directory_to_save_plots <- all_bootstrap_model_results[[1]][[1]][[1]]$sub_directory_to_save_plots


  residuals_sub_directory <- paste0(sub_directory_to_save_plots, "/residuals")
dir.create(residuals_sub_directory)

for (this_bootstrap_number in (1:number_of_bootstraps)){ 
  
  

  male_data_this_bootstrap <- all_bootstrap_model_results$male_model_results_all_bootstraps[[this_bootstrap_number]][[1]]$model$data
fema_data_this_bootstrap <- all_bootstrap_model_results$fema_model_results_all_bootstraps[[this_bootstrap_number]][[1]]$model$data
  
male_data_this_bootstrap$original_row_no <- 
  seq_len(nrow(male_data_this_bootstrap)) 

fema_data_this_bootstrap$original_row_no <- 
  seq_len(nrow(fema_data_this_bootstrap)) 

for (each_model in 1:length(all_bootstrap_model_results$fema_model_results_all_bootstraps[[this_bootstrap_number]])) {
  
  male_formula_name <- all_bootstrap_model_results$male_model_results_all_bootstraps[[this_bootstrap_number]][[each_model]]$formula_name
  fema_formula_name <- all_bootstrap_model_results$fema_model_results_all_bootstraps[[this_bootstrap_number]][[each_model]]$formula_name
  
  if (grepl(x=str_extract(male_formula_name, "(?<=_)[^_]+(?=_)"), pattern="height")){
    male_dependent_variable <- all_bootstrap_model_results$male_model_results_all_bootstraps[[this_bootstrap_number]][[each_model]]$list_of_variables$dependent_height
  }
  if (grepl(x=str_extract(male_formula_name, "(?<=_)[^_]+(?=_)"), pattern="weight")){
    male_dependent_variable <- all_bootstrap_model_results$male_model_results_all_bootstraps[[this_bootstrap_number]][[each_model]]$list_of_variables$dependent_weight
  }
  if (grepl(x=str_extract(male_formula_name, "(?<=_)[^_]+(?=_)"), pattern="bmi")){
    male_dependent_variable <- all_bootstrap_model_results$male_model_results_all_bootstraps[[this_bootstrap_number]][[each_model]]$list_of_variables$dependent_bmi
  }
  
  if (grepl(x=str_extract(fema_formula_name, "(?<=_)[^_]+(?=_)"), pattern="height")){
    fema_dependent_variable <- all_bootstrap_model_results$fema_model_results_all_bootstraps[[this_bootstrap_number]][[each_model]]$list_of_variables$dependent_height
  }
  if (grepl(x=str_extract(fema_formula_name, "(?<=_)[^_]+(?=_)"), pattern="weight")){
    fema_dependent_variable <- all_bootstrap_model_results$fema_model_results_all_bootstraps[[this_bootstrap_number]][[each_model]]$list_of_variables$dependent_weight
  }
  if (grepl(x=str_extract(fema_formula_name, "(?<=_)[^_]+(?=_)"), pattern="bmi")){
    fema_dependent_variable <- all_bootstrap_model_results$fema_model_results_all_bootstraps[[this_bootstrap_number]][[each_model]]$list_of_variables$dependent_bmi
  }
  
  male_model <- all_bootstrap_model_results$male_model_results_all_bootstraps[[this_bootstrap_number]][[each_model]]$model
  fema_model <- all_bootstrap_model_results$fema_model_results_all_bootstraps[[this_bootstrap_number]][[each_model]]$model
  
  if (!is.na(male_model[[1]])) {
    male_predictions <- 
      predict(male_model, newdata = male_data_this_bootstrap)
    male_data_this_bootstrap[[male_formula_name]] <- male_predictions
    male_data_this_bootstrap[[paste0(male_formula_name, "_residuals")]] <- 
      male_data_this_bootstrap[[male_dependent_variable]] - male_data_this_bootstrap[[male_formula_name]]
  } else {
    male_data_this_bootstrap[[male_formula_name]] <- NA
    male_data_this_bootstrap[[paste0(male_formula_name, "_residuals")]] <- NA
  }
  
  if (!is.na(fema_model[[1]])) {
    fema_predictions <- 
      predict(fema_model, newdata = fema_data_this_bootstrap)
    fema_data_this_bootstrap[[fema_formula_name]] <- fema_predictions
    fema_data_this_bootstrap[[paste0(fema_formula_name, "_residuals")]] <- 
      fema_data_this_bootstrap[[fema_dependent_variable]] - fema_data_this_bootstrap[[fema_formula_name]]
  } else {
    fema_data_this_bootstrap[[fema_formula_name]] <- NA
    fema_data_this_bootstrap[[paste0(fema_formula_name, "_residuals")]] <- NA
  }
  
  male_bootstrap_data_list[[this_bootstrap_number]] <- male_data_this_bootstrap
  
  fema_bootstrap_data_list[[this_bootstrap_number]] <- fema_data_this_bootstrap
}
}
print("Finished predicting residuals for all models")

print("Please note, you need to add a clause if you want to calculate residuals from calculated BMIs from each of height and weight predictions")

return(
    list(
      male_bootstrap_data_list = male_bootstrap_data_list,
      fema_bootstrap_data_list = fema_bootstrap_data_list
    ))
}
```

```{r, function to plot bootstrapped residuals for list of formulas}
plot_bootstrapped_residuals_for_list_of_formulas <- function (
    all_bootstrap_data_results_with_residuals,
    all_bootstrap_model_results,
    list_of_variables,
    list_of_my_colours
    ){
  
  sub_directory_to_save_plots <- all_bootstrap_model_results[[1]][[1]][[1]]$sub_directory_to_save_plots
  residuals_sub_directory <- paste0(sub_directory_to_save_plots, "/residuals")

  all_male_bootstraps <- bind_rows(all_bootstrap_data_results_with_residuals$male_bootstrap_data_list, .id = "bootstrap")
  all_fema_bootstraps <- bind_rows(all_bootstrap_data_results_with_residuals$fema_bootstrap_data_list, .id = "bootstrap")
  
  for (each_formula_number in 1:length(all_bootstrap_model_results$list_of_absolute_model_formulas)) {
    
    name_of_formula <- names(all_bootstrap_model_results$list_of_absolute_model_formulas)[[each_formula_number]]
    name_of_formula_residual <- paste0(name_of_formula, "_residuals")
    
    print(paste0("Plotting residuals for formula: ", name_of_formula))
    
    male_age_to_plot <- all_male_bootstraps[[list_of_variables$age_variable]]
    male_residuals_to_plot <- all_male_bootstraps[[name_of_formula_residual]]
    
    fema_age_to_plot <- all_fema_bootstraps[[list_of_variables$age_variable]]
    fema_residuals_to_plot <- all_fema_bootstraps[[name_of_formula_residual]]
    
    for (each_sex in c("male", "fema")) {
      
      if (each_sex == "male") {
        age_to_plot <- male_age_to_plot
        residuals_to_plot <- male_residuals_to_plot
        colour_to_plot <- list_of_my_colours$default_male_colour
      } else {
        age_to_plot <- fema_age_to_plot
        residuals_to_plot <- fema_residuals_to_plot
        colour_to_plot <- list_of_my_colours$default_fema_colour
      }
      
      data_to_plot <- data.frame(
        age_to_plot = age_to_plot,
        residuals_to_plot = residuals_to_plot
      )
      
      bootstrap_residual_plot_for_this_formula <- 
        ggplot(data = data_to_plot) +
        geom_hline(yintercept = 0) +
        geom_point(aes(x = age_to_plot, y = residuals_to_plot), colour = colour_to_plot, alpha = 0.1) +
        geom_smooth(aes(x = age_to_plot, y = residuals_to_plot), formula = y ~ x, method = "loess", colour = "black") +
        labs(title = paste0("df = ", spline_df, ": ", name_of_formula, " (", each_sex, ")"),
             x = list_of_variables$age_variable,
             y = "Residual") +
        coord_cartesian(ylim = c(-10, 10), xlim = c(0, 20)) +
        scale_x_continuous(breaks = seq(0, 18, by = 2)) +
        themepowerpointlegend
      
      ggsave(filename = paste0("residuals_", name_of_formula, "_", each_sex, ".png"),
             path = residuals_sub_directory,
             plot = bootstrap_residual_plot_for_this_formula,
             device = "png",
             width = 6,
             height = 3,
             limitsize = FALSE)
      
      print(paste0("Printed residual plot for ", name_of_formula))
    } 
  }
  print(paste0("Finished function plot_bootstrapped_residuals_for_list_of_formulas and stored in ", bootstrap_residual_plot_for_this_formula))
}

```



```{r, function to calculate boostrapped example patients from spline interaction models}
calculate_examples_from_spline_models <- function(
    sub_directory_to_save_plots, 
    
    list_of_models_male,
    list_of_models_fema,
    
    list_of_variables,
    
    absolute_spline_knots_male,
    absolute_boundary_knots_male,
    absolute_spline_knots_fema,
    absolute_boundary_knots_fema,
    
    lnpca_spline_knots_male,
    lnpca_boundary_knots_male,
    lnpca_spline_knots_fema,
    lnpca_boundary_knots_fema,

    absolute_low_17ohp,
    absolute_low_androstenedione,

    absolute_high_17ohp,
    absolute_high_androstenedione,

    low_dose_hydro,
    high_dose_hydro,
    
    low_dose_max_hydro,
    high_dose_max_hydro,

    low_dose_fludro){

  list_of_bootstrapped_example_patient_frames <- list()


generic_example_male_frame <-
  data.frame(
    age_variable_to_change=seq(0.1,20, by=0.1)
  )

generic_example_male_frame$absolute_age <- 
  generic_example_male_frame$age_variable_to_change
generic_example_male_frame$ln_post_conceptual_age <- 
  log(generic_example_male_frame$absolute_age + 0.75)



generic_example_fema_frame <- generic_example_male_frame


spline_basis_generic_example_male_frame <- 
  ns(generic_example_male_frame$absolute_age, 
     knots = absolute_spline_knots_male, 
     Boundary.knots = absolute_boundary_knots_male) 

spline_basis_generic_example_fema_frame <- 
  ns(generic_example_fema_frame$absolute_age, 
     knots = absolute_spline_knots_fema, 
     Boundary.knots = absolute_boundary_knots_fema) 

colnames(spline_basis_generic_example_male_frame) <- paste0("absolute_spline_", 1:spline_df)
colnames(spline_basis_generic_example_fema_frame) <- paste0("absolute_spline_", 1:spline_df)

generic_example_male_frame <- 
  cbind(generic_example_male_frame, 
        spline_basis_generic_example_male_frame)
generic_example_fema_frame <- 
  cbind(generic_example_fema_frame, 
        spline_basis_generic_example_fema_frame)


spline_basis_generic_example_male_frame <- 
  ns(generic_example_male_frame$ln_post_conceptual_age, 
     knots = lnpca_spline_knots_male, 
     Boundary.knots = lnpca_boundary_knots_male)
colnames(spline_basis_generic_example_male_frame) <- paste0("lnpca_spline_", 1:spline_df)
generic_example_male_frame <- 
  cbind(generic_example_male_frame, 
        spline_basis_generic_example_male_frame)


spline_basis_generic_example_fema_frame <- 
  ns(generic_example_fema_frame$ln_post_conceptual_age, 
     knots = lnpca_spline_knots_fema, 
     Boundary.knots = lnpca_boundary_knots_fema)
colnames(spline_basis_generic_example_fema_frame) <- paste0("lnpca_spline_", 1:spline_df)
generic_example_fema_frame <- 
  cbind(generic_example_fema_frame, 
        spline_basis_generic_example_fema_frame)


low_dose_good_control_male_patient <-
  low_dose_poor_control_male_patient <-
  high_dose_good_control_male_patient <-
  high_dose_poor_control_male_patient <-
  generic_example_male_frame

low_dose_good_control_fema_patient <-
  low_dose_poor_control_fema_patient <-
  high_dose_good_control_fema_patient <-
  high_dose_poor_control_fema_patient <-
  generic_example_fema_frame



low_dose_good_control_male_patient$example_name <- "low_dose_good_control_male_patient"
low_dose_good_control_male_patient$hydrocortisone_variable_to_change <- low_dose_hydro
low_dose_good_control_male_patient$fludrocortisone_variable_to_change <- low_dose_fludro
low_dose_good_control_male_patient$ohp_variable_to_change <- log(absolute_low_17ohp)
low_dose_good_control_male_patient$androstenedione_variable_to_change <- log(absolute_low_androstenedione)
low_dose_good_control_male_patient$sex_variable_to_change <- 1

high_dose_good_control_male_patient$example_name <- "high_dose_good_control_male_patient"
high_dose_good_control_male_patient$hydrocortisone_variable_to_change <- high_dose_hydro
high_dose_good_control_male_patient$fludrocortisone_variable_to_change <- low_dose_fludro
high_dose_good_control_male_patient$ohp_variable_to_change <- log(absolute_low_17ohp)
high_dose_good_control_male_patient$androstenedione_variable_to_change <- log(absolute_low_androstenedione)
high_dose_good_control_male_patient$sex_variable_to_change <- 1

low_dose_poor_control_male_patient$example_name <- "low_dose_poor_control_male_patient"
low_dose_poor_control_male_patient$hydrocortisone_variable_to_change <- low_dose_hydro
low_dose_poor_control_male_patient$fludrocortisone_variable_to_change <- low_dose_fludro
low_dose_poor_control_male_patient$ohp_variable_to_change <- log(absolute_high_17ohp)
low_dose_poor_control_male_patient$androstenedione_variable_to_change <- log(absolute_high_androstenedione)
low_dose_poor_control_male_patient$sex_variable_to_change <- 1

high_dose_poor_control_male_patient$example_name <- "high_dose_poor_control_male_patient"
high_dose_poor_control_male_patient$hydrocortisone_variable_to_change <- high_dose_hydro
high_dose_poor_control_male_patient$fludrocortisone_variable_to_change <- low_dose_fludro
high_dose_poor_control_male_patient$ohp_variable_to_change <- log(absolute_high_17ohp)
high_dose_poor_control_male_patient$androstenedione_variable_to_change <- log(absolute_high_androstenedione)
high_dose_poor_control_male_patient$sex_variable_to_change <- 1

low_dose_good_control_fema_patient$example_name <- "low_dose_good_control_fema_patient"
low_dose_good_control_fema_patient$hydrocortisone_variable_to_change <- low_dose_hydro
low_dose_good_control_fema_patient$fludrocortisone_variable_to_change <- low_dose_fludro
low_dose_good_control_fema_patient$ohp_variable_to_change <- log(absolute_low_17ohp)
low_dose_good_control_fema_patient$androstenedione_variable_to_change <- log(absolute_low_androstenedione)
low_dose_good_control_fema_patient$sex_variable_to_change <- 2

high_dose_good_control_fema_patient$example_name <- "high_dose_good_control_fema_patient"
high_dose_good_control_fema_patient$hydrocortisone_variable_to_change <- high_dose_hydro
high_dose_good_control_fema_patient$fludrocortisone_variable_to_change <- low_dose_fludro
high_dose_good_control_fema_patient$ohp_variable_to_change <- log(absolute_low_17ohp)
high_dose_good_control_fema_patient$androstenedione_variable_to_change <- log(absolute_low_androstenedione)
high_dose_good_control_fema_patient$sex_variable_to_change <- 2

low_dose_poor_control_fema_patient$example_name <- "low_dose_poor_control_fema_patient"
low_dose_poor_control_fema_patient$hydrocortisone_variable_to_change <- low_dose_hydro
low_dose_poor_control_fema_patient$fludrocortisone_variable_to_change <- low_dose_fludro
low_dose_poor_control_fema_patient$ohp_variable_to_change <- log(absolute_high_17ohp)
low_dose_poor_control_fema_patient$androstenedione_variable_to_change <- log(absolute_high_androstenedione)
low_dose_poor_control_fema_patient$sex_variable_to_change <- 2

high_dose_poor_control_fema_patient$example_name <- "high_dose_poor_control_fema_patient"
high_dose_poor_control_fema_patient$hydrocortisone_variable_to_change <- high_dose_hydro
high_dose_poor_control_fema_patient$fludrocortisone_variable_to_change <- low_dose_fludro
high_dose_poor_control_fema_patient$ohp_variable_to_change <- log(absolute_high_17ohp)
high_dose_poor_control_fema_patient$androstenedione_variable_to_change <- log(absolute_high_androstenedione)
high_dose_poor_control_fema_patient$sex_variable_to_change <- 2


list_of_example_patient_frames_for_every_bootstrap <- 
  list(
    "low_dose_good_control_male_patient"  = low_dose_good_control_male_patient,
    "low_dose_poor_control_male_patient"  = low_dose_poor_control_male_patient,
    "high_dose_good_control_male_patient" = high_dose_good_control_male_patient,
    "high_dose_poor_control_male_patient" = high_dose_poor_control_male_patient,
    "low_dose_good_control_fema_patient"  = low_dose_good_control_fema_patient,
    "low_dose_poor_control_fema_patient"  = low_dose_poor_control_fema_patient,
    "high_dose_good_control_fema_patient" = high_dose_good_control_fema_patient,
    "high_dose_poor_control_fema_patient" = high_dose_poor_control_fema_patient )


  rm(low_dose_good_control_male_patient)
  rm(low_dose_poor_control_male_patient)
  rm(high_dose_good_control_male_patient)
  rm(high_dose_poor_control_male_patient)
  rm(low_dose_good_control_fema_patient)
  rm(low_dose_poor_control_fema_patient)
  rm(high_dose_good_control_fema_patient)
  rm(high_dose_poor_control_fema_patient)



  


    list_of_example_patient_frames_for_every_bootstrap <- lapply(
    list_of_example_patient_frames_for_every_bootstrap, 
    function(df) {
      colnames(df)[colnames(df) == "age_variable_to_change"] <- 
        list_of_variables$age_variable
      colnames(df)[colnames(df) == "sex_variable_to_change"] <- 
        list_of_variables$sex_variable
      return(df)
    }
  )
  
if (!is.null(list_of_variables$hydrocortisone_variable)) {
  list_of_example_patient_frames_for_every_bootstrap <- lapply(
    list_of_example_patient_frames_for_every_bootstrap,
    function(df) {
      colnames(df)[colnames(df) == "hydrocortisone_variable_to_change"] <- 
        list_of_variables$hydrocortisone_variable
      return(df)
    }
  )
}
  
if (!is.null(list_of_variables$fludrocortisone_variable)) {
  list_of_example_patient_frames_for_every_bootstrap <- lapply(
    list_of_example_patient_frames_for_every_bootstrap,
    function(df) {
      colnames(df)[colnames(df) == "fludrocortisone_variable_to_change"] <- 
        list_of_variables$fludrocortisone_variable
      return(df)
    }
  )
}
  
if (!is.null(list_of_variables$ohp_variable)) {
  list_of_example_patient_frames_for_every_bootstrap <- lapply(
    list_of_example_patient_frames_for_every_bootstrap,
    function(df) {
      colnames(df)[colnames(df) == "ohp_variable_to_change"] <- 
        list_of_variables$ohp_variable
      return(df)
    }
  )
}
  
if (!is.null(list_of_variables$androstenedione_variable)) {
  list_of_example_patient_frames_for_every_bootstrap <- lapply(
    list_of_example_patient_frames_for_every_bootstrap,
    function(df) {
      colnames(df)[colnames(df) == "androstenedione_variable_to_change"] <- 
        list_of_variables$androstenedione_variable
      return(df)
    }
  )
}


  for (this_bootstrap_number in 1:number_of_bootstraps){

  print("Starting lapply loop for example patient frames")
    
  list_of_example_patient_frames_for_this_bootstrap <- lapply(
    list_of_example_patient_frames_for_every_bootstrap,
    function(df) { 
      
   
      if (df$example_name[[1]] %in% c(
        "low_dose_good_control_male_patient",
        "low_dose_poor_control_male_patient",
        "high_dose_good_control_male_patient",
        "high_dose_poor_control_male_patient")){
      
       
      formula_string <-
        list_of_models_male[[
          this_bootstrap_number]][[
            "dependent_height_null_absolute"]]$
        formula_string
      
      
      df$absolute_simple_height <- 
        predict(
          list_of_models_male[[
            this_bootstrap_number]][[
              "dependent_height_null_absolute"]]$model, 
          newdata = df, level=0)
      
      formula_string <-
        list_of_models_male[[this_bootstrap_number]][["dependent_weight_null_absolute"]]$formula_string
      
      
      df$absolute_simple_weight <- 
        predict(list_of_models_male[[this_bootstrap_number]][["dependent_weight_null_absolute"]]$model, newdata = df, level=0)
      
      print("Have calculated absolute simple height and absolute simple weight in male")
      }
      
      if (df$example_name[[1]] %in% c(
        "low_dose_good_control_fema_patient",
        "low_dose_poor_control_fema_patient",
        "high_dose_good_control_fema_patient",
        "high_dose_poor_control_fema_patient")){
      
      formula_string <-
        list_of_models_fema[[this_bootstrap_number]][["dependent_height_null_absolute"]]$formula_string

            df$absolute_simple_height <- 
        predict(list_of_models_fema[[this_bootstrap_number]][["dependent_height_null_absolute"]]$model, newdata = df, level=0)
      
      formula_string <-
        list_of_models_fema[[this_bootstrap_number]][["dependent_weight_null_absolute"]]$formula_string

      df$absolute_simple_weight <- 
        predict(list_of_models_fema[[this_bootstrap_number]][["dependent_weight_null_absolute"]]$model, newdata = df, level=0)
      
      print("Have calculated absolute simple height and absolute simple weight in fema")
      }
      
      df$absolute_simple_bsa <- 
        sqrt(df$absolute_simple_height * 
               df$absolute_simple_weight / 
               3600)

      df$absolute_simple_bmi <- 
        df$absolute_simple_weight / (((df$absolute_simple_height)/100)^2)
      
      print("Produced an absolute simple bsa to calculate doses")
    
      if (!is.null(list_of_variables$hydrocortisone_variable)){
        
        if (list_of_variables$hydrocortisone_variable==
            "total_daily_hydrocortisone_equivalent_at_visit_carried_to_use"){
          df[[list_of_variables$hydrocortisone_variable]] <-
            df[[list_of_variables$hydrocortisone_variable]] * 
            df$absolute_simple_bsa
        } 
        
      
      if (df$example_name[[1]] %in% c(
        "low_dose_good_control_male_patient",
        "low_dose_poor_control_male_patient",
        "low_dose_good_control_fema_patient",
        "low_dose_poor_control_fema_patient")){
        
          df[[list_of_variables$hydrocortisone_variable]] <- 
            pmin(df[[list_of_variables$hydrocortisone_variable]], low_dose_max_hydro)
          
      }
        
      if (df$example_name[[1]] %in% c(
        "high_dose_good_control_male_patient",
        "high_dose_poor_control_male_patient",
        "high_dose_good_control_fema_patient",
        "high_dose_poor_control_fema_patient")){
        
          df[[list_of_variables$hydrocortisone_variable]] <- 
            pmin(df[[list_of_variables$hydrocortisone_variable]], high_dose_max_hydro)
          
      }
      }
      
  print("Calculating a weight for male example patients without height")
      if (df$example_name[[1]] %in% c(
        "low_dose_good_control_male_patient",
        "low_dose_poor_control_male_patient",
        "high_dose_good_control_male_patient",
        "high_dose_poor_control_male_patient")){
        
      formula_string <-
        list_of_models_male[[this_bootstrap_number]][["dependent_weight_only_covariates_formula_absolute"]]$formula_string
      
      
      df[[list_of_variables$dependent_weight]] <- 
         predict(list_of_models_male[[this_bootstrap_number]][[
           "dependent_weight_only_covariates_formula_absolute"]]$model, newdata=df, level=0) 
      
      formula_string <-
        list_of_models_male[[
          this_bootstrap_number]][[
            "dependent_height_on_weight_with_covariates_formula_absolute"]]$formula_string
      
      
      df[[list_of_variables$dependent_height]] <- 
         predict(list_of_models_male[[
           this_bootstrap_number]][[
             "dependent_height_on_weight_with_covariates_formula_absolute"]]$
             model, newdata=df, level=0)      
      

      
      df[[list_of_variables$dependent_weight]] <- 
         predict(list_of_models_male[[
           this_bootstrap_number]][[
             "dependent_weight_on_height_with_covariates_formula_absolute"]]$model, newdata=df, level=0) 
      
      for (model_name in names(list_of_models_male[[this_bootstrap_number]])) {
        formula_string <- list_of_models_male[[this_bootstrap_number]][[model_name]]$formula_string
        model <- list_of_models_male[[this_bootstrap_number]][[model_name]]$model
  
        if (!is.na(model[[1]])) {
      
        df[[model_name]] <-
          predict(model, newdata = df, level = 0)
        } else {
        
        df[[model_name]] <- NA
        }
      }
      }
      
      
      if (df$example_name[[1]] %in% c(
        "low_dose_good_control_fema_patient",
        "low_dose_poor_control_fema_patient",
        "high_dose_good_control_fema_patient",
        "high_dose_poor_control_fema_patient")){
      formula_string <-
        list_of_models_fema[[this_bootstrap_number]][["dependent_weight_only_covariates_formula_absolute"]]$formula_string

      
       df[[list_of_variables$dependent_weight]] <- 
         predict(list_of_models_fema[[this_bootstrap_number]][["dependent_weight_only_covariates_formula_absolute"]]$model, newdata=df, level=0)
      
      formula_string <-
        list_of_models_fema[[this_bootstrap_number]][["dependent_height_on_weight_with_covariates_formula_absolute"]]$formula_string
      
       df[[list_of_variables$dependent_height]] <- 
         predict(list_of_models_fema[[this_bootstrap_number]][["dependent_height_on_weight_with_covariates_formula_absolute"]]$model, newdata=df, level=0)  
      
      formula_string <-
        list_of_models_fema[[this_bootstrap_number]][["dependent_weight_on_height_with_covariates_formula_absolute"]]$formula_string

      
       df[[list_of_variables$dependent_weight]] <- 
         predict(list_of_models_fema[[this_bootstrap_number]][["dependent_weight_on_height_with_covariates_formula_absolute"]]$model, newdata=df, level=0) 
       
      for (model_name in names(list_of_models_fema[[this_bootstrap_number]])) {
        formula_string <- list_of_models_fema[[this_bootstrap_number]][[model_name]]$formula_string
        model <- list_of_models_fema[[this_bootstrap_number]][[model_name]]$model
  
        if (!is.na(model[[1]])) {
      
        df[[model_name]] <-
          predict(model, newdata = df, level = 0)
        } else {
        
        df[[model_name]] <- NA
        }
      }
      }
      
      df[["calculated_bmi_null_absolute"]] <-
        df[["dependent_weight_null_absolute"]] / 
        (((df[["dependent_height_null_absolute"]])/100)^2)
      
      df[["calculated_bmi_only_covariates_formula_absolute"]] <-
        df[["dependent_weight_only_covariates_formula_absolute"]] /
        (((df[["dependent_height_only_covariates_formula_absolute"]])/100)^2)
      
      df[["calculated_bmi_full_formula_absolute"]] <-
        df[["dependent_weight_on_height_with_covariates_formula_absolute"]] /
        (((df[["dependent_height_on_weight_with_covariates_formula_absolute"]])/100)^2)
      
      #then for lnpca
      df[["calculated_bmi_null_lnpca"]] <-
        df[["dependent_weight_null_lnpca"]] / 
        (((df[["dependent_height_null_lnpca"]])/100)^2)
      
      df[["calculated_bmi_only_covariates_formula_lnpca"]] <-
        df[["dependent_weight_only_covariates_formula_lnpca"]] /
        (((df[["dependent_height_only_covariates_formula_lnpca"]])/100)^2)
      
      df[["calculated_bmi_full_formula_lnpca"]] <-
        df[["dependent_weight_on_height_with_covariates_formula_lnpca"]] /
        (((df[["dependent_height_on_weight_with_covariates_formula_lnpca"]])/100)^2)

      sex_code <- ifelse(
        grepl(x=df$example_name[[1]], pattern="male"),
        1,
        2)
      
      valid_df <- df %>%
        filter(!is.na(dependent_weight_on_height_with_covariates_formula_lnpca), 
               !is.na(dependent_height_on_weight_with_covariates_formula_lnpca), 
               dependent_weight_on_height_with_covariates_formula_lnpca >= 0, 
               dependent_height_on_weight_with_covariates_formula_lnpca > 0)
      
      valid_df[["height_full_formula_absolute_z"]] <-
        ifelse(
          
          valid_df$absolute_age < 5,
          
          anthro::anthro_zscores(
            sex = sex_code,
            age = valid_df$absolute_age * 12,
            weight = valid_df[["dependent_weight_on_height_with_covariates_formula_absolute"]],
            lenhei = valid_df[["dependent_height_on_weight_with_covariates_formula_absolute"]],
            is_age_in_month = TRUE)$zlen,
            
          anthroplus::anthroplus_zscores(
            sex = sex_code,
            age_in_months = valid_df$absolute_age * 12,
            weight_in_kg = valid_df[["dependent_weight_on_height_with_covariates_formula_absolute"]],
            height_in_cm = valid_df[["dependent_height_on_weight_with_covariates_formula_absolute"]])$zhfa
      )    

      valid_df[["weight_full_formula_absolute_z"]] <-
        ifelse(
          
          valid_df$absolute_age < 5,
          
          anthro::anthro_zscores(
            sex = sex_code,
            age = valid_df$absolute_age * 12,
            weight = valid_df[["dependent_weight_on_height_with_covariates_formula_absolute"]],
            lenhei = valid_df[["dependent_height_on_weight_with_covariates_formula_absolute"]],
            is_age_in_month = TRUE)$zwei,
            
          anthroplus::anthroplus_zscores(
            sex = sex_code,
            age_in_months = valid_df$absolute_age * 12,
            weight_in_kg = valid_df[["dependent_weight_on_height_with_covariates_formula_absolute"]],
            height_in_cm = valid_df[["dependent_height_on_weight_with_covariates_formula_absolute"]])$zwfa
      )    
              
      valid_df[["calculated_bmi_full_formula_absolute_z"]] <-
        ifelse(
          
          valid_df$absolute_age < 5,
          
          anthro::anthro_zscores(
            sex = sex_code,
            age = valid_df$absolute_age * 12,
            weight = valid_df[["dependent_weight_on_height_with_covariates_formula_absolute"]],
            lenhei = valid_df[["dependent_height_on_weight_with_covariates_formula_absolute"]],
            is_age_in_month = TRUE)$zbmi,
            
          anthroplus::anthroplus_zscores(
            sex = sex_code,
            age_in_months = valid_df$absolute_age * 12,
            weight_in_kg = valid_df[["dependent_weight_on_height_with_covariates_formula_absolute"]],
            height_in_cm = valid_df[["dependent_height_on_weight_with_covariates_formula_absolute"]])$zbfa
      )    
              
      valid_df[["height_full_formula_lnpca_z"]] <-
        ifelse(
          
          valid_df$absolute_age < 5,
          
          anthro::anthro_zscores(
            sex = sex_code,
            age = valid_df$absolute_age * 12,
            weight = valid_df[["dependent_weight_on_height_with_covariates_formula_lnpca"]],
            lenhei = valid_df[["dependent_height_on_weight_with_covariates_formula_lnpca"]],
            is_age_in_month = TRUE)$zlen,
            
          anthroplus::anthroplus_zscores(
            sex = sex_code,
            age_in_months = valid_df$absolute_age * 12,
            weight_in_kg = valid_df[["dependent_weight_on_height_with_covariates_formula_lnpca"]],
            height_in_cm = valid_df[["dependent_height_on_weight_with_covariates_formula_lnpca"]])$zhfa
      )    

      valid_df[["weight_full_formula_lnpca_z"]] <-
        ifelse(
          
          valid_df$absolute_age < 5,
          
          anthro::anthro_zscores(
            sex = sex_code,
            age = valid_df$absolute_age * 12,
            weight = valid_df[["dependent_weight_on_height_with_covariates_formula_lnpca"]],
            lenhei = valid_df[["dependent_height_on_weight_with_covariates_formula_lnpca"]],
            is_age_in_month = TRUE)$zwei,
            
          anthroplus::anthroplus_zscores(
            sex = sex_code,
            age_in_months = valid_df$absolute_age * 12,
            weight_in_kg = valid_df[["dependent_weight_on_height_with_covariates_formula_lnpca"]],
            height_in_cm = valid_df[["dependent_height_on_weight_with_covariates_formula_lnpca"]])$zwfa
      )    
              
      valid_df[["calculated_bmi_full_formula_lnpca_z"]] <-
        ifelse(
          
          valid_df$absolute_age < 5,
          
          anthro::anthro_zscores(
            sex = sex_code,
            age = valid_df$absolute_age * 12,
            weight = valid_df[["dependent_weight_on_height_with_covariates_formula_lnpca"]],
            lenhei = valid_df[["dependent_height_on_weight_with_covariates_formula_lnpca"]],
            is_age_in_month = TRUE)$zbmi,
            
          anthroplus::anthroplus_zscores(
            sex = sex_code,
            age_in_months = valid_df$absolute_age * 12,
            weight_in_kg = valid_df[["dependent_weight_on_height_with_covariates_formula_lnpca"]],
            height_in_cm = valid_df[["dependent_height_on_weight_with_covariates_formula_lnpca"]])$zbfa
      )    
              
      valid_df_to_join <-
        valid_df[,c(
          "absolute_age",
          "height_full_formula_absolute_z",
          "weight_full_formula_absolute_z",
          "calculated_bmi_full_formula_absolute_z",
          "height_full_formula_lnpca_z",
          "weight_full_formula_lnpca_z",
          "calculated_bmi_full_formula_lnpca_z"
          
        )]
      
      df <- left_join(df, valid_df_to_join, by="absolute_age")  
      
      return(df)
    }
  
  )
    print(paste0("you finished the lapply loop for bootstrap number ", this_bootstrap_number, " out of ", number_of_bootstraps))
    
    
    list_of_bootstrapped_example_patient_frames[[length(list_of_bootstrapped_example_patient_frames)+1]] <- 
      this_bootstrap_number
    
    list_of_bootstrapped_example_patient_frames[[this_bootstrap_number]] <- 
      list_of_example_patient_frames_for_this_bootstrap

save(
  list_of_bootstrapped_example_patient_frames, 
  file = paste0(sub_directory_to_save_plots, "/list_of_bootstrapped_example_patient_frames.Rdata"))

return (list_of_bootstrapped_example_patient_frames)
} 
```

```{r, function to combine bootstrapped example patients}
combine_bootstrapped_example_patients <- 
  function(
    list_of_bootstrapped_example_patient_frames
    ){
    
example_patient_names <- names(list_of_bootstrapped_example_patient_frames[[1]])
    
list_of_stacked_bootstrapped_example_patients <- lapply(example_patient_names, function(patient_name) {
  bind_rows(
    lapply(seq_len(number_of_bootstraps), function(i) {
      df <- list_of_bootstrapped_example_patient_frames[[i]][[patient_name]]
      df$bootstrap_number <- i
      return(df)
    })
  )
})

names(list_of_stacked_bootstrapped_example_patients) <- example_patient_names

columns_to_exclude_from_both <- 
  c(
    )
columns_to_exclude_from_quantiles <- 
  c(
    )

list_of_summaries_of_bootstrapped_example_patients <- 
  lapply(
    list_of_stacked_bootstrapped_example_patients, function(df) 
      {
    
    numeric_cols <- names(df)[sapply(df, is.numeric)]
    numeric_cols <- setdiff(numeric_cols, c("age_to_use", "bootstrap_number", columns_to_exclude_from_both))
    
    columns_to_exclude_from_quantiles_pattern <- 
      grepl("_spline", numeric_cols) | numeric_cols %in% 
      columns_to_exclude_from_quantiles
    
    columns_to_exclude_from_quantiles_final <- 
      numeric_cols[columns_to_exclude_from_quantiles_pattern]
    
    columns_to_include_in_quantiles <- 
      setdiff(numeric_cols, columns_to_exclude_from_quantiles_final)
    
    consistency_check <- sapply(numeric_cols, function(col) {
      variation_per_group <- df %>%
        group_by(age_to_use, absolute_age, ln_post_conceptual_age) %>%
        summarise(var_val = var(.data[[col]], na.rm = TRUE), .groups = "drop") %>%
        pull(var_val)
      
      all(is.na(variation_per_group) | variation_per_group == 0)
    })
    
    consistent_cols <- names(consistency_check)[consistency_check]
    
    df <- df %>%
      rename_with(.cols = consistent_cols, ~ paste0(.x, "_consistent"))
    
    df %>%
      group_by(age_to_use) %>%
      summarise(
        across(
          where(is.numeric) & !all_of(columns_to_exclude_from_both) & !ends_with("_consistent"),
          list(
            median = ~ median(.x, na.rm = TRUE),
            p2.5 = ~ if (cur_column() %in% 
                         columns_to_exclude_from_quantiles_final) NA_real_ else unname(quantile(.x, 0.025, na.rm = TRUE)),
            p97.5 = ~ if (cur_column() %in% 
                          columns_to_exclude_from_quantiles_final) NA_real_ else unname(quantile(.x, 0.975, na.rm = TRUE))
          ),
          .names = "{.col}_{.fn}"
        ),
        across(
          ends_with("_consistent"),
          ~ first(.x),
          .names = "{.col}"
        )
      ) %>%
      ungroup()
  })


return(
  list(
    list_of_stacked_bootstrapped_example_patients = list_of_stacked_bootstrapped_example_patients,
    list_of_summaries_of_bootstrapped_example_patients = list_of_summaries_of_bootstrapped_example_patients
  ))


  }

```

```{r, function to visualise example patients from spline interaction models with individual bootstrap lines}
plot_each_line_bootstrapped_example_patients <- 
  function(
    list_of_stacked_bootstrapped_example_patients,
    list_of_models_male,
    list_of_models_fema,
    data_to_model_both_sexes_complete,
    sub_directory_to_save_plots,
    list_of_my_ylims,
    list_of_my_colours
    ) {
    
    
example_plot_directory_male <- file.path(sub_directory_to_save_plots, "example_plots_", "male")
example_plot_directory_fema <- file.path(sub_directory_to_save_plots, "example_plots_", "fema")

dir.create(example_plot_directory_male, recursive = TRUE, showWarnings = FALSE)
dir.create(example_plot_directory_fema, recursive = TRUE, showWarnings = FALSE)



for (sex in c("male", "fema")) {
  
  if (sex == "male") {
  example_plot_directory <- example_plot_directory_male
  list_of_models <- list_of_models_male
  data_to_model <- 
    subset(
      data_to_model_both_sexes_complete,
      data_to_model_both_sexes_complete[[list_of_variables$sex_variable]]==1
    )
  default_colour <- list_of_my_colours$default_male_colour
    
    } else {
      
  example_plot_directory <- example_plot_directory_fema
  list_of_models <- list_of_models_fema
  data_to_model <- 
    subset(
      data_to_model_both_sexes_complete,
      data_to_model_both_sexes_complete[[list_of_variables$sex_variable]]==2
    )
  default_colour <- list_of_my_colours$default_fema_colour
    }
  
  names_of_models <- names(list_of_models[[1]])
  
  names_of_models <- 
    c(names_of_models,
      list(
        "calculated_bmi_null_absolute",
        "calculated_bmi_only_covariates_formula_absolute",
        "calculated_bmi_full_formula_absolute",
        "calculated_bmi_null_lnpca",
        "calculated_bmi_only_covariates_formula_lnpca",
        "calculated_bmi_full_formula_lnpca"
      ))

  for (each_model_name in names_of_models) {
  
    my_ylim <- 
      if (grepl("dependent_weight", each_model_name)) {
      list_of_my_ylims$my_ylim_weight
    } else if (grepl("dependent_height", each_model_name)) {
      list_of_my_ylims$my_ylim_height
    } else if (grepl("dependent_bmi", each_model_name)) {
      list_of_my_ylims$my_ylim_bmi
    } else if (grepl("calculated_bmi", each_model_name)) {
      list_of_my_ylims$my_ylim_bmi
    } else {
      NULL
    }
    
    dependent_variable <- 
      if (grepl("dependent_weight", each_model_name)) {
      list_of_variables$dependent_weight
    } else if (grepl("dependent_height", each_model_name)) {
      list_of_variables$dependent_height
    } else if (grepl("dependent_bmi", each_model_name)) {
      list_of_variables$dependent_bmi
    } else if (grepl("calculated_bmi", each_model_name)) {
      list_of_variables$dependent_bmi
    } else {
      NULL
    }
    
    if (is.na(list_of_stacked_bootstrapped_example_patients[[paste0("low_dose_poor_control_", sex, "_patient")]][[each_model_name]][[1]])) next
    
    all_bootstrap_model_lines_plot <- 
      ggplot() +
      
      geom_point(data = data_to_model, 
                 aes_string(x = list_of_variables$age_variable, y = dependent_variable), 
                 alpha = 0.02, colour = default_colour) +
      
      geom_line(data = list_of_stacked_bootstrapped_example_patients[[paste0("low_dose_poor_control_", sex, "_patient")]], 
                aes_string(x = "absolute_age", y = each_model_name, group="bootstrap_number"), 
                alpha = 0.5, colour = list_of_my_colours$low_dose_poor_control_colour) +
      
      geom_line(data = list_of_stacked_bootstrapped_example_patients[[paste0("low_dose_good_control_", sex, "_patient")]], 
                aes_string(x = "absolute_age", y = each_model_name, group="bootstrap_number"), 
                alpha = 0.5, colour = list_of_my_colours$low_dose_good_control_colour) +
      
      geom_line(data = list_of_stacked_bootstrapped_example_patients[[paste0("high_dose_poor_control_", sex, "_patient")]], 
                aes_string(x = "absolute_age", y = each_model_name, group="bootstrap_number"), 
                alpha = 0.5, colour = list_of_my_colours$high_dose_poor_control_colour) +

      geom_line(data = list_of_stacked_bootstrapped_example_patients[[paste0("high_dose_good_control_", sex, "_patient")]], 
                aes_string(x = "absolute_age", y = each_model_name, group="bootstrap_number"), 
                alpha = 0.5, colour = list_of_my_colours$high_dose_good_control_colour) +

      labs(
        title = paste0("df = ", spline_df, ": ", sex, " ", each_model_name),
        subtitle = "low dose poor control = dark green, low dose good control = light green, high dose poor control = dark red"
      ) +
      
      coord_cartesian(xlim = c(0, 18), ylim = my_ylim) +
      
      scale_x_continuous(breaks = seq(0, 18, by = 2)) +
      
      themepowerpointtitle
    
    print(each_model_name)
    print("saved into:")
    print(example_plot_directory)
    
    ggsave(
      filename = paste0(each_model_name, "_", sex, ".png"),   
      path = example_plot_directory, 
      plot = all_bootstrap_model_lines_plot,
      width = 6, height = 3, dpi = 300
    )
  }
}
}
```


```{r, function to visualise example patients from spline interaction models with individual bootstrap lines}

plot_example_patients_with_ribbon_CI_shading <- 
  function(
    list_of_summaries_of_bootstrapped_example_patients,
    list_of_models_male,
    list_of_models_fema,
    data_to_model_both_sexes_complete, 
    
    sub_directory_to_save_plots,
    list_of_my_ylims,
    list_of_my_colours
    ) {
    
    
    
    
example_plot_directory_male <- file.path(sub_directory_to_save_plots, "example_CI_shaded_plots", "male")
example_plot_directory_fema <- file.path(sub_directory_to_save_plots, "example_CI_shaded_plots", "fema")

dir.create(example_plot_directory_male, recursive = TRUE, showWarnings = FALSE)
dir.create(example_plot_directory_fema, recursive = TRUE, showWarnings = FALSE)



for (sex in c("male", "fema")) {
  
  if (sex == "male") {
  example_plot_directory <- example_plot_directory_male
  list_of_models <- list_of_models_male
  data_to_model <- 
    subset(
      data_to_model_both_sexes_complete,
      data_to_model_both_sexes_complete[[list_of_variables$sex_variable]]==1
    )
  default_colour <- list_of_my_colours$default_male_colour
    
    } else {
      
  example_plot_directory <- example_plot_directory_fema
  list_of_models <- list_of_models_fema
  data_to_model <- 
    subset(
      data_to_model_both_sexes_complete,
      data_to_model_both_sexes_complete[[list_of_variables$sex_variable]]==2
    )
  default_colour <- list_of_my_colours$default_fema_colour
    }
  
  #take our names from the first bootstrap
  names_of_models <- names(list_of_models[[1]])
  #then append our calculated models       
  names_of_models <- 
    c(names_of_models,
      list(
        "calculated_bmi_null_absolute",
        "calculated_bmi_only_covariates_formula_absolute",
        "calculated_bmi_full_formula_absolute",
        "calculated_bmi_null_lnpca",
        "calculated_bmi_only_covariates_formula_lnpca",
        "calculated_bmi_full_formula_lnpca"
      ))

  for (each_model_name in names_of_models) {
    
  
    my_ylim <- 
      if (grepl("dependent_weight", each_model_name)) {
      list_of_my_ylims$my_ylim_weight
    } else if (grepl("dependent_height", each_model_name)) {
      list_of_my_ylims$my_ylim_height
    } else if (grepl("dependent_bmi", each_model_name)) {
      list_of_my_ylims$my_ylim_bmi
    } else if (grepl("calculated_bmi", each_model_name)) {
      list_of_my_ylims$my_ylim_bmi
    } else {
      NULL
    }
    
    dependent_variable <- 
      if (grepl("dependent_weight", each_model_name)) {
      list_of_variables$dependent_weight
    } else if (grepl("dependent_height", each_model_name)) {
      list_of_variables$dependent_height
    } else if (grepl("dependent_bmi", each_model_name)) {
      list_of_variables$dependent_bmi
    } else if (grepl("calculated_bmi", each_model_name)) {
      list_of_variables$dependent_bmi
    } else {
      NULL
    }
   
    median_column_name <- paste0(each_model_name, "_median")
    lower_CI_column_name <- paste0(each_model_name, "_p2.5")
    upper_CI_column_name <- paste0(each_model_name, "_p97.5")
    
    if (is.null(list_of_summaries_of_bootstrapped_example_patients[[paste0("low_dose_poor_control_", sex, "_patient")]][[median_column_name]])) next
    
    example_patients_with_ribbon_CI_shading_plot <- 
      ggplot() +
      
      geom_point(
        data = data_to_model, 
        aes_string(x = list_of_variables$age_variable, y = dependent_variable), 
        alpha = 0.1, 
        colour = default_colour) +

      geom_ribbon(
        data = list_of_summaries_of_bootstrapped_example_patients[[paste0("low_dose_poor_control_", sex, "_patient")]],
        aes_string(x = list_of_variables$age_variable, ymin = lower_CI_column_name, ymax = upper_CI_column_name),
        fill = list_of_my_colours$low_dose_poor_control_colour,
        alpha = 0.2
        ) +

      geom_ribbon(
        data = list_of_summaries_of_bootstrapped_example_patients[[paste0("low_dose_good_control_", sex, "_patient")]],
        aes_string(x = list_of_variables$age_variable, ymin = lower_CI_column_name, ymax = upper_CI_column_name),
        fill = list_of_my_colours$low_dose_good_control_colour,
        alpha = 0.2
        ) +

      geom_ribbon(
        data = list_of_summaries_of_bootstrapped_example_patients[[paste0("high_dose_poor_control_", sex, "_patient")]],
        aes_string(x = list_of_variables$age_variable, ymin = lower_CI_column_name, ymax = upper_CI_column_name),
        fill = list_of_my_colours$high_dose_poor_control_colour,
        alpha = 0.2
        ) +

      geom_ribbon(
        data = list_of_summaries_of_bootstrapped_example_patients[[paste0("high_dose_good_control_", sex, "_patient")]],
        aes_string(x = list_of_variables$age_variable, ymin = lower_CI_column_name, ymax = upper_CI_column_name),
        fill = list_of_my_colours$high_dose_good_control_colour,
        alpha = 0.2
        ) +
      
      geom_line(
        data = list_of_summaries_of_bootstrapped_example_patients[[paste0("low_dose_poor_control_", sex, "_patient")]], 
        aes_string(x = list_of_variables$age_variable, y = median_column_name), 
        alpha = 0.5, 
        colour = list_of_my_colours$low_dose_poor_control_colour) +
      
      geom_line(
        data = list_of_summaries_of_bootstrapped_example_patients[[paste0("low_dose_good_control_", sex, "_patient")]], 
        aes_string(x = list_of_variables$age_variable, y = median_column_name), 
        alpha = 0.5, 
        colour = list_of_my_colours$low_dose_good_control_colour) +
      
      geom_line(
        data = list_of_summaries_of_bootstrapped_example_patients[[paste0("high_dose_poor_control_", sex, "_patient")]], 
        aes_string(x = list_of_variables$age_variable, y = median_column_name), 
        alpha = 0.5, 
        colour = list_of_my_colours$high_dose_poor_control_colour) +

      geom_line(
        data = list_of_summaries_of_bootstrapped_example_patients[[paste0("high_dose_good_control_", sex, "_patient")]], 
        aes_string(x = list_of_variables$age_variable, y = median_column_name), 
        alpha = 0.5, 
        colour = list_of_my_colours$high_dose_good_control_colour) +
      
      labs(
        title = paste0("df = ", spline_df, ": ", sex, " ", each_model_name),
        subtitle = "low dose poor control = dark green, low dose good control = light green, high dose poor control = dark red"
      ) +
      
      coord_cartesian(
        xlim = c(0, 18), 
        ylim = my_ylim
        ) +
      
      scale_x_continuous(
        breaks = seq(0, 18, by = 2)
        ) +
      
      themepowerpointtitle
    
    print(each_model_name)
    print("saved into:")
    print(example_plot_directory)
    
    ggsave(
      filename = paste0(each_model_name, "_", sex, ".png"),   
      path = example_plot_directory, 
      plot = example_patients_with_ribbon_CI_shading_plot,
      width = 6, height = 3, dpi = 300
    )
    
    ggsave(
      filename = paste0(each_model_name, "_", sex, "_blank.png"),   
      path = example_plot_directory, 
      plot = example_patients_with_ribbon_CI_shading_plot + 
        theme(axis.title=element_blank(), 
              plot.title=element_blank(), 
              plot.subtitle=element_blank()),
      width = 6, height = 3, dpi = 300
    )
  }
}
}
```

```{r, difference the bootstrapped example patients}
difference_bootstrapped_example_patients <- 
  function(
    list_of_bootstrapped_example_patient_frames,
    list_of_variables
    ){
    
example_patient_names <- names(list_of_bootstrapped_example_patient_frames[[1]])

number_of_bootstraps <- length(list_of_bootstrapped_example_patient_frames)


list_of_each_bootstrap_replication_differences_frames <- list()


patient_pairs <- combn(example_patient_names, 2, simplify = FALSE)


patient_pairs <- Filter(function(pair) {
  (grepl("male", pair[1]) && grepl("male", pair[2])) ||
    (grepl("fema", pair[1]) && grepl("fema", pair[2]))
}, patient_pairs)


  for (this_bootstrap in seq_len(number_of_bootstraps)) {
    
    difference_frames_this_bootstrap <- list()
    
    
    for (this_pair in patient_pairs) {
      patient_1 <- this_pair[1]
      patient_2 <- this_pair[2]
      
      df1 <- list_of_bootstrapped_example_patient_frames[[this_bootstrap]][[patient_1]]
      df2 <- list_of_bootstrapped_example_patient_frames[[this_bootstrap]][[patient_2]]
      
      
      if (!all(df1$age_to_use == df2$age_to_use)) {
        stop(paste0("Age alignment issue in bootstrap ", this_bootstrap, " between ", patient_1, " and ", patient_2))
      }
      
      
      diff_df <- df1
      numeric_cols <- names(diff_df)[sapply(diff_df, is.numeric)]
      
      numeric_cols <- 
        setdiff(numeric_cols, 
                c("bootstrap_number", 
                  list_of_variables$age_variable,
                  "absolute_age",
                  "ln_post_conceptual_age")) 
      
      diff_df[numeric_cols] <- df1[numeric_cols] - df2[numeric_cols]
      diff_df$comparison <- paste0(patient_1, "_minus_", patient_2)
      diff_df$bootstrap_number <- this_bootstrap
      
      difference_frames_this_bootstrap[[diff_df$comparison[1]]] <- diff_df
    }
    
    list_of_each_bootstrap_replication_differences_frames[[this_bootstrap]] <- difference_frames_this_bootstrap
  }
  
  return(list_of_each_bootstrap_replication_differences_frames)
}
```

```{r, summarise the list_of_each_bootstrap_replication_differences_frames}
combine_bootstrapped_example_patient_differences <- function(
  list_of_each_bootstrap_replication_differences_frames,
  list_of_variables,
  additional_columns_to_exclude = c()
) {

  number_of_bootstraps <- length(list_of_each_bootstrap_replication_differences_frames)

  
  comparison_names <- names(list_of_each_bootstrap_replication_differences_frames[[1]])

  
  list_of_each_bootstrap_replication_differences_frames <- lapply(
    seq_len(number_of_bootstraps),
    function(each_bootstrap) {
      new_df_with_row <- list_of_each_bootstrap_replication_differences_frames[[each_bootstrap]]

      new_df_with_row <- lapply(names(new_df_with_row), function(each_comparison) {
        df <- new_df_with_row[[each_comparison]]
        df$row_number <- seq_len(nrow(df))
        return(df)
      })

      names(new_df_with_row) <- names(list_of_each_bootstrap_replication_differences_frames[[each_bootstrap]])
      return(new_df_with_row)
    }
  )

  
  list_of_stacked_bootstrapped_differences_frames <- lapply(comparison_names, function(each_comparison) {
    stacked_frames <- lapply(seq_len(number_of_bootstraps), function(each_bootstrap) {
      frame_to_add <- list_of_each_bootstrap_replication_differences_frames[[each_bootstrap]][[each_comparison]]

      
      frame_to_add <- frame_to_add[, colSums(frame_to_add != 0, na.rm = TRUE) > 0, drop = FALSE]

      return(frame_to_add)
    })

    dplyr::bind_rows(stacked_frames)
  })
  names(list_of_stacked_bootstrapped_differences_frames) <- comparison_names

  
  list_of_summary_bootstrapped_differences_frames <- lapply(list_of_stacked_bootstrapped_differences_frames, function(df) {

    
    numeric_cols <- names(df)[sapply(df, is.numeric)]

    
    grouping_cols <- c("row_number", list_of_variables$age_variable, "absolute_age", "ln_post_conceptual_age")

    
    numeric_cols <- setdiff(
      numeric_cols,
      c("bootstrap_number", additional_columns_to_exclude, grep("_spline", numeric_cols, value = TRUE), grouping_cols)
    )

    
    summary_bootstrapped_differences_frames <- df %>%
      dplyr::group_by(across(all_of(grouping_cols))) %>%
      dplyr::summarise(across(
        .cols = all_of(numeric_cols),
        .fns = list(
          median = ~median(.x, na.rm = TRUE),
          p2.5 = ~unname(quantile(.x, 0.025, na.rm = TRUE)),
          p97.5 = ~unname(quantile(.x, 0.975, na.rm = TRUE))
        ),
        .names = "{.col}_difference_{.fn}"
      ),
      .groups = "drop"
      )

    
    for (col in numeric_cols) {
      lower_col <- paste0(col, "_difference_p2.5")
      upper_col <- paste0(col, "_difference_p97.5")
      sig_col   <- paste0(col, "_significant")

      summary_bootstrapped_differences_frames[[sig_col]] <- ifelse(
        summary_bootstrapped_differences_frames[[lower_col]] > 0 | summary_bootstrapped_differences_frames[[upper_col]] < 0,
        "*", "" 
        
      )
    }

    return(summary_bootstrapped_differences_frames)
  })

  return(
    list(
      list_of_stacked_bootstrapped_differences_frames = list_of_stacked_bootstrapped_differences_frames,
      list_of_summary_bootstrapped_differences_frames = list_of_summary_bootstrapped_differences_frames
      )
  )
}

```

```{r, function to visualise the differences between example patients from spline interaction models with individual differences lines}
plot_each_line_difference_between_example_patients <- 
  function(
    list_of_stacked_bootstrapped_differences_frames,
    list_of_models_male,
    list_of_models_fema,
    sub_directory_to_save_plots,
    list_of_my_ylims,
    list_of_my_colours
    ) {
    
    
    differences_plot_directory_name <- paste0(sub_directory_to_save_plots, "differences_plots_")
differences_plot_directory_male <- file.path(sub_directory_to_save_plots, "differences_plots_", "male")
differences_plot_directory_fema <- file.path(sub_directory_to_save_plots, "differences_plots_", "fema")

dir.create(differences_plot_directory_male, recursive = TRUE, showWarnings = FALSE)
dir.create(differences_plot_directory_fema, recursive = TRUE, showWarnings = FALSE)



for (sex in c("male", "fema")) {
  
  if (sex == "male") {
  differences_plot_directory <- differences_plot_directory_male
  list_of_models <- list_of_models_male
  default_colour <- list_of_my_colours$default_male_colour
    
    } else {
      
  differences_plot_directory <- differences_plot_directory_fema
  list_of_models <- list_of_models_fema
  default_colour <- list_of_my_colours$default_fema_colour
  }
  
  
  naming_key_frame = data.frame()
  
  
  
  names_of_models <- names(list_of_models[[1]])
  
  names_of_models <- 
    c(names_of_models,
      list(
        "calculated_bmi_null_absolute",
        "calculated_bmi_only_covariates_formula_absolute",
        "calculated_bmi_full_formula_absolute",
        "calculated_bmi_null_lnpca",
        "calculated_bmi_only_covariates_formula_lnpca",
        "calculated_bmi_full_formula_lnpca"
      ))
  
  print(paste0("Plotting all of the following: ", names_of_models, " for ", sex))

  for (each_model_number in 1:length(names_of_models)) {
    
    each_model_name <- names_of_models[[each_model_number]]
  
    my_ylim <- 
      if (grepl("dependent_weight", each_model_name)) {
      list_of_my_ylims$my_ylim_differences_weight
    } else if (grepl("dependent_height", each_model_name)) {
      list_of_my_ylims$my_ylim_differences_height
    } else if (grepl("dependent_bmi", each_model_name)) {
      list_of_my_ylims$my_ylim_differences_bmi
    } else if (grepl("calculated_bmi", each_model_name)) {
      list_of_my_ylims$my_ylim_differences_bmi
    } else {
      NULL
    }
    
    dependent_variable <- 
      if (grepl("dependent_weight", each_model_name)) {
      list_of_variables$dependent_weight
    } else if (grepl("dependent_height", each_model_name)) {
      list_of_variables$dependent_height
    } else if (grepl("dependent_bmi", each_model_name)) {
      list_of_variables$dependent_bmi
    } else if (grepl("calculated_bmi", each_model_name)) {
      list_of_variables$dependent_bmi
    } else {
      NULL
    }
    
      print(paste0("Plotting model ", each_model_name, " for ", sex))
    
    for (each_comparison_number in 1:length(list_of_stacked_bootstrapped_differences_frames)){

      each_comparison_name <- names(list_of_stacked_bootstrapped_differences_frames)[[each_comparison_number]]
      
      
      if (!grepl(x=each_comparison_name, pattern=sex)) next
      
      
    if (
      length(
        list_of_stacked_bootstrapped_differences_frames[[each_comparison_name]][[each_model_name]])==0) next
            
    
    all_bootstrap_difference_lines_plot <- 
      ggplot() +
      
      geom_hline(yintercept=0, colour="black", alpha=0.5, linewidth=2) +
      
      geom_line(data = list_of_stacked_bootstrapped_differences_frames[[each_comparison_name]], 
                aes_string(x = "absolute_age", y = each_model_name, group="bootstrap_number"), 
                alpha = 0.2, colour = default_colour) +
      
      labs(
        title = paste0("df = ", spline_df, ": ", sex, " ", each_model_name),
        subtitle = each_comparison_name
      ) +
      
      coord_cartesian(xlim = c(0, 18), ylim = my_ylim) +
      
      scale_x_continuous(breaks = seq(0, 18, by = 2)) +
      
      themepowerpointtitle
    
    
    
    
    naming_key_frame_to_add <-
    data.frame(
      each_model_number = each_model_number,
      each_model_name = each_model_name,
      each_comparison_number = each_comparison_number,
      each_comparison_name = each_comparison_name)
    
    naming_key_frame = rbind(naming_key_frame, naming_key_frame_to_add)
    
    write.csv(naming_key_frame, paste0(differences_plot_directory, "/naming_key_frame.csv"), row.names = F)
    
    
    ggsave(
      filename = paste0("model_", each_model_number, "_comparison_", each_comparison_number, "_", sex, ".png"),   
      path = differences_plot_directory, 
      plot = all_bootstrap_difference_lines_plot,
      width = 6, height = 3, dpi = 300
    )
    
    
    } 
      
  }
}
print(paste0("Finished function plot_each_line_difference_between_example_patients all plots have been saved to ", differences_plot_directory_name))
  }


```

```{r, function to visualise the differences between example patients from spline interaction models with ribbon shaded confidence intervals of differences}
plot_bootstrapped_difference_with_ribbon_CI_between_example_patients <- 
  function(
    list_of_summary_bootstrapped_differences_frames,
    list_of_models_male,
    list_of_models_fema,
    sub_directory_to_save_plots,
    list_of_my_ylims,
    list_of_my_colours
    ) {
    
    
differences_CI_plot_directory <- file.path(sub_directory_to_save_plots, "differences_CI_plots")
differences_CI_plot_directory_male <- file.path(sub_directory_to_save_plots, "differences_CI_plots", "male")
differences_CI_plot_directory_fema <- file.path(sub_directory_to_save_plots, "differences_CI_plots", "fema")

dir.create(differences_CI_plot_directory, recursive = TRUE, showWarnings = FALSE)
dir.create(differences_CI_plot_directory_male, recursive = TRUE, showWarnings = FALSE)
dir.create(differences_CI_plot_directory_fema, recursive = TRUE, showWarnings = FALSE)



for (sex in c("male", "fema")) {
  
  if (sex == "male") {
  differences_CI_plot_directory <- differences_CI_plot_directory_male
  list_of_models <- list_of_models_male
  default_colour <- list_of_my_colours$default_male_colour
    
    } else {
      
  differences_CI_plot_directory <- differences_CI_plot_directory_fema
  list_of_models <- list_of_models_fema
  default_colour <- list_of_my_colours$default_fema_colour
  }
  
  
  naming_key_frame = data.frame()

  
  
  names_of_models <- names(list_of_models[[1]])
  
    
  names_of_models <- 
    c(names_of_models,
      list(
        "calculated_bmi_null_absolute",
        "calculated_bmi_only_covariates_formula_absolute",
        "calculated_bmi_full_formula_absolute",
        "calculated_bmi_null_lnpca",
        "calculated_bmi_only_covariates_formula_lnpca",
        "calculated_bmi_full_formula_lnpca"
      ))
  
  print(paste0("Plotting all of the following: ", names_of_models, " for ", sex))

  for (each_model_number in 1:length(names_of_models)) {
    
    each_model_name <- names_of_models[[each_model_number]]
  
    my_ylim <- 
      if (grepl("dependent_weight", each_model_name)) {
      list_of_my_ylims$my_ylim_differences_weight
    } else if (grepl("dependent_height", each_model_name)) {
      list_of_my_ylims$my_ylim_differences_height
    } else if (grepl("dependent_bmi", each_model_name)) {
      list_of_my_ylims$my_ylim_differences_bmi
    } else if (grepl("calculated_bmi", each_model_name)) {
      list_of_my_ylims$my_ylim_differences_bmi
    } else {
      NULL
    }
    
    dependent_variable <- 
      if (grepl("dependent_weight", each_model_name)) {
      list_of_variables$dependent_weight
    } else if (grepl("dependent_height", each_model_name)) {
      list_of_variables$dependent_height
    } else if (grepl("dependent_bmi", each_model_name)) {
      list_of_variables$dependent_bmi
    } else if (grepl("calculated_bmi", each_model_name)) {
      list_of_variables$dependent_bmi
    } else {
      NULL
    }
    
      
      median_column_name <- paste0(each_model_name, "_difference_median")
      lower_CI_column_name <- paste0(each_model_name, "_difference_p2.5")
      upper_CI_column_name <- paste0(each_model_name, "_difference_p97.5")
    
    for (each_comparison_number in 1:length(list_of_summary_bootstrapped_differences_frames)){

      each_comparison_name <- names(list_of_summary_bootstrapped_differences_frames)[[each_comparison_number]]
      
      
      if (!grepl(x=each_comparison_name, pattern=sex)) next
      
      
      data_to_plot <- list_of_summary_bootstrapped_differences_frames[[each_comparison_name]]
      
    if (
      length(
        data_to_plot[[median_column_name]])==0) next
    
              
    
    all_bootstrap_difference_CI_plot <- 
      ggplot() +
      
      geom_hline(yintercept=0, colour="black", alpha=0.5, linewidth=2) +
              
      geom_ribbon(
        data = data_to_plot,
        aes_string(x = "absolute_age", ymin = lower_CI_column_name, ymax = upper_CI_column_name),
        fill = default_colour,
        alpha = 0.2
        ) +
      
      geom_line(data = data_to_plot, 
                aes_string(x = "absolute_age", y = median_column_name), 
                alpha = 1, colour = default_colour) +
      
      labs(
        title = paste0("df = ", spline_df, ": ", sex, " ", each_model_name),
        subtitle = each_comparison_name
      ) +
      
      coord_cartesian(xlim = c(0, 18), ylim = my_ylim) +
      
      scale_x_continuous(breaks = seq(0, 18, by = 2)) +
      
      themepowerpointtitle
    
    
    
    
    naming_key_frame_to_add <-
    data.frame(
      each_model_number = each_model_number,
      each_model_name = each_model_name,
      each_comparison_number = each_comparison_number,
      each_comparison_name = each_comparison_name)
    
    naming_key_frame = rbind(naming_key_frame, naming_key_frame_to_add)
    
    write.csv(naming_key_frame, paste0(differences_CI_plot_directory, "/naming_key_frame.csv"), row.names = F)
    
    
    write.csv(
      x=data_to_plot,
      file=paste0(differences_CI_plot_directory, "/model_", each_model_number, "_comparison_", each_comparison_number, "_", sex, ".csv"),
      row.names = F
    )
    
    
    ggsave(
      filename = paste0("model_", each_model_number, "_comparison_", each_comparison_number, "_", sex, ".png"),   
      path = differences_CI_plot_directory, 
      plot = all_bootstrap_difference_CI_plot,
      width = 6, height = 3, dpi = 300
    )
    
    ggsave(
      filename = paste0("model_", each_model_number, "_comparison_", each_comparison_number, "_", sex, "_blank.png"),   
      path = differences_CI_plot_directory, 
      plot = all_bootstrap_difference_CI_plot + 
        theme(axis.title=element_blank(), 
              plot.title=element_blank(), 
              plot.subtitle=element_blank()),
      width = 6, height = 3, dpi = 300
    )
    
    
    } 
      
      
      print(paste0("Finished plotting model ", each_model_name, " for ", sex))
  }
}
print(paste0("Finished function plot_bootstrapped_difference_with_ribbon_CI_between_example_patients with plots and data saved in ", as.character(differences_CI_plot_directory)))
}
```

these functions have been rescued from previous work for use here:


```{r, function to calculate height velocity and weight velocity and who z scores within example frame}
calculate_growth_metrics <- function(df, height_col, weight_col, sex_code) {
  df$increase_in_age <- df$absolute_age - dplyr::lag(df$absolute_age)
  
  df$model_increase_in_height <- df[[height_col]] - dplyr::lag(df[[height_col]])
  df$model_height_velocity <- df$model_increase_in_height / df$increase_in_age
  
  df$model_increase_in_weight <- df[[weight_col]] - dplyr::lag(df[[weight_col]])
  df$model_weight_velocity <- df$model_increase_in_weight / df$increase_in_age
  
  df$model_height_who_z_score <- NA_real_
  df$model_weight_who_z_score <- NA_real_
  df$bmi_from_model_height_and_model_weight_who_z_score <- NA_real_
  
  for (i in seq_len(nrow(df))) {
    age_months <- df$absolute_age[i] * 12
    weight <- df[[weight_col]][i]
    height <- df[[height_col]][i]
    
    if (is.na(age_months) || is.na(weight) || is.na(height)) next
    if (weight <= 0 || height <= 0) next  
    
    
    if (age_months < 60) {
      result <- anthro::anthro_zscores(
        sex = sex_code,
        age = age_months,
        weight = weight,
        lenhei = height,
        is_age_in_month = TRUE
      )
      df$model_height_who_z_score[i] <- result$zlen
      df$model_weight_who_z_score[i] <- result$zwei
      df$bmi_from_model_height_and_model_weight_who_z_score[i] <- result$zbmi
    } else {
      result <- anthroplus::anthroplus_zscores(
        sex = sex_code,
        age_in_months = age_months,
        weight_in_kg = weight,
        height_in_cm = height
      )
      df$model_height_who_z_score[i] <- result$zhfa
      df$model_weight_who_z_score[i] <- result$zwfa
      df$bmi_from_model_height_and_model_weight_who_z_score[i] <- result$zbfa
    }
  }
  
  return(df)
}
```


```{r, define functions to get maximum height velocity after six}
get_max_height_velocity_after_six <- function(df, height_column) {
  max_row <- df %>%
    filter(absolute_age > 6) %>%
    slice_max(model_height_velocity, n = 1, with_ties = FALSE)
  
  list(
    max_velocity = max_row$model_height_velocity,
    age_at_max_velocity = max_row$absolute_age,
    height_at_max_velocity = max_row[[height_column]]
  )
}
```


```{r, define functions to get maximum weight velocity after six}
get_max_weight_velocity_after_six <- function(df, weight_column) {
  max_row <- df %>%
    filter(absolute_age > 6) %>%
    slice_max(model_weight_velocity, n = 1, with_ties = FALSE)
  
  list(
    max_velocity = max_row$model_weight_velocity,
    age_at_max_velocity = max_row$absolute_age,
    weight_at_max_velocity = max_row[[weight_column]]
  )
}
```


```{r, define functions to get height at eighteen}
get_height_at_eighteen <- function(df, height_column) {
  row_at_eighteen <- df %>%
    filter(abs(absolute_age - 18.0) < 1e-6) #safer than asking for precisely 18

  list(
    height_at_eighteen = row_at_eighteen[[height_column]],
    height_velocity_at_eighteen = row_at_eighteen$model_height_velocity
  )
}
```


```{r, define functions to get weight at eighteen}
get_weight_at_eighteen <- function(df, weight_column) {
  row_at_eighteen <- df %>%
    filter(abs(absolute_age - 18.0) < 1e-6) #safer than asking for precisely 18
  
  list(
    weight_at_eighteen = row_at_eighteen[[weight_column]],
    weight_velocity_at_eighteen = row_at_eighteen$model_weight_velocity
  )
}
```


```{r, define functions to get adiposity peak and rebound}

get_bmi_peak_trough_for_each_bootstrap_and_example_for_specific_model <- 
  
  function(
    list_of_bootstrapped_example_patient_frames, 
    name_of_model) { 
    
    

        name_of_model_bmi_z_score <- "calculated_bmi_full_formula_lnpca_z"
    
    if (name_of_model=="calculated_bmi_full_formula_absolute"){
      name_of_model_bmi_z_score <- "calculated_bmi_full_formula_absolute_z"
    }
    

            bmi_peak_trough_frame <- data.frame()
    
  for (each_bootstrap in 1:length(list_of_bootstrapped_example_patient_frames)){
    list_of_example_patient_frames_this_bootstrap <- list_of_bootstrapped_example_patient_frames[[each_bootstrap]]


      if (each_bootstrap %% 50 == 0) {
    print(paste0("Processing bootstrap: ", each_bootstrap))
  }
  
    for(each_example_number in 1:length(list_of_example_patient_frames_this_bootstrap)){
      example_name <- names(list_of_example_patient_frames_this_bootstrap)[[each_example_number]]
      df <- list_of_example_patient_frames_this_bootstrap[[each_example_number]]

  
  df$increase_in_age <- df$absolute_age - lag(df$absolute_age)
  
  df$model_increase_in_bmi <- df[[name_of_model]] - lag(df[[name_of_model]])  
  
  df$model_bmi_velocity <- df$model_increase_in_bmi / df$increase_in_age

  
  dbmi <- diff(df[[name_of_model]])
  
  signs <- sign(dbmi)
  
  sign_change <- diff(signs)
  
  
  peaks <- (which(sign_change == -2) + 1)
  
  if (length(peaks) > 0) {
  
    
  
  row_which_age_is_one <-  which(df$absolute_age == 1)
  
  closest_peak_index <- peaks[which.min(abs(peaks - row_which_age_is_one))]
  
  } else {
  
  closest_peak_index <- NA  
  
  
  }
  
  troughs <- (which(sign_change == 2) + 1)
  
  row_which_age_is_four <-  which(df$absolute_age == 4)
  if (length(troughs) > 0) {
    
  closest_troughs_index <- troughs[which.min(abs(troughs - row_which_age_is_four))]
  } else {
  closest_troughs_index <- NA 
  
  }

  row_of_adiposity_peak <- unique(df[closest_peak_index,]) 
  
  row_of_adiposity_rebound <- unique(df[closest_troughs_index,])
  
  
  bmi_peak_trough_frame_to_add <- 
    data.frame(
      
    example_name = df$example_name[[1]],
    
    bootstrap_number = each_bootstrap,
  
    age_at_adiposity_peak = row_of_adiposity_peak$absolute_age,
  
    bmi_at_adiposity_peak = row_of_adiposity_peak[[name_of_model]],
  
    bmi_z_at_adiposity_peak = row_of_adiposity_peak[[name_of_model_bmi_z_score]],
  
    age_at_adiposity_rebound = row_of_adiposity_rebound$absolute_age,
  
    bmi_at_adiposity_rebound = row_of_adiposity_rebound[[name_of_model]],
  
    bmi_z_at_adiposity_rebound = row_of_adiposity_rebound[[name_of_model_bmi_z_score]]
      
    )
  bmi_peak_trough_frame <- rbind(bmi_peak_trough_frame, bmi_peak_trough_frame_to_add)
    }
  }
  return(bmi_peak_trough_frame)
  }
```

```{r, summarise bootstrapped adiposity peaks and rebounds}
summarise_bootstrapped_peak_trough_frame <-
  function(frame_of_adiposity_peaks_and_rebounds_for_each_bootstrap){
    summary_of_bootstrapped_peaks_and_rebounds <-
    frame_of_adiposity_peaks_and_rebounds_for_each_bootstrap %>%
      group_by(example_name) %>%
      dplyr::summarise(
        age_at_adiposity_peak_median = median(age_at_adiposity_peak, na.rm = TRUE),
        age_at_adiposity_peak_q2.5 = quantile(age_at_adiposity_peak, 0.025, na.rm = TRUE),
        age_at_adiposity_peak_q97.5 = quantile(age_at_adiposity_peak, 0.975, na.rm = TRUE),
        bmi_at_adiposity_peak_median = median(bmi_at_adiposity_peak, na.rm = TRUE),
        bmi_at_adiposity_peak_q2.5 = quantile(bmi_at_adiposity_peak, 0.025, na.rm = TRUE),
        bmi_at_adiposity_peak_q97.5 = quantile(bmi_at_adiposity_peak, 0.975, na.rm = TRUE),
        bmi_z_at_adiposity_peak_median = median(bmi_z_at_adiposity_peak, na.rm = TRUE),
        bmi_z_at_adiposity_peak_q2.5 = quantile(bmi_z_at_adiposity_peak, 0.025, na.rm = TRUE),
        bmi_z_at_adiposity_peak_q97.5 = quantile(bmi_z_at_adiposity_peak, 0.975, na.rm = TRUE),
        
        age_at_adiposity_rebound_median = median(age_at_adiposity_rebound, na.rm = TRUE),
        age_at_adiposity_rebound_q2.5 = quantile(age_at_adiposity_rebound, 0.025, na.rm = TRUE),
        age_at_adiposity_rebound_q97.5 = quantile(age_at_adiposity_rebound, 0.975, na.rm = TRUE),
        bmi_at_adiposity_rebound_median = median(bmi_at_adiposity_rebound, na.rm = TRUE),
        bmi_at_adiposity_rebound_q2.5 = quantile(bmi_at_adiposity_rebound, 0.025, na.rm = TRUE),
        bmi_at_adiposity_rebound_q97.5 = quantile(bmi_at_adiposity_rebound, 0.975, na.rm = TRUE),
        bmi_z_at_adiposity_rebound_median = median(bmi_z_at_adiposity_rebound, na.rm = TRUE),
        bmi_z_at_adiposity_rebound_q2.5 = quantile(bmi_z_at_adiposity_rebound, 0.025, na.rm = TRUE),
        bmi_z_at_adiposity_rebound_q97.5 = quantile(bmi_z_at_adiposity_rebound, 0.975, na.rm = TRUE)
      )
  }
```




```{r, run the functions to create models and calculate residuals and example patients}


number_of_bootstraps <- 500
spline_df <- 3
list_of_variables <-
  list(
    dependent_height = "interpolated_height",
    dependent_weight = "interpolated_weight",
    dependent_bmi = "bmi_using_interpolations",
    sex_variable = "sex_1_for_M_2_for_F",
    age_variable = "age_to_use",

    
    hydrocortisone_variable = "total_daily_hydrocortisone_equivalent_at_visit_carried_to_use",
    fludrocortisone_variable = "total_daily_fludro_dose_with_zero_carried_to_use",
    ohp_variable = "ln_converted_17OHP_nmol_l_imputed_units_0",
    androstenedione_variable = NULL
  )
lower_age <- 0
upper_age <- 20
formula_string_random <- as.character("~ 1 | Centre.Name...Centre/id")
list_of_my_colours <-
  list(
    default_male_colour = "blue",
    default_fema_colour = "coral",
    low_dose_poor_control_colour = "darkgreen",
    low_dose_good_control_colour = "green",
    high_dose_poor_control_colour = "darkred",
    high_dose_good_control_colour = "red"
  )
absolute_low_17ohp <- 10


absolute_low_androstenedione <- 1
absolute_high_17ohp <- 38


absolute_high_androstenedione <- 8
low_dose_hydro <- 8
high_dose_hydro <- 18


low_dose_max_hydro <- 15
high_dose_max_hydro <- 40
low_dose_fludro <- 100
list_of_my_ylims <- 
  list(
    my_ylim_weight = c(0,80),
    my_ylim_height = c(50,200),
    my_ylim_bmi = c(10,25),
    my_ylim_differences_weight = c(-10,10),
    my_ylim_differences_height = c(-5,5),
    my_ylim_differences_bmi = c(-5,5)
  )




list_of_bootstrap_patient_ids <-
  bootstrap_patient_ids(
    number_of_bootstraps = number_of_bootstraps,
    data_frame_with_both_sexes_refined_to_covariates_we_are_assessing =
      data_frame_with_both_sexes_refined_to_covariates_we_are_assessing
  )

data_and_covariates_and_directory <- 
  create_data_to_model_spline_interactions(
    data_frame_with_both_sexes = data_frame_with_both_sexes_refined_to_covariates_we_are_assessing,
    spline_df = spline_df,
    list_of_variables = list_of_variables,
    lower_age = lower_age,
    upper_age = upper_age)
save(list_of_bootstrap_patient_ids, 
     file = paste0(data_and_covariates_and_directory$sub_directory_to_save_plots, 
                   "/list_of_bootstrap_patient_ids.Rdata"))
save(data_and_covariates_and_directory, 
     file = paste0(data_and_covariates_and_directory$sub_directory_to_save_plots, 
                   "/data_and_covariates_and_directory.Rdata"))


sink(paste0(data_and_covariates_and_directory$sub_directory_to_save_plots, 
                   "/variables_and_example_values_in_models_in_this_folder.txt"))
cat(paste0(
  "Number of bootstraps = ",
  number_of_bootstraps,
  "\n",
  "spline degrees of freedom = ",
  spline_df,
  "\n",
  "list of variables = ",
  list_of_variables,
  "\n",
  "formula_string_random = ",
  formula_string_random,
  "\n",
  "absolute_low_17ohp = ",
  absolute_low_17ohp,
  "\n",
  "absolute_low_androstenedione = ",
  absolute_low_androstenedione,
  "\n",
  "absolute_high_17ohp = ",
  absolute_high_17ohp,
  "\n",
  "absolute_high_androstenedione = ",
  absolute_high_androstenedione,
  "\n",
  "low_dose_hydro = ",
  low_dose_hydro,
  "\n",
  "high_dose_hydro = ",
  high_dose_hydro,
  "\n",
  "low_dose_max_hydro = ",
  low_dose_max_hydro,
  "\n",
  "high_dose_max_hydro = ",
  high_dose_max_hydro,
  "\n",
  "high_dose_max_hydro = ",
  high_dose_max_hydro,
  "\n",
  "low_dose_fludro = ",
  low_dose_fludro,
  "\n",
  "list_of_my_ylims = ",
  list_of_my_ylims
  ))
sink()


data_and_spline_details <- 
  add_spline_basis_functions_to_data(
      data_to_model_both_sexes_complete = data_and_covariates_and_directory$data_to_model_both_sexes_complete, 
      
      spline_df = spline_df,
      list_of_variables = list_of_variables)
save(data_and_spline_details, 
     file = paste0(data_and_covariates_and_directory$sub_directory_to_save_plots, 
                   "/data_and_spline_details.Rdata"))


all_bootstrap_model_results <- 
  bootstrap_and_create_spline_models(
    data_to_model_both_sexes_complete = data_and_spline_details$data_to_model_both_sexes_complete,
    
    male_id_bootstrap_list = list_of_bootstrap_patient_ids$male_id_bootstrap_list,
    fema_id_bootstrap_list = list_of_bootstrap_patient_ids$fema_id_bootstrap_list,
    covariates_to_interact_with_spline = data_and_covariates_and_directory$covariates_to_interact_with_spline, 
    
    spline_df = spline_df,
    list_of_variables = list_of_variables,
    formula_string_random = formula_string_random, 
    lower_age = lower_age, 
    upper_age = upper_age, 
    sub_directory_to_save_plots = data_and_covariates_and_directory$sub_directory_to_save_plots
  )
save(all_bootstrap_model_results, 
     file = paste0(data_and_covariates_and_directory$sub_directory_to_save_plots, 
                   "/all_bootstrap_model_results.Rdata"))

create_all_model_fit_statistics(
  all_bootstrap_model_results=all_bootstrap_model_results
)




list_of_bootstrapped_example_patient_frames <-  
  calculate_examples_from_spline_models(
    sub_directory_to_save_plots = data_and_covariates_and_directory$sub_directory_to_save_plots,
    list_of_variables = list_of_variables,  
    list_of_models_male = all_bootstrap_model_results$male_model_results_all_bootstraps,
    list_of_models_fema = all_bootstrap_model_results$fema_model_results_all_bootstraps,
    absolute_boundary_knots_male = data_and_spline_details$spline_basis_data$absolute_boundary_knots_male,
    absolute_spline_knots_male = data_and_spline_details$spline_basis_data$absolute_spline_knots_male,
    absolute_spline_knots_fema = data_and_spline_details$spline_basis_data$absolute_spline_knots_fema,
    absolute_boundary_knots_fema = data_and_spline_details$spline_basis_data$absolute_boundary_knots_fema,
    lnpca_boundary_knots_male = data_and_spline_details$spline_basis_data$lnpca_boundary_knots_male,
    lnpca_spline_knots_male = data_and_spline_details$spline_basis_data$lnpca_spline_knots_male,
    lnpca_spline_knots_fema = data_and_spline_details$spline_basis_data$lnpca_spline_knots_fema,
    lnpca_boundary_knots_fema = data_and_spline_details$spline_basis_data$lnpca_boundary_knots_fema,
    absolute_low_17ohp = absolute_low_17ohp,
    absolute_low_androstenedione = absolute_low_androstenedione,  
    absolute_high_17ohp = absolute_high_17ohp,
    absolute_high_androstenedione = absolute_high_androstenedione,  
    low_dose_hydro = low_dose_hydro,
    high_dose_hydro = high_dose_hydro,
    low_dose_max_hydro = low_dose_max_hydro,
    high_dose_max_hydro = high_dose_max_hydro,  
    low_dose_fludro = low_dose_fludro
    ) 
save(list_of_bootstrapped_example_patient_frames, 
     file = paste0(data_and_covariates_and_directory$sub_directory_to_save_plots, 
                   "/list_of_bootstrapped_example_patient_frames.Rdata"))
a <- list_of_bootstrapped_example_patient_frames[[3]][[1]]
sum(is.na(a$height_full_formula_lnpca_z))

combined_bootstrapped_example_patients <- 
  combine_bootstrapped_example_patients(
      list_of_bootstrapped_example_patient_frames = list_of_bootstrapped_example_patient_frames)
save(combined_bootstrapped_example_patients, 
     file = paste0(data_and_covariates_and_directory$sub_directory_to_save_plots, 
                   "/combined_bootstrapped_example_patients.Rdata"))

#this contains two lists for us:
list_of_stacked_bootstrapped_example_patients <-
  combined_bootstrapped_example_patients$list_of_stacked_bootstrapped_example_patients
list_of_summaries_of_bootstrapped_example_patients <-
  combined_bootstrapped_example_patients$list_of_summaries_of_bootstrapped_example_patients


plot_each_line_bootstrapped_example_patients(
    list_of_stacked_bootstrapped_example_patients = combined_bootstrapped_example_patients$list_of_stacked_bootstrapped_example_patients,
    data_to_model_both_sexes_complete = data_and_covariates_and_directory$data_to_model_both_sexes_complete,
    list_of_models_male = all_bootstrap_model_results$male_model_results_all_bootstraps,
    list_of_models_fema = all_bootstrap_model_results$fema_model_results_all_bootstraps,
    sub_directory_to_save_plots = data_and_covariates_and_directory$sub_directory_to_save_plots,
    list_of_my_ylims = list_of_my_ylims,
    list_of_my_colours = list_of_my_colours
  )

plot_example_patients_with_ribbon_CI_shading(
    list_of_summaries_of_bootstrapped_example_patients = list_of_summaries_of_bootstrapped_example_patients,
    list_of_models_male = all_bootstrap_model_results$male_model_results_all_bootstraps,
    list_of_models_fema = all_bootstrap_model_results$fema_model_results_all_bootstraps,
    data_to_model_both_sexes_complete = data_and_spline_details$data_to_model_both_sexes_complete,
    sub_directory_to_save_plots = data_and_covariates_and_directory$sub_directory_to_save_plots,
    list_of_my_ylims = list_of_my_ylims,
    list_of_my_colours = list_of_my_colours
    ) 

list_of_each_bootstrap_replication_differences_frames <- 
  difference_bootstrapped_example_patients(
    list_of_bootstrapped_example_patient_frames=list_of_bootstrapped_example_patient_frames,
    list_of_variables = list_of_variables)
save(list_of_each_bootstrap_replication_differences_frames, 
     file = paste0(data_and_covariates_and_directory$sub_directory_to_save_plots, 
                   "/list_of_each_bootstrap_replication_differences_frames.Rdata"))

combined_bootstrapped_example_patient_differences <- 
  combine_bootstrapped_example_patient_differences(
    list_of_each_bootstrap_replication_differences_frames,
    list_of_variables = list_of_variables,
    additional_columns_to_exclude=c())#
save(combined_bootstrapped_example_patient_differences, 
     file = paste0(data_and_covariates_and_directory$sub_directory_to_save_plots, 
                   "/combined_bootstrapped_example_patient_differences.Rdata"))

list_of_stacked_bootstrapped_differences_frames <-
  combined_bootstrapped_example_patient_differences$list_of_stacked_bootstrapped_differences_frames
list_of_summary_bootstrapped_differences_frames <-
  combined_bootstrapped_example_patient_differences$list_of_summary_bootstrapped_differences_frames

plot_each_line_difference_between_example_patients(
    list_of_stacked_bootstrapped_differences_frames = list_of_stacked_bootstrapped_differences_frames,
    list_of_models_male = all_bootstrap_model_results$male_model_results_all_bootstraps,
    list_of_models_fema = all_bootstrap_model_results$fema_model_results_all_bootstraps,
    sub_directory_to_save_plots = data_and_covariates_and_directory$sub_directory_to_save_plots,
    list_of_my_ylims = list_of_my_ylims,
    list_of_my_colours = list_of_my_colours
)

plot_bootstrapped_difference_with_ribbon_CI_between_example_patients(
    list_of_summary_bootstrapped_differences_frames = list_of_summary_bootstrapped_differences_frames,
    list_of_models_male = all_bootstrap_model_results$male_model_results_all_bootstraps,
    list_of_models_fema = all_bootstrap_model_results$fema_model_results_all_bootstraps,
    sub_directory_to_save_plots = data_and_covariates_and_directory$sub_directory_to_save_plots,
    list_of_my_ylims = list_of_my_ylims,
    list_of_my_colours = list_of_my_colours
)

frame_of_adiposity_peaks_and_rebounds_for_each_bootstrap <- 
  get_bmi_peak_trough_for_each_bootstrap_and_example_for_specific_model(
    list_of_bootstrapped_example_patient_frames = list_of_bootstrapped_example_patient_frames,
    name_of_model= "calculated_bmi_full_formula_lnpca")
save(frame_of_adiposity_peaks_and_rebounds_for_each_bootstrap, 
     file = paste0(data_and_covariates_and_directory$sub_directory_to_save_plots, 
                   "/frame_of_adiposity_peaks_and_rebounds_for_each_bootstrap.Rdata"))

summary_of_bootstrapped_peak_trough_frame <-
  
  summarise_bootstrapped_peak_trough_frame(
    frame_of_adiposity_peaks_and_rebounds_for_each_bootstrap=frame_of_adiposity_peaks_and_rebounds_for_each_bootstrap
  )

save(summary_of_bootstrapped_peak_trough_frame, 
     file = paste0(data_and_covariates_and_directory$sub_directory_to_save_plots, 
                   "/summary_of_bootstrapped_peak_trough_frame.Rdata"))

write.csv(summary_of_bootstrapped_peak_trough_frame,
          paste0(data_and_covariates_and_directory$sub_directory_to_save_plots, 
                   "/summary_of_bootstrapped_peak_trough_frame.csv"),
          row.names = F)
```

```{r, function to bootstrap age and bmi at adiposity rebound by example patient}
calculate_bootstrap_differences_in_adiposity_rebound <- 
  function(frame_of_adiposity_peaks_and_rebounds_for_each_bootstrap){
    
      example_patient_names <- unique(frame_of_adiposity_peaks_and_rebounds_for_each_bootstrap$example_name)
      
      patient_pairs <- combn(example_patient_names, 2, simplify = FALSE)

      patient_pairs <- Filter(function(pair) {
        (grepl("male", pair[1]) && grepl("male", pair[2])) ||
          (grepl("fema", pair[1]) && grepl("fema", pair[2]))
      }, patient_pairs)
      
      
all_bootstrapped_patient_differences_in_adiposity_rebound <- data.frame()

for (each_bootstrap in 1:max(frame_of_adiposity_peaks_and_rebounds_for_each_bootstrap$bootstrap_number)) {

  if (each_bootstrap %% 50 == 0) {
    print(paste0("Processing bootstrap: ", each_bootstrap))
  }
  
  frame_of_rebounds_for_this_bootstrap <- 
    subset(frame_of_adiposity_peaks_and_rebounds_for_each_bootstrap, bootstrap_number == each_bootstrap)

  patient_differences_frame_this_bootstrap <- data.frame()

  for (this_pair in patient_pairs) {
    patient_1 <- this_pair[1]
    patient_2 <- this_pair[2]

    patient_1_row <- subset(frame_of_rebounds_for_this_bootstrap, example_name == patient_1)
    patient_2_row <- subset(frame_of_rebounds_for_this_bootstrap, example_name == patient_2)

    patient_1_minus_patient_2 <- patient_1_row
    
    numeric_cols <- 
      names(patient_1_minus_patient_2)[sapply(patient_1_minus_patient_2, is.numeric)]
    
    numeric_cols <- 
      setdiff(numeric_cols, c("bootstrap_number")) 

    patient_1_minus_patient_2[numeric_cols] <- patient_1_row[numeric_cols] - patient_2_row[numeric_cols]
    
    patient_1_minus_patient_2$example_name <- NULL

    colnames(patient_1_minus_patient_2) <-
      paste0(colnames(patient_1_minus_patient_2), "_difference")

    patient_1_minus_patient_2$example_1 <-
      patient_1
    patient_1_minus_patient_2$example_2 <-
      patient_2
    
    patient_1_minus_patient_2$comparison <- paste0(patient_1, "_minus_", patient_2)
    
    patient_1_minus_patient_2$bootstrap_number <- each_bootstrap

    patient_differences_frame_this_bootstrap <- 
      rbind(patient_differences_frame_this_bootstrap, patient_1_minus_patient_2)
  }

  all_bootstrapped_patient_differences_in_adiposity_rebound <- 
    rbind(all_bootstrapped_patient_differences_in_adiposity_rebound, patient_differences_frame_this_bootstrap)
}
  return(all_bootstrapped_patient_differences_in_adiposity_rebound)
  }

all_bootstrapped_patient_differences_in_adiposity_rebound <-
  calculate_bootstrap_differences_in_adiposity_rebound(
    frame_of_adiposity_peaks_and_rebounds_for_each_bootstrap=
      frame_of_adiposity_peaks_and_rebounds_for_each_bootstrap)
```



```{r, create function to summarise the different bootstrap differences of adiposity rebound summarised_bootstrapped_patient_differences}

summarise_all_bootstrapped_patient_differences_in_adiposity_rebound <- function(all_bootstrapped_patient_differences_in_adiposity_rebound){
  
  bootstrapped_example_patient_differences <- all_bootstrapped_patient_differences_in_adiposity_rebound %>%
  group_by(comparison, example_1, example_2) %>%
  dplyr::summarise(
    age_at_adiposity_peak_difference_median = median(age_at_adiposity_peak_difference, na.rm = TRUE),
    age_at_adiposity_peak_difference_q2.5 = quantile(age_at_adiposity_peak_difference, 0.025, na.rm = TRUE),
    age_at_adiposity_peak_difference_q97.5 = quantile(age_at_adiposity_peak_difference, 0.975, na.rm = TRUE),
    bmi_at_adiposity_peak_difference_median = median(bmi_at_adiposity_peak_difference, na.rm = TRUE),
    bmi_at_adiposity_peak_difference_q2.5 = quantile(bmi_at_adiposity_peak_difference, 0.025, na.rm = TRUE),
    bmi_at_adiposity_peak_difference_q97.5 = quantile(bmi_at_adiposity_peak_difference, 0.975, na.rm = TRUE),
    bmi_z_at_adiposity_peak_difference_median = median(bmi_z_at_adiposity_peak_difference, na.rm = TRUE),
    bmi_z_at_adiposity_peak_difference_q2.5 = quantile(bmi_z_at_adiposity_peak_difference, 0.025, na.rm = TRUE),
    bmi_z_at_adiposity_peak_difference_q97.5 = quantile(bmi_z_at_adiposity_peak_difference, 0.975, na.rm = TRUE),
    
    age_at_adiposity_rebound_difference_median = median(age_at_adiposity_rebound_difference, na.rm = TRUE),
    age_at_adiposity_rebound_difference_q2.5 = quantile(age_at_adiposity_rebound_difference, 0.025, na.rm = TRUE),
    age_at_adiposity_rebound_difference_q97.5 = quantile(age_at_adiposity_rebound_difference, 0.975, na.rm = TRUE),
    bmi_at_adiposity_rebound_difference_median = median(bmi_at_adiposity_rebound_difference, na.rm = TRUE),
    bmi_at_adiposity_rebound_difference_q2.5 = quantile(bmi_at_adiposity_rebound_difference, 0.025, na.rm = TRUE),
    bmi_at_adiposity_rebound_difference_q97.5 = quantile(bmi_at_adiposity_rebound_difference, 0.975, na.rm = TRUE),
    bmi_z_at_adiposity_rebound_difference_median = median(bmi_z_at_adiposity_rebound_difference, na.rm = TRUE),
    bmi_z_at_adiposity_rebound_difference_q2.5 = quantile(bmi_z_at_adiposity_rebound_difference, 0.025, na.rm = TRUE),
    bmi_z_at_adiposity_rebound_difference_q97.5 = quantile(bmi_z_at_adiposity_rebound_difference, 0.975, na.rm = TRUE)
    
  )
}


bootstrapped_example_patient_differences <-
  summarise_all_bootstrapped_patient_differences_in_adiposity_rebound(
    all_bootstrapped_patient_differences_in_adiposity_rebound=all_bootstrapped_patient_differences_in_adiposity_rebound)

write.csv(bootstrapped_example_patient_differences,
          paste0(data_and_covariates_and_directory$sub_directory_to_save_plots, 
                   "/bootstrapped_example_patient_differences.csv"),
          row.names = F)
```


```{r, visualising a fundamental spline and its basis components with traffic lights}
height_to_plot <- 5
width_to_plot <- 10

df <- list_of_bootstrapped_example_patient_frames[[1]][[1]]

df$linear <-  df$absolute_age /100
df$quadratic <-  (df$absolute_age)^2 /1000
df$cubic <-  (df$absolute_age)^3 / 10000

df$x2linear <- df$linear * -2
df$x2quadratic <- df$quadratic * -2
df$x2cubic <- df$cubic * -2

df$combined_cubic <-
  df$linear +
  df$quadratic +
  df$cubic
df$combined_cubic_1x2 <-
  df$x2linear +
  df$quadratic +
  df$cubic
df$combined_cubic_2x2 <-
  df$linear +
  df$x2quadratic +
  df$cubic
df$combined_cubic_3x2 <-
  df$linear +
  df$quadratic +
  df$x2cubic

dir.create("cubic_spline_explanation")  
ggsave(
  filename = paste0("cubic_a.png"),
  path = "cubic_spline_explanation",
  device = "png",
  width = width_to_plot,
  height = height_to_plot,
  plot = 

ggplot(
  data=df, 
    aes(x=absolute_age, y=combined_cubic)) +
  geom_hline(yintercept=0, linewidth=2, alpha=0.2) +
  geom_line(linewidth=2, aes(y=linear), colour="purple")+
  geom_line(linewidth=2, aes(y=quadratic), colour="orange")+
  geom_line(linewidth=2, aes(y=cubic), colour="red") + 
  coord_cartesian(ylim=c(-2,2)) +
  geom_line(linewidth=2.5, linetype="dashed") +
  themepowerpoint
)


ggsave(
  filename = paste0("cubic_b.png"),
  path = "cubic_spline_explanation",
  device = "png",
  width = width_to_plot,
  height = height_to_plot,
  plot = 

ggplot(
  data=df, 
    aes(x=absolute_age, y=combined_cubic_1x2)) +
  geom_hline(yintercept=0, linewidth=2, alpha=0.2) +
  geom_line(linewidth=2, aes(y=x2linear), colour="purple")+
  geom_line(linewidth=2, aes(y=quadratic), colour="orange")+
  geom_line(linewidth=2, aes(y=cubic), colour="red") + 
  coord_cartesian(ylim=c(-2,2)) +
  geom_line(linewidth=2.5, linetype="dashed") +
  themepowerpoint
)

ggsave(
  filename = paste0("cubic_c.png"),
  path = "cubic_spline_explanation",
  device = "png",
  width = width_to_plot,
  height = height_to_plot,
  plot = 

ggplot(
  data=df, 
    aes(x=absolute_age, y=combined_cubic_2x2)) +
  geom_hline(yintercept=0, linewidth=2, alpha=0.2) +
  geom_line(linewidth=2, aes(y=linear), colour="purple")+
  geom_line(linewidth=2, aes(y=x2quadratic), colour="orange")+
  geom_line(linewidth=2, aes(y=cubic), colour="red") + 
  coord_cartesian(ylim=c(-2,2)) +
  geom_line(linewidth=2.5, linetype="dashed") +
  themepowerpoint

)

ggsave(
  filename = paste0("cubic_d.png"),
  path = "cubic_spline_explanation",
  device = "png",
  width = width_to_plot,
  height = height_to_plot,
  plot = 

    
ggplot(
  data=df, 
    aes(x=absolute_age, y=combined_cubic_3x2)) +
  geom_hline(yintercept=0, linewidth=2, alpha=0.2) +
  geom_line(linewidth=2, aes(y=linear), colour="purple")+
  geom_line(linewidth=2, aes(y=quadratic), colour="orange")+
  geom_line(linewidth=2, aes(y=x2cubic), colour="red") + 
  coord_cartesian(ylim=c(-2,2)) +
  geom_line(linewidth=2.5, linetype="dashed") +
  themepowerpoint

)
```


```{r, visualising a fundamental spline and its basis components with traffic lights}
df$combined_spline_core <- 
  df$lnpca_spline_1 + 
  df$lnpca_spline_2 + 
  df$lnpca_spline_3

#multiply each spline by 2
df$x2lnpca_spline_1 <-
  df$lnpca_spline_1 * -2
df$x2lnpca_spline_2 <-
  df$lnpca_spline_2 * -2
df$x2lnpca_spline_3 <-
  df$lnpca_spline_3 * -2

#then combine our spline with 2x the other bits
df$combined_spline_1x2 <- 
  df$x2lnpca_spline_1 + 
  df$lnpca_spline_2 + 
  df$lnpca_spline_3
df$combined_spline_2x2 <- 
  df$lnpca_spline_1 + 
  df$x2lnpca_spline_2 + 
  df$lnpca_spline_3
df$combined_spline_3x2 <- 
  df$lnpca_spline_1 + 
  df$lnpca_spline_2 + 
  df$x2lnpca_spline_3

ggsave(
  filename = paste0("spline_a.png"),
  path = "cubic_spline_explanation",
  device = "png",
  width = width_to_plot,
  height = height_to_plot,
  plot = 

ggplot(
  data=df, 
    aes(x=absolute_age, y=combined_spline_core)) +
  geom_hline(yintercept=0, linewidth=2, alpha=0.2) +
  geom_line(linewidth=2, aes(y=lnpca_spline_1), colour="purple")+
  geom_line(linewidth=2, aes(y=lnpca_spline_2), colour="orange")+
  geom_line(linewidth=2, aes(y=lnpca_spline_3), colour="red") + 
  geom_line(linewidth=2.5, linetype="dashed") +
  coord_cartesian(ylim=c(-2,2)) +
  labs(x=NULL, y=NULL)+
  themepowerpoint
)

ggsave(
  filename = paste0("spline_b.png"),
  path = "cubic_spline_explanation",
  device = "png",
  width = width_to_plot,
  height = height_to_plot,
  plot = 

ggplot(
  data=df, 
    aes(x=absolute_age, y=combined_spline_1x2)) +
  geom_hline(yintercept=0, linewidth=2, alpha=0.2) +
  geom_line(linewidth=2, aes(y=x2lnpca_spline_1), colour="purple")+
  geom_line(linewidth=2, aes(y=lnpca_spline_2), colour="orange")+
  geom_line(linewidth=2, aes(y=lnpca_spline_3), colour="red") + 
  geom_line(linewidth=2.5, linetype="dashed") +
  coord_cartesian(ylim=c(-2,2)) +
  labs(x=NULL, y=NULL)+
  themepowerpoint
)

ggsave(
  filename = paste0("spline_c.png"),
  path = "cubic_spline_explanation",
  device = "png",
  width = width_to_plot,
  height = height_to_plot,
  plot = 

ggplot(
  data=df, 
    aes(x=absolute_age, y=combined_spline_2x2)) +
  geom_hline(yintercept=0, linewidth=2, alpha=0.2) +
  geom_line(linewidth=2, aes(y=lnpca_spline_1), colour="purple")+
  geom_line(linewidth=2, aes(y=x2lnpca_spline_2), colour="orange")+
  geom_line(linewidth=2, aes(y=lnpca_spline_3), colour="red") + 
  coord_cartesian(ylim=c(-2,2)) +
  geom_line(linewidth=2.5, linetype="dashed") +
  labs(x=NULL, y=NULL)+
  themepowerpoint
)

ggsave(
  filename = paste0("spline_d.png"),
  path = "cubic_spline_explanation",
  device = "png",
  width = width_to_plot,
  height = height_to_plot,
  plot = 

ggplot(
  data=df, 
    aes(x=absolute_age, y=combined_spline_3x2)) +
  geom_hline(yintercept=0, linewidth=2, alpha=0.2) +
  geom_line(linewidth=2, aes(y=lnpca_spline_1), colour="purple") +
  geom_line(linewidth=2, aes(y=lnpca_spline_2), colour="orange") +
  geom_line(linewidth=2, aes(y=x2lnpca_spline_3), colour="red")  + 
  coord_cartesian(ylim=c(-2,2)) +
  geom_line(linewidth=2.5, linetype="dashed") +
  labs(x=NULL, y=NULL)+
  themepowerpoint

)
```


```{r, relevant results for presentation}
function_to_report_example_metric_differences_at_specific_age <- function(age_to_report){
#colnames(list_of_summary_bootstrapped_differences_frames$low_dose_good_control_male_patient_minus_high_dose_poor_control_male_patient)

sink(paste0(data_and_covariates_and_directory$sub_directory_to_save_plots, 
                   "/example_metric_differences_at_age_", age_to_report, ".txt"), split=T)

print("Comparison of low dose good control minus high dose poor control")

#weight
cat(paste0("low_dose_good_control_male_patient_minus_high_dose_poor_control_male_patient Weight difference at ", age_to_report, ":\n"))
cat(round(subset(
  list_of_summary_bootstrapped_differences_frames$low_dose_good_control_male_patient_minus_high_dose_poor_control_male_patient,
  absolute_age==age_to_report)$
    dependent_weight_on_height_with_covariates_formula_lnpca_difference_median, digits=3))
cat (" (")
cat(round(subset(
  list_of_summary_bootstrapped_differences_frames$low_dose_good_control_male_patient_minus_high_dose_poor_control_male_patient, absolute_age==age_to_report)$dependent_weight_on_height_with_covariates_formula_lnpca_difference_p2.5, digits=3))
cat (" to ")
cat(round(subset(
  list_of_summary_bootstrapped_differences_frames$low_dose_good_control_male_patient_minus_high_dose_poor_control_male_patient, absolute_age==age_to_report)$dependent_weight_on_height_with_covariates_formula_lnpca_difference_p97.5, digits=3))
cat(")\n")

cat(paste0("low_dose_good_control_fema_patient_minus_high_dose_poor_control_fema_patient Weight difference at ", age_to_report, ":\n"))
cat(round(subset(
  list_of_summary_bootstrapped_differences_frames$low_dose_good_control_fema_patient_minus_high_dose_poor_control_fema_patient, absolute_age==age_to_report)$dependent_weight_on_height_with_covariates_formula_lnpca_difference_median, digits=3))
cat (" (")
cat(round(subset(
  list_of_summary_bootstrapped_differences_frames$low_dose_good_control_fema_patient_minus_high_dose_poor_control_fema_patient, absolute_age==age_to_report)$dependent_weight_on_height_with_covariates_formula_lnpca_difference_p2.5, digits=3))
cat (" to ")
cat(round(subset(
  list_of_summary_bootstrapped_differences_frames$low_dose_good_control_fema_patient_minus_high_dose_poor_control_fema_patient, absolute_age==age_to_report)$dependent_weight_on_height_with_covariates_formula_lnpca_difference_p97.5, digits=3))
cat(")\n\n")

#height
cat(paste0("low_dose_good_control_male_patient_minus_high_dose_poor_control_male_patient height difference at ", age_to_report, ":\n"))
cat(round(subset(
  list_of_summary_bootstrapped_differences_frames$low_dose_good_control_male_patient_minus_high_dose_poor_control_male_patient, absolute_age==age_to_report)$dependent_height_on_weight_with_covariates_formula_lnpca_difference_median, digits=3))
cat (" (")
cat(round(subset(
  list_of_summary_bootstrapped_differences_frames$low_dose_good_control_male_patient_minus_high_dose_poor_control_male_patient, absolute_age==age_to_report)$dependent_height_on_weight_with_covariates_formula_lnpca_difference_p2.5, digits=3))
cat (" to ")
cat(round(subset(
  list_of_summary_bootstrapped_differences_frames$low_dose_good_control_male_patient_minus_high_dose_poor_control_male_patient, absolute_age==age_to_report)$dependent_height_on_weight_with_covariates_formula_lnpca_difference_p97.5, digits=3))
cat(")\n")

cat(paste0("low_dose_good_control_fema_patient_minus_high_dose_poor_control_fema_patient height difference at ", age_to_report, ":\n"))
cat(round(subset(
  list_of_summary_bootstrapped_differences_frames$low_dose_good_control_fema_patient_minus_high_dose_poor_control_fema_patient, absolute_age==age_to_report)$dependent_height_on_weight_with_covariates_formula_lnpca_difference_median, digits=3))
cat (" (")
cat(round(subset(
  list_of_summary_bootstrapped_differences_frames$low_dose_good_control_fema_patient_minus_high_dose_poor_control_fema_patient, absolute_age==age_to_report)$dependent_height_on_weight_with_covariates_formula_lnpca_difference_p2.5, digits=3))
cat (" to ")
cat(round(subset(
  list_of_summary_bootstrapped_differences_frames$low_dose_good_control_fema_patient_minus_high_dose_poor_control_fema_patient, absolute_age==age_to_report)$dependent_height_on_weight_with_covariates_formula_lnpca_difference_p97.5, digits=3))
cat(")\n\n")



#BMI
cat(paste0("low_dose_good_control_male_patient_minus_high_dose_poor_control_male_patient calculated bmi difference at ", age_to_report, ":\n"))
cat(round(subset(
  list_of_summary_bootstrapped_differences_frames$low_dose_good_control_male_patient_minus_high_dose_poor_control_male_patient, absolute_age==age_to_report)$calculated_bmi_full_formula_lnpca_difference_median, digits=3))
cat (" (")
cat(round(subset(
  list_of_summary_bootstrapped_differences_frames$low_dose_good_control_male_patient_minus_high_dose_poor_control_male_patient, absolute_age==age_to_report)$calculated_bmi_full_formula_lnpca_difference_p2.5, digits=3))
cat (" to ")
cat(round(subset(
  list_of_summary_bootstrapped_differences_frames$low_dose_good_control_male_patient_minus_high_dose_poor_control_male_patient, absolute_age==age_to_report)$calculated_bmi_full_formula_lnpca_difference_p97.5, digits=3))
cat(")\n")

cat(paste0("low_dose_good_control_fema_patient_minus_high_dose_poor_control_fema_patient calculated bmi difference at ", age_to_report, ":\n"))
cat(round(subset(
  list_of_summary_bootstrapped_differences_frames$low_dose_good_control_fema_patient_minus_high_dose_poor_control_fema_patient, absolute_age==age_to_report)$calculated_bmi_full_formula_lnpca_difference_median, digits=3))
cat (" (")
cat(round(subset(
  list_of_summary_bootstrapped_differences_frames$low_dose_good_control_fema_patient_minus_high_dose_poor_control_fema_patient, absolute_age==age_to_report)$calculated_bmi_full_formula_lnpca_difference_p2.5, digits=3))
cat (" to ")
cat(round(subset(
  list_of_summary_bootstrapped_differences_frames$low_dose_good_control_fema_patient_minus_high_dose_poor_control_fema_patient, absolute_age==age_to_report)$calculated_bmi_full_formula_lnpca_difference_p97.5, digits=3))
cat(")\n\n")




print("##################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################")

print("Comparison of low dose good control minus high dose good control")

#weight
cat(paste0("low_dose_good_control_male_patient_minus_high_dose_good_control_male_patient Weight difference at ", age_to_report, ":\n"))
cat(round(subset(
  list_of_summary_bootstrapped_differences_frames$low_dose_good_control_male_patient_minus_high_dose_good_control_male_patient,
  absolute_age==age_to_report)$
    dependent_weight_on_height_with_covariates_formula_lnpca_difference_median, digits=3))
cat (" (")
cat(round(subset(
  list_of_summary_bootstrapped_differences_frames$low_dose_good_control_male_patient_minus_high_dose_good_control_male_patient, absolute_age==age_to_report)$dependent_weight_on_height_with_covariates_formula_lnpca_difference_p2.5, digits=3))
cat (" to ")
cat(round(subset(
  list_of_summary_bootstrapped_differences_frames$low_dose_good_control_male_patient_minus_high_dose_good_control_male_patient, absolute_age==age_to_report)$dependent_weight_on_height_with_covariates_formula_lnpca_difference_p97.5, digits=3))
cat(")\n")

cat(paste0("low_dose_good_control_fema_patient_minus_high_dose_good_control_fema_patient Weight difference at ", age_to_report, ":\n"))
cat(round(subset(
  list_of_summary_bootstrapped_differences_frames$low_dose_good_control_fema_patient_minus_high_dose_good_control_fema_patient, absolute_age==age_to_report)$dependent_weight_on_height_with_covariates_formula_lnpca_difference_median, digits=3))
cat (" (")
cat(round(subset(
  list_of_summary_bootstrapped_differences_frames$low_dose_good_control_fema_patient_minus_high_dose_good_control_fema_patient, absolute_age==age_to_report)$dependent_weight_on_height_with_covariates_formula_lnpca_difference_p2.5, digits=3))
cat (" to ")
cat(round(subset(
  list_of_summary_bootstrapped_differences_frames$low_dose_good_control_fema_patient_minus_high_dose_good_control_fema_patient, absolute_age==age_to_report)$dependent_weight_on_height_with_covariates_formula_lnpca_difference_p97.5, digits=3))
cat(")\n\n")

#height
cat(paste0("low_dose_good_control_male_patient_minus_high_dose_good_control_male_patient height difference at ", age_to_report, ":\n"))
cat(round(subset(
  list_of_summary_bootstrapped_differences_frames$low_dose_good_control_male_patient_minus_high_dose_good_control_male_patient, absolute_age==age_to_report)$dependent_height_on_weight_with_covariates_formula_lnpca_difference_median, digits=3))
cat (" (")
cat(round(subset(
  list_of_summary_bootstrapped_differences_frames$low_dose_good_control_male_patient_minus_high_dose_good_control_male_patient, absolute_age==age_to_report)$dependent_height_on_weight_with_covariates_formula_lnpca_difference_p2.5, digits=3))
cat (" to ")
cat(round(subset(
  list_of_summary_bootstrapped_differences_frames$low_dose_good_control_male_patient_minus_high_dose_good_control_male_patient, absolute_age==age_to_report)$dependent_height_on_weight_with_covariates_formula_lnpca_difference_p97.5, digits=3))
cat(")\n")

cat(paste0("low_dose_good_control_fema_patient_minus_high_dose_good_control_fema_patient height difference at ", age_to_report, ":\n"))
cat(round(subset(
  list_of_summary_bootstrapped_differences_frames$low_dose_good_control_fema_patient_minus_high_dose_good_control_fema_patient, absolute_age==age_to_report)$dependent_height_on_weight_with_covariates_formula_lnpca_difference_median, digits=3))
cat (" (")
cat(round(subset(
  list_of_summary_bootstrapped_differences_frames$low_dose_good_control_fema_patient_minus_high_dose_good_control_fema_patient, absolute_age==age_to_report)$dependent_height_on_weight_with_covariates_formula_lnpca_difference_p2.5, digits=3))
cat (" to ")
cat(round(subset(
  list_of_summary_bootstrapped_differences_frames$low_dose_good_control_fema_patient_minus_high_dose_good_control_fema_patient, absolute_age==age_to_report)$dependent_height_on_weight_with_covariates_formula_lnpca_difference_p97.5, digits=3))
cat(")\n\n")



#BMI
cat(paste0("low_dose_good_control_male_patient_minus_high_dose_good_control_male_patient calculated bmi difference at ", age_to_report, ":\n"))
cat(round(subset(
  list_of_summary_bootstrapped_differences_frames$low_dose_good_control_male_patient_minus_high_dose_good_control_male_patient, absolute_age==age_to_report)$calculated_bmi_full_formula_lnpca_difference_median, digits=3))
cat (" (")
cat(round(subset(
  list_of_summary_bootstrapped_differences_frames$low_dose_good_control_male_patient_minus_high_dose_good_control_male_patient, absolute_age==age_to_report)$calculated_bmi_full_formula_lnpca_difference_p2.5, digits=3))
cat (" to ")
cat(round(subset(
  list_of_summary_bootstrapped_differences_frames$low_dose_good_control_male_patient_minus_high_dose_good_control_male_patient, absolute_age==age_to_report)$calculated_bmi_full_formula_lnpca_difference_p97.5, digits=3))
cat(")\n")

cat(paste0("low_dose_good_control_fema_patient_minus_high_dose_good_control_fema_patient calculated bmi difference at ", age_to_report, ":\n"))
cat(round(subset(
  list_of_summary_bootstrapped_differences_frames$low_dose_good_control_fema_patient_minus_high_dose_good_control_fema_patient, absolute_age==age_to_report)$calculated_bmi_full_formula_lnpca_difference_median, digits=3))
cat (" (")
cat(round(subset(
  list_of_summary_bootstrapped_differences_frames$low_dose_good_control_fema_patient_minus_high_dose_good_control_fema_patient, absolute_age==age_to_report)$calculated_bmi_full_formula_lnpca_difference_p2.5, digits=3))
cat (" to ")
cat(round(subset(
  list_of_summary_bootstrapped_differences_frames$low_dose_good_control_fema_patient_minus_high_dose_good_control_fema_patient, absolute_age==age_to_report)$calculated_bmi_full_formula_lnpca_difference_p97.5, digits=3))
cat(")\n\n")



sink()
}#end the function
```



```{r, use function to report example metrics at different ages}
function_to_report_example_metric_differences_at_specific_age(age_to_report=8)
function_to_report_example_metric_differences_at_specific_age(age_to_report=12)
```

```{r, report the range of heights where we have a statistically significant different between low dose good and high dose poor}
comparison_to_report <- "low_dose_good_control_male_patient_minus_high_dose_poor_control_male_patient"
#remove values less than age 1 as these are noisy
frame_to_review <-
  subset(
    list_of_summary_bootstrapped_differences_frames[[comparison_to_report]], 
    age_to_use>1)

frame_to_review$interpolated_height_difference_significant <-
  ifelse(
    frame_to_review$interpolated_height_difference_p2.5 > 0 &
    frame_to_review$interpolated_height_difference_p97.5 > 0 |
    frame_to_review$interpolated_height_difference_p2.5 < 0 &
    frame_to_review$interpolated_height_difference_p97.5 < 0,
    1,
    0
  )

significant_height_difference_frame <-
  subset(frame_to_review, interpolated_height_difference_significant==1)

sink(paste0(data_and_covariates_and_directory$sub_directory_to_save_plots, 
            "/Ages_where_male_height_difference.txt"), 
     split = T)
cat(comparison_to_report)
cat("\n minimum age = ")
cat(min(significant_height_difference_frame$age_to_use))
cat("\n maximum age = ")
cat(max(significant_height_difference_frame$age_to_use))
sink()
```




```{r, male bootstrapped coefficients for all formulae}
male_bootstrapped_fixed_coefficients <- data.frame(NULL)
male_bootstrapped_BIC <- data.frame(NULL)
male_bootstrapped_R2 <- data.frame(NULL)

for (each_formula in names(all_bootstrap_model_results$male_model_results_all_bootstraps[[1]])) {
print(each_formula)
  for (each_bootstrap in 1:number_of_bootstraps) {

  model_R2 <-  tryCatch({
      data.frame(R2=all_bootstrap_model_results$
    male_model_results_all_bootstraps[[each_bootstrap]][[each_formula]]$R2,
      bootstrap_number = each_bootstrap,
      formula = each_formula)
  }, error = function(e) {
  warning(paste("Skipping bootstrap", each_bootstrap, "formula", each_formula, ":", e$message))
  return(NULL)
})   
  
  model_BIC <-  tryCatch({
      data.frame(BIC=all_bootstrap_model_results$
    male_model_results_all_bootstraps[[each_bootstrap]][[each_formula]]$BIC,
      bootstrap_number = each_bootstrap,
      formula = each_formula)
  }, error = function(e) {
  warning(paste("Skipping bootstrap", each_bootstrap, "formula", each_formula, ":", e$message))
  return(NULL)
})   
    
    fixed_coefficients <- tryCatch({
      
  all_bootstrap_model_results$
    male_model_results_all_bootstraps[[each_bootstrap]][[each_formula]]$
    model$
    coefficients$
    fixed

    }, error = function(e) {
  warning(paste("Skipping bootstrap", each_bootstrap, "formula", each_formula, ":", e$message))
  return(NULL)
})
if (is.null(fixed_coefficients)) next
    fixed_coefficients_frame_to_add <- data.frame(
      names_of_fixed_coefficients = names(fixed_coefficients),
      numbers_of_fixed_coefficients = as.numeric(fixed_coefficients),
      bootstrap_number = each_bootstrap,
      formula = each_formula
    )

    male_bootstrapped_fixed_coefficients <-
      rbind(male_bootstrapped_fixed_coefficients, fixed_coefficients_frame_to_add)
    male_bootstrapped_BIC <-
      rbind(male_bootstrapped_BIC, model_BIC)
  male_bootstrapped_R2 <-
      rbind(male_bootstrapped_R2, model_R2)
  }
}

summary_of_male_bootstrapped_fixed_coefficients <-
  male_bootstrapped_fixed_coefficients %>%
  group_by(formula, names_of_fixed_coefficients) %>%
  dplyr::summarise(
    mean  = mean(numbers_of_fixed_coefficients),
    sem   = sd(numbers_of_fixed_coefficients),
    lower = quantile(numbers_of_fixed_coefficients, 0.025, na.rm = TRUE),
    upper = quantile(numbers_of_fixed_coefficients, 0.975, na.rm = TRUE),
    .groups = "drop"
  )

summary_of_male_bootstrapped_R2 <-
  male_bootstrapped_R2 %>%
  group_by(formula) %>%
  dplyr::summarise(
    mean_marginal  = mean(R2.R2m),
    sem_marginal   = sd(R2.R2m),
    lower_marginal = quantile(R2.R2m, 0.025, na.rm = TRUE),
    upper_marginal = quantile(R2.R2m, 0.975, na.rm = TRUE),
    mean_conditional  = mean(R2.R2c),
    sem_conditional   = sd(R2.R2c),
    lower_conditional = quantile(R2.R2c, 0.025, na.rm = TRUE),
    upper_conditional = quantile(R2.R2c, 0.975, na.rm = TRUE),
    .groups = "drop"
  )

summary_of_male_bootstrapped_BIC <-
  male_bootstrapped_BIC %>%
  group_by(formula) %>%
  dplyr::summarise(
    mean  = mean(BIC),
    sem   = sd(BIC),
    lower = quantile(BIC, 0.025, na.rm = TRUE),
    upper = quantile(BIC, 0.975, na.rm = TRUE),
    .groups = "drop"
  )

write.csv(summary_of_male_bootstrapped_fixed_coefficients,
          paste0(data_and_covariates_and_directory$sub_directory_to_save_plots, 
                   "/summary_of_male_bootstrapped_fixed_coefficients.csv"),
          row.names = F)
```

```{r, fema bootstrapped coefficients for all formulae}
fema_bootstrapped_fixed_coefficients <- data.frame(NULL)
fema_bootstrapped_BIC <- data.frame(NULL)
fema_bootstrapped_R2 <- data.frame(NULL)

for (each_formula in names(all_bootstrap_model_results$fema_model_results_all_bootstraps[[1]])) {
print(each_formula)
  for (each_bootstrap in 1:number_of_bootstraps) {

  model_R2 <-  tryCatch({
      data.frame(R2=all_bootstrap_model_results$
    fema_model_results_all_bootstraps[[each_bootstrap]][[each_formula]]$R2,
      bootstrap_number = each_bootstrap,
      formula = each_formula)
  }, error = function(e) {
  warning(paste("Skipping bootstrap", each_bootstrap, "formula", each_formula, ":", e$message))
  return(NULL)
})   
  
  model_BIC <-  tryCatch({
      data.frame(BIC=all_bootstrap_model_results$
    fema_model_results_all_bootstraps[[each_bootstrap]][[each_formula]]$BIC,
      bootstrap_number = each_bootstrap,
      formula = each_formula)
  }, error = function(e) {
  warning(paste("Skipping bootstrap", each_bootstrap, "formula", each_formula, ":", e$message))
  return(NULL)
})   
    
    fixed_coefficients <- tryCatch({
      
  all_bootstrap_model_results$
    fema_model_results_all_bootstraps[[each_bootstrap]][[each_formula]]$
    model$
    coefficients$
    fixed

    }, error = function(e) {
  warning(paste("Skipping bootstrap", each_bootstrap, "formula", each_formula, ":", e$message))
  return(NULL)
})
if (is.null(fixed_coefficients)) next
    fixed_coefficients_frame_to_add <- data.frame(
      names_of_fixed_coefficients = names(fixed_coefficients),
      numbers_of_fixed_coefficients = as.numeric(fixed_coefficients),
      bootstrap_number = each_bootstrap,
      formula = each_formula
    )

    fema_bootstrapped_fixed_coefficients <-
      rbind(fema_bootstrapped_fixed_coefficients, fixed_coefficients_frame_to_add)
    fema_bootstrapped_BIC <-
      rbind(fema_bootstrapped_BIC, model_BIC)
  fema_bootstrapped_R2 <-
      rbind(fema_bootstrapped_R2, model_R2)
  }
}

summary_of_fema_bootstrapped_fixed_coefficients <-
  fema_bootstrapped_fixed_coefficients %>%
  group_by(formula, names_of_fixed_coefficients) %>%
  dplyr::summarise(
    mean  = mean(numbers_of_fixed_coefficients),
    sem   = sd(numbers_of_fixed_coefficients),
    lower = quantile(numbers_of_fixed_coefficients, 0.025, na.rm = TRUE),
    upper = quantile(numbers_of_fixed_coefficients, 0.975, na.rm = TRUE),
    .groups = "drop"
  )

summary_of_fema_bootstrapped_R2 <-
  fema_bootstrapped_R2 %>%
  group_by(formula) %>%
  dplyr::summarise(
    mean_marginal  = mean(R2.R2m),
    sem_marginal   = sd(R2.R2m),
    lower_marginal = quantile(R2.R2m, 0.025, na.rm = TRUE),
    upper_marginal = quantile(R2.R2m, 0.975, na.rm = TRUE),
    mean_conditional  = mean(R2.R2c),
    sem_conditional   = sd(R2.R2c),
    lower_conditional = quantile(R2.R2c, 0.025, na.rm = TRUE),
    upper_conditional = quantile(R2.R2c, 0.975, na.rm = TRUE),
    .groups = "drop"
  )

summary_of_fema_bootstrapped_BIC <-
  fema_bootstrapped_BIC %>%
  group_by(formula) %>%
  dplyr::summarise(
    mean  = mean(BIC),
    sem   = sd(BIC),
    lower = quantile(BIC, 0.025, na.rm = TRUE),
    upper = quantile(BIC, 0.975, na.rm = TRUE),
    .groups = "drop"
  )

write.csv(summary_of_fema_bootstrapped_fixed_coefficients,
          paste0(data_and_covariates_and_directory$sub_directory_to_save_plots, 
                   "/summary_of_fema_bootstrapped_fixed_coefficients.csv"),
          row.names = F)
```

```{r, bootstrap and summarise all of the random intercepts for male}
male_random_intercepts_centre_frame <- data.frame(NULL)
male_random_intercepts_id_frame <- data.frame(NULL)

for (each_formula in 
     c(
       "dependent_height_on_weight_with_covariates_formula_lnpca",
       "dependent_weight_on_height_with_covariates_formula_lnpca"
     )) {
print(each_formula)
  for (each_bootstrap in 1:number_of_bootstraps) {

      # Print progress every 50 bootstraps
  if (each_bootstrap %% 50 == 0) {
    print(paste0("Processing bootstrap: ", each_bootstrap))
  }
    random_intercepts_male <- tryCatch({
      
  all_bootstrap_model_results$
    male_model_results_all_bootstraps[[each_bootstrap]][[each_formula]]$
    model$
    coefficients$
    random

    }, error = function(e) {
  warning(paste("Skipping bootstrap", each_bootstrap, "formula", each_formula, ":", e$message))
  return(NULL)
})
    
if (is.null(random_intercepts_male)) next
    
    male_random_intercepts_centre_frame_to_add <- data.frame(
      names_of_random_intercepts_male = rownames(random_intercepts_male$Centre.Name...Centre),
      numbers_of_random_intercepts_male = as.numeric(random_intercepts_male$Centre.Name...Centre),
      bootstrap_number = each_bootstrap,
      formula = each_formula,
      type_of_intercept = "centre"
    )

    male_random_intercepts_id_frame_to_add <- data.frame(
      names_of_random_intercepts_male = gsub("^[^/]*?/", "", rownames(random_intercepts_male$id)),
      numbers_of_random_intercepts_male = as.numeric(random_intercepts_male$id),
      bootstrap_number = each_bootstrap,
      formula = each_formula,
      type_of_intercept = "id"
    )

    male_random_intercepts_centre_frame <-
      rbind(male_random_intercepts_centre_frame, male_random_intercepts_centre_frame_to_add)
    male_random_intercepts_id_frame <-
      rbind(male_random_intercepts_id_frame, male_random_intercepts_id_frame_to_add)
  }
}

summary_of_male_bootstrapped_centre_random_intercepts <-
  male_random_intercepts_centre_frame %>%
  group_by(formula, names_of_random_intercepts_male, type_of_intercept) %>%
  dplyr::summarise(
    mean_of_this_intercept  = mean(numbers_of_random_intercepts_male),
    sem_of_this_intercept   = sd(numbers_of_random_intercepts_male),
    lower_of_this_intercept = quantile(numbers_of_random_intercepts_male, 0.025, na.rm = TRUE),
    upper_of_this_intercept = quantile(numbers_of_random_intercepts_male, 0.975, na.rm = TRUE),
    .groups = "drop"
  )

summary_of_male_bootstrapped_id_random_intercepts <-
  male_random_intercepts_id_frame %>%
  group_by(formula, names_of_random_intercepts_male, type_of_intercept) %>%
  dplyr::summarise(
    mean_of_this_intercept  = mean(numbers_of_random_intercepts_male),
    sem_of_this_intercept   = sd(numbers_of_random_intercepts_male),
    lower_of_this_intercept = quantile(numbers_of_random_intercepts_male, 0.025, na.rm = TRUE),
    upper_of_this_intercept = quantile(numbers_of_random_intercepts_male, 0.975, na.rm = TRUE),
    .groups = "drop"
  )

summary_of_all_male_random_intercepts <-
  rbind(
    summary_of_male_bootstrapped_centre_random_intercepts,
    summary_of_male_bootstrapped_id_random_intercepts
  )

bootstrapped_variation_of_male_random_intercepts <-
  summary_of_all_male_random_intercepts %>%
  group_by(formula, type_of_intercept) %>%
    dplyr::summarise(
    mean  = mean(mean_of_this_intercept),
    sd    = sd(mean_of_this_intercept, na.rm=T),
    lower = quantile(mean_of_this_intercept, 0.025, na.rm = TRUE),
    upper = quantile(mean_of_this_intercept, 0.975, na.rm = TRUE),
    .groups = "drop"
  )

write.csv(
  bootstrapped_variation_of_male_random_intercepts, 
    paste0(
      data_and_covariates_and_directory$sub_directory_to_save_plots, 
      "/bootstrapped_variation_of_male_random_intercepts.csv"), 
  row.names = F)
```

```{r, bootstrap and summarise all of the random intercepts for fema}
fema_random_intercepts_centre_frame <- data.frame(NULL)
fema_random_intercepts_id_frame <- data.frame(NULL)

for (each_formula in 
     c(
       "dependent_height_on_weight_with_covariates_formula_lnpca",
       "dependent_weight_on_height_with_covariates_formula_lnpca"
     )) {
print(each_formula)
  for (each_bootstrap in 1:number_of_bootstraps) {

  if (each_bootstrap %% 50 == 0) {
    print(paste0("Processing bootstrap: ", each_bootstrap))
  }
    random_intercepts_fema <- tryCatch({
      
  all_bootstrap_model_results$
    fema_model_results_all_bootstraps[[each_bootstrap]][[each_formula]]$
    model$
    coefficients$
    random

    }, error = function(e) {
  warning(paste("Skipping bootstrap", each_bootstrap, "formula", each_formula, ":", e$message))
  return(NULL)
})
    
if (is.null(random_intercepts_fema)) next
    
    fema_random_intercepts_centre_frame_to_add <- data.frame(
      names_of_random_intercepts_fema = rownames(random_intercepts_fema$Centre.Name...Centre),
      numbers_of_random_intercepts_fema = as.numeric(random_intercepts_fema$Centre.Name...Centre),
      bootstrap_number = each_bootstrap,
      formula = each_formula,
      type_of_intercept = "centre"
    )

    fema_random_intercepts_id_frame_to_add <- data.frame(
      names_of_random_intercepts_fema = gsub("^[^/]*?/", "", rownames(random_intercepts_fema$id)),
      numbers_of_random_intercepts_fema = as.numeric(random_intercepts_fema$id),
      bootstrap_number = each_bootstrap,
      formula = each_formula,
      type_of_intercept = "id"
    )

    fema_random_intercepts_centre_frame <-
      rbind(fema_random_intercepts_centre_frame, fema_random_intercepts_centre_frame_to_add)
    fema_random_intercepts_id_frame <-
      rbind(fema_random_intercepts_id_frame, fema_random_intercepts_id_frame_to_add)
  }
}

summary_of_fema_bootstrapped_centre_random_intercepts <-
  fema_random_intercepts_centre_frame %>%
  group_by(formula, names_of_random_intercepts_fema, type_of_intercept) %>%
  dplyr::summarise(
    mean_of_this_intercept  = mean(numbers_of_random_intercepts_fema),
    sem_of_this_intercept   = sd(numbers_of_random_intercepts_fema),
    lower_of_this_intercept = quantile(numbers_of_random_intercepts_fema, 0.025, na.rm = TRUE),
    upper_of_this_intercept = quantile(numbers_of_random_intercepts_fema, 0.975, na.rm = TRUE),
    .groups = "drop"
  )

summary_of_fema_bootstrapped_id_random_intercepts <-
  fema_random_intercepts_id_frame %>%
  group_by(formula, names_of_random_intercepts_fema, type_of_intercept) %>%
  dplyr::summarise(
    mean_of_this_intercept  = mean(numbers_of_random_intercepts_fema),
    sem_of_this_intercept   = sd(numbers_of_random_intercepts_fema),
    lower_of_this_intercept = quantile(numbers_of_random_intercepts_fema, 0.025, na.rm = TRUE),
    upper_of_this_intercept = quantile(numbers_of_random_intercepts_fema, 0.975, na.rm = TRUE),
    .groups = "drop"
  )

summary_of_all_fema_random_intercepts <-
  rbind(
    summary_of_fema_bootstrapped_centre_random_intercepts,
    summary_of_fema_bootstrapped_id_random_intercepts
  )

bootstrapped_variation_of_fema_random_intercepts <-
  summary_of_all_fema_random_intercepts %>%
  group_by(formula, type_of_intercept) %>%
    dplyr::summarise(
    mean  = mean(mean_of_this_intercept),
    sd    = sd(mean_of_this_intercept, na.rm=T),
    lower = quantile(mean_of_this_intercept, 0.025, na.rm = TRUE),
    upper = quantile(mean_of_this_intercept, 0.975, na.rm = TRUE),
    .groups = "drop"
  )

write.csv(
  bootstrapped_variation_of_fema_random_intercepts, 
    paste0(
      data_and_covariates_and_directory$sub_directory_to_save_plots, 
      "/bootstrapped_variation_of_fema_random_intercepts.csv"), 
  row.names = F)
```



```{r, let us make the tables for male and fema coefficients for the models we report firstly height on weight}

for (decimal_places in c(1,2,3)){

for (model_to_report in c(
  "dependent_height_on_weight_with_covariates_formula_lnpca"
  )){

for (sex in c("male", "fema")){

model_coefficients <- 
  subset(
    summary_of_male_bootstrapped_fixed_coefficients, 
    formula==model_to_report)

training_data <-
  subset(
    data_and_covariates_and_directory$data_to_model_both_sexes_complete,
    sex_1_for_M_2_for_F==1)

model_R2 <-
  subset(summary_of_male_bootstrapped_R2, formula==model_to_report)

sd_of_random_intercept_for_centre <- HERE I AM

model_BIC <-
  subset(summary_of_male_bootstrapped_BIC, formula==model_to_report)


if (sex=="fema"){

model_coefficients <- 
  subset(summary_of_fema_bootstrapped_fixed_coefficients, 
         formula==model_to_report)

training_data <-
  subset(data_and_covariates_and_directory$data_to_model_both_sexes_complete,
         sex_1_for_M_2_for_F==2)

model_R2 <-
  subset(summary_of_fema_bootstrapped_R2, formula==model_to_report)

model_BIC <-
  subset(summary_of_fema_bootstrapped_BIC, formula==model_to_report)
}


clean_frame <-  
  
data.frame(
  
  Number_of_patients =
    length(unique(training_data$id)),
  
  Number_of_visits = 
    length(training_data$id),

  Intercept = 
    paste0(
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="(Intercept)")$mean,
        digits=decimal_places
        ),
      " \n(",
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="(Intercept)")$lower,
        digits=decimal_places
        ),
      " to ", 
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="(Intercept)")$upper,
        digits=decimal_places
        ),
      ")"
    ),
    
  ln_age_spline_basis_1 = 
    paste0(
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_1")$mean,
        digits=decimal_places
        ),
      " \n(",
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_1")$lower,
        digits=decimal_places
        ),
      " to ", 
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_1")$upper,
        digits=decimal_places
        ),
      ")"
    ),

  ln_age_spline_basis_2 = 
    paste0(
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_2")$mean,
        digits=decimal_places
        ),
      " \n(",
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_2")$lower,
        digits=decimal_places
        ),
      " to ", 
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_2")$upper,
        digits=decimal_places
        ),
      ")"
    ),

  ln_age_spline_basis_3 = 
    paste0(
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_3")$mean,
        digits=decimal_places
        ),
      " \n(",
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_3")$lower,
        digits=decimal_places
        ),
      " to ", 
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_3")$upper,
        digits=decimal_places
        ),
      ")"
    ),
    Weight = 
    paste0(
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="interpolated_weight")$mean,
        digits=decimal_places
        ),
      " \n(",
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="interpolated_weight")$lower,
        digits=decimal_places
        ),
      " to ", 
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="interpolated_weight")$upper,
        digits=decimal_places
        ),
      ")"
    ),

      Weight___ln_age_spline_basis_1 = 
    paste0(
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_1:interpolated_weight")$mean,
        digits=decimal_places
        ),
      " \n(",
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_1:interpolated_weight")$lower,
        digits=decimal_places
        ),
      " to ", 
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_1:interpolated_weight")$upper,
        digits=decimal_places
        ),
      ")"
    ),

      Weight___ln_age_spline_basis_2 = 
    paste0(
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_2:interpolated_weight")$mean,
        digits=decimal_places
        ),
      " \n(",
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_2:interpolated_weight")$lower,
        digits=decimal_places
        ),
      " to ", 
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_2:interpolated_weight")$upper,
        digits=decimal_places
        ),
      ")"
    ),

      Weight___ln_age_spline_basis_3 = 
    paste0(
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_3:interpolated_weight")$mean,
        digits=decimal_places
        ),
      " \n(",
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_3:interpolated_weight")$lower,
        digits=decimal_places
        ),
      " to ", 
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_3:interpolated_weight")$upper,
        digits=decimal_places
        ),
      ")"
    ),

    ln_17ohp = 
    paste0(
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="ln_converted_17OHP_nmol_l_imputed_units_0")$mean,
        digits=decimal_places
        ),
      " \n(",
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="ln_converted_17OHP_nmol_l_imputed_units_0")$lower,
        digits=decimal_places
        ),
      " to ", 
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="ln_converted_17OHP_nmol_l_imputed_units_0")$upper,
        digits=decimal_places
        ),
      ")"
    ),  

        ln_17OHP___ln_age_spline_basis_1 = 
    paste0(
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_1:ln_converted_17OHP_nmol_l_imputed_units_0")$mean,
        digits=decimal_places
        ),
      " \n(",
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_1:ln_converted_17OHP_nmol_l_imputed_units_0")$lower,
        digits=decimal_places
        ),
      " to ", 
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_1:ln_converted_17OHP_nmol_l_imputed_units_0")$upper,
        digits=decimal_places
        ),
      ")"
    ),

        ln_17OHP___ln_age_spline_basis_2 = 
    paste0(
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_2:ln_converted_17OHP_nmol_l_imputed_units_0")$mean,
        digits=decimal_places
        ),
      " \n(",
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_2:ln_converted_17OHP_nmol_l_imputed_units_0")$lower,
        digits=decimal_places
        ),
      " to ", 
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_2:ln_converted_17OHP_nmol_l_imputed_units_0")$upper,
        digits=decimal_places
        ),
      ")"
    ),

        ln_17OHP___ln_age_spline_basis_3 = 
    paste0(
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_3:ln_converted_17OHP_nmol_l_imputed_units_0")$mean,
        digits=decimal_places
        ),
      " \n(",
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_3:ln_converted_17OHP_nmol_l_imputed_units_0")$lower,
        digits=decimal_places
        ),
      " to ", 
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_3:ln_converted_17OHP_nmol_l_imputed_units_0")$upper,
        digits=decimal_places
        ),
      ")"
    ),



    hydrocortisone_equivalent = 
    paste0(
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="total_daily_hydrocortisone_equivalent_at_visit_carried_to_use")$mean,
        digits=decimal_places
        ),
      " \n(",
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="total_daily_hydrocortisone_equivalent_at_visit_carried_to_use")$lower,
        digits=decimal_places
        ),
      " to ", 
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="total_daily_hydrocortisone_equivalent_at_visit_carried_to_use")$upper,
        digits=decimal_places
        ),
      ")"
    ),  

        hydrocortisone_equivalent___ln_age_spline_basis_1 = 
    paste0(
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="total_daily_hydrocortisone_equivalent_at_visit_carried_to_use:lnpca_spline_1")$mean,
        digits=decimal_places
        ),
      " \n(",
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="total_daily_hydrocortisone_equivalent_at_visit_carried_to_use:lnpca_spline_1")$lower,
        digits=decimal_places
        ),
      " to ", 
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="total_daily_hydrocortisone_equivalent_at_visit_carried_to_use:lnpca_spline_1")$upper,
        digits=decimal_places
        ),
      ")"
    ),

        hydrocortisone_equivalent___ln_age_spline_basis_2 = 
    paste0(
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="total_daily_hydrocortisone_equivalent_at_visit_carried_to_use:lnpca_spline_2")$mean,
        digits=decimal_places
        ),
      " \n(",
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="total_daily_hydrocortisone_equivalent_at_visit_carried_to_use:lnpca_spline_2")$lower,
        digits=decimal_places
        ),
      " to ", 
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="total_daily_hydrocortisone_equivalent_at_visit_carried_to_use:lnpca_spline_2")$upper,
        digits=decimal_places
        ),
      ")"
    ),

        hydrocortisone_equivalent___ln_age_spline_basis_3 = 
    paste0(
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="total_daily_hydrocortisone_equivalent_at_visit_carried_to_use:lnpca_spline_3")$mean,
        digits=decimal_places
        ),
      " \n(",
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="total_daily_hydrocortisone_equivalent_at_visit_carried_to_use:lnpca_spline_3")$lower,
        digits=decimal_places
        ),
      " to ", 
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="total_daily_hydrocortisone_equivalent_at_visit_carried_to_use:lnpca_spline_3")$upper,
        digits=decimal_places
        ),
      ")"
    ),


    fludrocortisone = 
    paste0(
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="total_daily_fludro_dose_with_zero_carried_to_use")$mean,
        digits=decimal_places
        ),
      " \n(",
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="total_daily_fludro_dose_with_zero_carried_to_use")$lower,
        digits=decimal_places
        ),
      " to ", 
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="total_daily_fludro_dose_with_zero_carried_to_use")$upper,
        digits=decimal_places
        ),
      ")"
    ),  

        fludrocortisone___ln_age_spline_basis_1 = 
    paste0(
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_1:total_daily_fludro_dose_with_zero_carried_to_use")$mean,
        digits=decimal_places
        ),
      " \n(",
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_1:total_daily_fludro_dose_with_zero_carried_to_use")$lower,
        digits=decimal_places
        ),
      " to ", 
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_1:total_daily_fludro_dose_with_zero_carried_to_use")$upper,
        digits=decimal_places
        ),
      ")"
    ),

        fludrocortisone___ln_age_spline_basis_2 = 
    paste0(
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_2:total_daily_fludro_dose_with_zero_carried_to_use")$mean,
        digits=decimal_places
        ),
      " \n(",
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_2:total_daily_fludro_dose_with_zero_carried_to_use")$lower,
        digits=decimal_places
        ),
      " to ", 
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_2:total_daily_fludro_dose_with_zero_carried_to_use")$upper,
        digits=decimal_places
        ),
      ")"
    ),

        fludrocortisone___ln_age_spline_basis_3 = 
    paste0(
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_3:total_daily_fludro_dose_with_zero_carried_to_use")$mean,
        digits=decimal_places
        ),
      " \n(",
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_3:total_daily_fludro_dose_with_zero_carried_to_use")$lower,
        digits=decimal_places
        ),
      " to ", 
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_3:total_daily_fludro_dose_with_zero_carried_to_use")$upper,
        digits=decimal_places
        ),
      ")"
    ),

    marginal_R2 = 
    paste0(
      round(
        model_R2$mean_marginal,
        digits=decimal_places),
      " \n(",
      round(
        model_R2$lower_marginal,
        digits=decimal_places),
      " to ", 
      round(
        model_R2$upper_marginal,
        digits=decimal_places),
      ")"
    ),


    conditional_R2 = 
    paste0(
      round(
        model_R2$mean_conditional,
        digits=decimal_places),
      " \n(",
      round(
        model_R2$lower_conditional,
        digits=decimal_places),
      " to ", 
      round(
        model_R2$upper_conditional,
        digits=decimal_places),
      ")"
    ),

    BIC = 
    paste0(
      round(
        model_BIC$mean,
        digits=decimal_places),
      " \n(",
      round(
        model_BIC$lower,
        digits=decimal_places),
      " to ", 
      round(
        model_BIC$upper,
        digits=decimal_places),
      ")"
    )
      


)

transposed_frame <- 
  rownames_to_column(as.data.frame(t(clean_frame)), var = "Model_coefficient")

#make the estimate column sex appropriate
names(
  transposed_frame)[
    names(
      transposed_frame) == 
      "V1"] <- 
  paste0("Estimate_", sex, "\n(95% CI)")

if(sex=="male"){
  combined_transposed_frame <- transposed_frame
}

if(sex=="fema"){
  combined_transposed_frame <- 
    left_join(
      combined_transposed_frame, 
      transposed_frame, 
      by = join_by("Model_coefficient")
    )
}



}
  

combined_transposed_frame$Model_coefficient <-
  gsub(
    x=combined_transposed_frame$Model_coefficient,
    pattern="___",
    replacement=" : "
  )
combined_transposed_frame$Model_coefficient <-
  gsub(
    x=combined_transposed_frame$Model_coefficient,
    pattern="_",
    replacement=" "
  )


write.csv(
    combined_transposed_frame,
    file=paste0(
      data_and_covariates_and_directory$sub_directory_to_save_plots,
      "/",
      decimal_places, 
      "dp_", 
      model_to_report, 
      "_",
      "boostrapped_coefficients.csv")
)



ft <- flextable(combined_transposed_frame)
  
  ft <- ft %>%
    theme_vanilla() %>%
    fontsize(size = 8, part = "header") %>%
    fontsize(size = 6, part = "body") %>%
    align(align = "center", part = "header") %>%
    align(align = "center", part = "body") %>%  
    autofit()
  
  centered_paragraph <- fp_par(text.align = "center")
  
  doc <- read_docx() %>%
    body_add_flextable(ft) 
  
  print(doc, target = 
          file.path(
            paste0(
              data_and_covariates_and_directory$sub_directory_to_save_plots,
      "/",
       decimal_places, 
      "dp_", 
      model_to_report, 
      "_",
      "boostrapped_coefficients.docx")))

}
}
```

```{r, then a table for the models of weight on height}

decimal_places <- 3

for (model_to_report in c(
  "dependent_weight_on_height_with_covariates_formula_lnpca"
  )){

for (sex in c("male", "fema")){

model_coefficients <- 
  subset(
    summary_of_male_bootstrapped_fixed_coefficients, 
    formula==model_to_report)

training_data <-
  subset(
    data_and_covariates_and_directory$data_to_model_both_sexes_complete,
    sex_1_for_M_2_for_F==1)

model_R2 <-
  subset(summary_of_male_bootstrapped_R2, formula==model_to_report)

model_BIC <-
  subset(summary_of_male_bootstrapped_BIC, formula==model_to_report)


if (sex=="fema"){

model_coefficients <- 
  subset(summary_of_fema_bootstrapped_fixed_coefficients, 
         formula==model_to_report)

training_data <-
  subset(data_and_covariates_and_directory$data_to_model_both_sexes_complete,
         sex_1_for_M_2_for_F==2)

model_R2 <-
  subset(summary_of_fema_bootstrapped_R2, formula==model_to_report)

model_BIC <-
  subset(summary_of_fema_bootstrapped_BIC, formula==model_to_report)
}


clean_frame <-  
  
data.frame(
  
  Number_of_patients =
    length(unique(training_data$id)),
  
  Number_of_visits = 
    length(training_data$id),

  Intercept = 
    paste0(
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="(Intercept)")$mean,
        digits=decimal_places
        ),
      " \n(",
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="(Intercept)")$lower,
        digits=decimal_places
        ),
      " to ", 
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="(Intercept)")$upper,
        digits=decimal_places
        ),
      ")"
    ),
    
  ln_age_spline_basis_1 = 
    paste0(
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_1")$mean,
        digits=decimal_places
        ),
      " \n(",
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_1")$lower,
        digits=decimal_places
        ),
      " to ", 
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_1")$upper,
        digits=decimal_places
        ),
      ")"
    ),

  ln_age_spline_basis_2 = 
    paste0(
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_2")$mean,
        digits=decimal_places
        ),
      " \n(",
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_2")$lower,
        digits=decimal_places
        ),
      " to ", 
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_2")$upper,
        digits=decimal_places
        ),
      ")"
    ),

  ln_age_spline_basis_3 = 
    paste0(
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_3")$mean,
        digits=decimal_places
        ),
      " \n(",
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_3")$lower,
        digits=decimal_places
        ),
      " to ", 
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_3")$upper,
        digits=decimal_places
        ),
      ")"
    ),
    Height = 
    paste0(
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="interpolated_height")$mean,
        digits=decimal_places
        ),
      " \n(",
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="interpolated_height")$lower,
        digits=decimal_places
        ),
      " to ", 
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="interpolated_height")$upper,
        digits=decimal_places
        ),
      ")"
    ),

      Height___ln_age_spline_basis_1 = 
    paste0(
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_1:interpolated_height")$mean,
        digits=decimal_places
        ),
      " \n(",
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_1:interpolated_height")$lower,
        digits=decimal_places
        ),
      " to ", 
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_1:interpolated_height")$upper,
        digits=decimal_places
        ),
      ")"
    ),

      Height___ln_age_spline_basis_2 = 
    paste0(
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_2:interpolated_height")$mean,
        digits=decimal_places
        ),
      " \n(",
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_2:interpolated_height")$lower,
        digits=decimal_places
        ),
      " to ", 
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_2:interpolated_height")$upper,
        digits=decimal_places
        ),
      ")"
    ),

      Height___ln_age_spline_basis_3 = 
    paste0(
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_3:interpolated_height")$mean,
        digits=decimal_places
        ),
      " \n(",
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_3:interpolated_height")$lower,
        digits=decimal_places
        ),
      " to ", 
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_3:interpolated_height")$upper,
        digits=decimal_places
        ),
      ")"
    ),

    ln_17ohp = 
    paste0(
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="ln_converted_17OHP_nmol_l_imputed_units_0")$mean,
        digits=decimal_places
        ),
      " \n(",
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="ln_converted_17OHP_nmol_l_imputed_units_0")$lower,
        digits=decimal_places
        ),
      " to ", 
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="ln_converted_17OHP_nmol_l_imputed_units_0")$upper,
        digits=decimal_places
        ),
      ")"
    ),  

        ln_17OHP___ln_age_spline_basis_1 = 
    paste0(
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_1:ln_converted_17OHP_nmol_l_imputed_units_0")$mean,
        digits=decimal_places
        ),
      " \n(",
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_1:ln_converted_17OHP_nmol_l_imputed_units_0")$lower,
        digits=decimal_places
        ),
      " to ", 
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_1:ln_converted_17OHP_nmol_l_imputed_units_0")$upper,
        digits=decimal_places
        ),
      ")"
    ),

        ln_17OHP___ln_age_spline_basis_2 = 
    paste0(
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_2:ln_converted_17OHP_nmol_l_imputed_units_0")$mean,
        digits=decimal_places
        ),
      " \n(",
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_2:ln_converted_17OHP_nmol_l_imputed_units_0")$lower,
        digits=decimal_places
        ),
      " to ", 
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_2:ln_converted_17OHP_nmol_l_imputed_units_0")$upper,
        digits=decimal_places
        ),
      ")"
    ),

        ln_17OHP___ln_age_spline_basis_3 = 
    paste0(
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_3:ln_converted_17OHP_nmol_l_imputed_units_0")$mean,
        digits=decimal_places
        ),
      " \n(",
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_3:ln_converted_17OHP_nmol_l_imputed_units_0")$lower,
        digits=decimal_places
        ),
      " to ", 
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_3:ln_converted_17OHP_nmol_l_imputed_units_0")$upper,
        digits=decimal_places
        ),
      ")"
    ),



    hydrocortisone_equivalent = 
    paste0(
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="total_daily_hydrocortisone_equivalent_at_visit_carried_to_use")$mean,
        digits=decimal_places
        ),
      " \n(",
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="total_daily_hydrocortisone_equivalent_at_visit_carried_to_use")$lower,
        digits=decimal_places
        ),
      " to ", 
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="total_daily_hydrocortisone_equivalent_at_visit_carried_to_use")$upper,
        digits=decimal_places
        ),
      ")"
    ),  

        hydrocortisone_equivalent___ln_age_spline_basis_1 = 
    paste0(
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="total_daily_hydrocortisone_equivalent_at_visit_carried_to_use:lnpca_spline_1")$mean,
        digits=decimal_places
        ),
      " \n(",
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="total_daily_hydrocortisone_equivalent_at_visit_carried_to_use:lnpca_spline_1")$lower,
        digits=decimal_places
        ),
      " to ", 
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="total_daily_hydrocortisone_equivalent_at_visit_carried_to_use:lnpca_spline_1")$upper,
        digits=decimal_places
        ),
      ")"
    ),

        hydrocortisone_equivalent___ln_age_spline_basis_2 = 
    paste0(
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="total_daily_hydrocortisone_equivalent_at_visit_carried_to_use:lnpca_spline_2")$mean,
        digits=decimal_places
        ),
      " \n(",
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="total_daily_hydrocortisone_equivalent_at_visit_carried_to_use:lnpca_spline_2")$lower,
        digits=decimal_places
        ),
      " to ", 
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="total_daily_hydrocortisone_equivalent_at_visit_carried_to_use:lnpca_spline_2")$upper,
        digits=decimal_places
        ),
      ")"
    ),

        hydrocortisone_equivalent___ln_age_spline_basis_3 = 
    paste0(
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="total_daily_hydrocortisone_equivalent_at_visit_carried_to_use:lnpca_spline_3")$mean,
        digits=decimal_places
        ),
      " \n(",
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="total_daily_hydrocortisone_equivalent_at_visit_carried_to_use:lnpca_spline_3")$lower,
        digits=decimal_places
        ),
      " to ", 
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="total_daily_hydrocortisone_equivalent_at_visit_carried_to_use:lnpca_spline_3")$upper,
        digits=decimal_places
        ),
      ")"
    ),


    fludrocortisone = 
    paste0(
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="total_daily_fludro_dose_with_zero_carried_to_use")$mean,
        digits=decimal_places
        ),
      " \n(",
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="total_daily_fludro_dose_with_zero_carried_to_use")$lower,
        digits=decimal_places
        ),
      " to ", 
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="total_daily_fludro_dose_with_zero_carried_to_use")$upper,
        digits=decimal_places
        ),
      ")"
    ),  

        fludrocortisone___ln_age_spline_basis_1 = 
    paste0(
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_1:total_daily_fludro_dose_with_zero_carried_to_use")$mean,
        digits=decimal_places
        ),
      " \n(",
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_1:total_daily_fludro_dose_with_zero_carried_to_use")$lower,
        digits=decimal_places
        ),
      " to ", 
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_1:total_daily_fludro_dose_with_zero_carried_to_use")$upper,
        digits=decimal_places
        ),
      ")"
    ),

        fludrocortisone___ln_age_spline_basis_2 = 
    paste0(
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_2:total_daily_fludro_dose_with_zero_carried_to_use")$mean,
        digits=decimal_places
        ),
      " \n(",
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_2:total_daily_fludro_dose_with_zero_carried_to_use")$lower,
        digits=decimal_places
        ),
      " to ", 
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_2:total_daily_fludro_dose_with_zero_carried_to_use")$upper,
        digits=decimal_places
        ),
      ")"
    ),

        fludrocortisone___ln_age_spline_basis_3 = 
    paste0(
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_3:total_daily_fludro_dose_with_zero_carried_to_use")$mean,
        digits=decimal_places
        ),
      " \n(",
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_3:total_daily_fludro_dose_with_zero_carried_to_use")$lower,
        digits=decimal_places
        ),
      " to ", 
      round(
        subset(model_coefficients, names_of_fixed_coefficients=="lnpca_spline_3:total_daily_fludro_dose_with_zero_carried_to_use")$upper,
        digits=decimal_places
        ),
      ")"
    ),

    marginal_R2 = 
    paste0(
      round(
        model_R2$mean_marginal,
        digits=decimal_places),
      " \n(",
      round(
        model_R2$lower_marginal,
        digits=decimal_places),
      " to ", 
      round(
        model_R2$upper_marginal,
        digits=decimal_places),
      ")"
    ),


    conditional_R2 = 
    paste0(
      round(
        model_R2$mean_conditional,
        digits=decimal_places),
      " \n(",
      round(
        model_R2$lower_conditional,
        digits=decimal_places),
      " to ", 
      round(
        model_R2$upper_conditional,
        digits=decimal_places),
      ")"
    ),

    BIC = 
    paste0(
      round(
        model_BIC$mean,
        digits=decimal_places),
      " \n(",
      round(
        model_BIC$lower,
        digits=decimal_places),
      " to ", 
      round(
        model_BIC$upper,
        digits=decimal_places),
      ")"
    )
      


)

transposed_frame <- 
  rownames_to_column(as.data.frame(t(clean_frame)), var = "Model_coefficient")

names(
  transposed_frame)[
    names(
      transposed_frame) == 
      "V1"] <- 
  paste0("Estimate_", sex, "\n(95% CI)")

if(sex=="male"){
  combined_transposed_frame <- transposed_frame
}

if(sex=="fema"){
  combined_transposed_frame <- 
    left_join(
      combined_transposed_frame, 
      transposed_frame, 
      by = join_by("Model_coefficient")
    )
}



}
  

combined_transposed_frame$Model_coefficient <-
  gsub(
    x=combined_transposed_frame$Model_coefficient,
    pattern="___",
    replacement=" : "
  )
combined_transposed_frame$Model_coefficient <-
  gsub(
    x=combined_transposed_frame$Model_coefficient,
    pattern="_",
    replacement=" "
  )


write.csv(
    combined_transposed_frame,
    file=paste0(
      data_and_covariates_and_directory$sub_directory_to_save_plots,
      "/",
      decimal_places, 
      "dp_", 
      model_to_report, 
      "_",
      "boostrapped_coefficients.csv")
)



ft <- flextable(combined_transposed_frame)
  
  ft <- ft %>%
    theme_vanilla() %>%
    fontsize(size = 8, part = "header") %>%
    fontsize(size = 6, part = "body") %>%
    align(align = "center", part = "header") %>%
    align(align = "center", part = "body") %>%  
    autofit()
  
  centered_paragraph <- fp_par(text.align = "center")
  
  doc <- read_docx() %>%
    body_add_flextable(ft) 
  
  print(doc, target = 
          file.path(
            paste0(
              data_and_covariates_and_directory$sub_directory_to_save_plots,
      "/",
       decimal_places, 
      "dp_", 
      model_to_report, 
      "_",
      "boostrapped_coefficients.docx")))

}
```

```{r, make a table of example patient metrics at specific age}


example_patient_metrics_at_specific_age <- data.frame()

for (i in 1:length(list_of_summaries_of_bootstrapped_example_patients)){

example_patient_name <-
  names(list_of_summaries_of_bootstrapped_example_patients[i])

df <- list_of_summaries_of_bootstrapped_example_patients[[i]]
decimal_places <- 2
age_to_extract <- 8
age_months <- age_to_extract / 12
sex_code <- ifelse(
  grepl(x=example_patient_name, pattern="male"), 1, 2
)

df_age <- subset(df, age_to_use==age_to_extract)





example_patient_row <-
  
data.frame(
  height_at_age_=
    paste0(
      round(
        df_age$dependent_height_on_weight_with_covariates_formula_lnpca_median,
        digits=decimal_places
      ),
      " \n(",
      round(
        df_age$dependent_height_on_weight_with_covariates_formula_lnpca_p2.5,
        digits=decimal_places
      ),
      " to ",
       round(
        df_age$dependent_height_on_weight_with_covariates_formula_lnpca_p97.5,
        digits=decimal_places
      ),
      ")"
    ),
  
  height_z___score_at_age_ =
    paste0(
      round(
        df_age$height_full_formula_lnpca_z_median,
        digits=decimal_places
      ),
      " \n(",
      round(
        df_age$height_full_formula_lnpca_z_p2.5,
        digits=decimal_places
      ),
      " to ",
       round(
        df_age$height_full_formula_lnpca_z_p97.5,
        digits=decimal_places
      ),
      ")"
    ),
  
  weight_at_age_=
      paste0(
      round(
        df_age$dependent_weight_on_height_with_covariates_formula_lnpca_median,
        digits=decimal_places
      ),
      " \n(",
      round(
        df_age$dependent_weight_on_height_with_covariates_formula_lnpca_p2.5,
        digits=decimal_places
      ),
      " to ",
       round(
        df_age$dependent_weight_on_height_with_covariates_formula_lnpca_p97.5,
        digits=decimal_places
      ),
      ")"
    ),

  weight_z___score_at_age_ =
    paste0(
      round(
        df_age$weight_full_formula_lnpca_z_median,
        digits=decimal_places
      ),
      " \n(",
      round(
        df_age$weight_full_formula_lnpca_z_p2.5,
        digits=decimal_places
      ),
      " to ",
       round(
        df_age$weight_full_formula_lnpca_z_p97.5,
        digits=decimal_places
      ),
      ")"
    ),
  
  
  bmi_at_age_=
    paste0(
      round(
        df_age$calculated_bmi_full_formula_lnpca_median,
        digits=decimal_places
      ),
      " \n(",
      round(
        df_age$calculated_bmi_full_formula_lnpca_p2.5,
        digits=decimal_places
      ),
      " to ",
       round(
        df_age$calculated_bmi_full_formula_lnpca_p97.5,
        digits=decimal_places
      ),
      ")"
    ),

  bmi_z___score_at_age_ =
    paste0(
      round(
        df_age$calculated_bmi_full_formula_lnpca_z_median,
        digits=decimal_places
      ),
      " \n(",
      round(
        df_age$calculated_bmi_full_formula_lnpca_z_p2.5,
        digits=decimal_places
      ),
      " to ",
       round(
        df_age$calculated_bmi_full_formula_lnpca_z_p97.5,
        digits=decimal_places
      ),
      ")"
    )
  
)

colnames(example_patient_row) <-
  gsub(colnames(example_patient_row),
       pattern="at_age_",
       replacement=paste0("at_age_", age_to_extract))

rownames(example_patient_row) <- example_patient_name

example_patient_metrics_at_specific_age <- rbind(example_patient_metrics_at_specific_age, example_patient_row)

}

example_patient_metrics_at_specific_age <- as.data.frame(t(example_patient_metrics_at_specific_age))

write.csv(
  x=example_patient_metrics_at_specific_age,
  file=paste0(
    data_and_covariates_and_directory$sub_directory_to_save_plots, 
    "/example_patient_metrics_at_age_", 
    age_to_extract, 
    ".csv")
)



```

```{r, make a table of example patient age and bmi and bmi z at adiposity rebound}
example_patient_adiposity_rebound_metrics <- data.frame(NULL)

for (i in 1:length(list_of_summaries_of_bootstrapped_example_patients)){

example_patient_name <-
  names(list_of_summaries_of_bootstrapped_example_patients[i])

row_of_bootstrapped_adiposity_rebound <-
  subset(
    summary_of_bootstrapped_peak_trough_frame, example_name==example_patient_name
  )

adiposity_rebound_example_patient_row <- 
  
data.frame(
  age_at_adiposity_rebound =
    paste0(
      round(
        row_of_bootstrapped_adiposity_rebound$age_at_adiposity_rebound_median,
        digits=decimal_places
      ),
      " \n(",
      round(
        row_of_bootstrapped_adiposity_rebound$age_at_adiposity_rebound_q2.5,
        digits=decimal_places
      ),
      " to ",
       round(
        row_of_bootstrapped_adiposity_rebound$age_at_adiposity_rebound_q97.5,
        digits=decimal_places
      ),
      ")"
    ),

    bmi_at_adiposity_rebound =
    paste0(
      round(
        row_of_bootstrapped_adiposity_rebound$bmi_at_adiposity_rebound_median,
        digits=decimal_places
      ),
      " \n(",
      round(
        row_of_bootstrapped_adiposity_rebound$bmi_at_adiposity_rebound_q2.5,
        digits=decimal_places
      ),
      " to ",
       round(
        row_of_bootstrapped_adiposity_rebound$bmi_at_adiposity_rebound_q97.5,
        digits=decimal_places
      ),
      ")"
    ),

    bmi_z_at_adiposity_rebound =
    paste0(
      round(
        row_of_bootstrapped_adiposity_rebound$bmi_z_at_adiposity_rebound_median,
        digits=decimal_places
      ),
      " \n(",
      round(
        row_of_bootstrapped_adiposity_rebound$bmi_z_at_adiposity_rebound_q2.5,
        digits=decimal_places
      ),
      " to ",
       round(
        row_of_bootstrapped_adiposity_rebound$bmi_z_at_adiposity_rebound_q97.5,
        digits=decimal_places
      ),
      ")"
    )
  
)

rownames(adiposity_rebound_example_patient_row) <- example_patient_name

example_patient_adiposity_rebound_metrics <- 
  rbind(example_patient_adiposity_rebound_metrics, adiposity_rebound_example_patient_row)

} 


example_patient_adiposity_rebound_metrics <- as.data.frame(t(example_patient_adiposity_rebound_metrics))

write.csv(
  x=example_patient_adiposity_rebound_metrics,
  file=paste0(
    data_and_covariates_and_directory$sub_directory_to_save_plots, 
    "/example_patient_adiposity_rebound_metrics", 
    ".csv")
)
```

```{r, create a blank plot with shading to chop into a legend in illustrator}
shading_data <- data.frame(
  x = c(0, 20),
  low_dose_poor_control_low_y = c(1, 1),
  low_dose_poor_control_mid_y = c(3, 3),
  low_dose_poor_control_high_y = c(5, 5),
  low_dose_good_control_low_y = c(7, 7),
  low_dose_good_control_mid_y = c(9, 9),
  low_dose_good_control_high_y = c(11, 11),
  high_dose_poor_control_low_y = c(13, 13),
  high_dose_poor_control_mid_y = c(15, 15),
  high_dose_poor_control_high_y = c(17, 17),
  high_dose_good_control_low_y = c(19, 19),
  high_dose_good_control_mid_y = c(21, 21),
  high_dose_good_control_high_y = c(23, 23),
  no_dose_male_default_low_y = c(25, 25),
  no_dose_male_default_mid_y = c(27, 27),
  no_dose_male_default_high_y = c(29, 29),
  no_dose_fema_default_low_y = c(31, 31),
  no_dose_fema_default_mid_y = c(33, 33),
  no_dose_fema_default_high_y = c(35, 35),
  male_point = c(37, 37),
  fema_point = c(37, 37)
)
   

    shading_plot_for_key_in_illustrator <- 
      ggplot(data=shading_data) +

      geom_ribbon(
        aes(x = x, ymin = low_dose_poor_control_low_y, ymax = low_dose_poor_control_high_y),
        fill = list_of_my_colours$low_dose_poor_control_colour,
        alpha = 0.2
        ) +

      geom_ribbon(
        aes(x = x, ymin = low_dose_good_control_low_y, ymax = low_dose_good_control_high_y),
        fill = list_of_my_colours$low_dose_good_control_colour,
        alpha = 0.2
        ) +

      geom_ribbon(
        aes(x = x, ymin = high_dose_poor_control_low_y, ymax = high_dose_poor_control_high_y),
        fill = list_of_my_colours$high_dose_poor_control_colour,
        alpha = 0.2
        ) +

      geom_ribbon(
        aes(x = x, ymin = high_dose_good_control_low_y, ymax = high_dose_good_control_high_y),
        fill = list_of_my_colours$high_dose_good_control_colour,
        alpha = 0.2
        ) +

      geom_ribbon(
        aes(x = x, ymin = no_dose_male_default_low_y, ymax = no_dose_male_default_high_y),
        fill = list_of_my_colours$default_male_colour,
        alpha = 0.2
        ) +

      geom_ribbon(
        aes(x = x, ymin = no_dose_fema_default_low_y, ymax = no_dose_fema_default_high_y),
        fill = list_of_my_colours$default_fema_colour,
        alpha = 0.2
        ) +

      geom_line(
        aes(x = x, y = low_dose_poor_control_mid_y), 
        alpha = 0.5, 
        colour = list_of_my_colours$low_dose_poor_control_colour) +
      
      geom_line(
        aes(x = x, y = low_dose_good_control_mid_y), 
        alpha = 0.5, 
        colour = list_of_my_colours$low_dose_good_control_colour) +
      

      geom_line(
        aes(x = x, y = high_dose_poor_control_mid_y), 
        alpha = 0.5, 
        colour = list_of_my_colours$high_dose_poor_control_colour) +
      
      geom_line(
        aes(x = x, y = high_dose_good_control_mid_y), 
        alpha = 0.5, 
        colour = list_of_my_colours$high_dose_good_control_colour) +
      
      geom_line(
        aes(x = x, y = no_dose_male_default_mid_y), 
        alpha = 0.5, 
        colour = list_of_my_colours$default_male_colour) +
      
      geom_line(
        aes(x = x, y = no_dose_fema_default_mid_y), 
        alpha = 0.5, 
        colour = list_of_my_colours$default_fema_colour) +
      
      geom_point(
        aes(x = 5, y = male_point), 
        alpha = 0.4, 
        colour = list_of_my_colours$default_male_colour) +
      
      geom_point(
        aes(x = 15, y = fema_point), 
        alpha = 0.4, 
        colour = list_of_my_colours$default_fema_colour) +
      
      coord_cartesian(
        xlim = c(0, 18), 
        ylim = c(0, 60)
        ) +
      
      theme(
  panel.background = element_rect(fill = "white", colour = NA),
        panel.grid = element_blank()      
      )
    
    shading_plot_for_key_in_illustrator
    
        
    ggsave(
      filename = paste0("shading_plot_for_key_in_illustrator", ".png"),   
      path = data_and_covariates_and_directory$sub_directory_to_save_plots, 
  
      plot = shading_plot_for_key_in_illustrator,
      width = 6, 
      height = 6, 
      dpi = 300
    )
```



