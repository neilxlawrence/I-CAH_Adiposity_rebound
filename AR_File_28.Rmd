
```{r, load software packages}
rm(list = ls())

#take the working directory otherwise, which should work every time?
if(!exists("location_of_main_folder")){
  location_of_main_folder <- 
    getwd()
}
#paste the name of our functions folder into the path name
location_of_functions_folder <-
  paste0(location_of_main_folder, "/ar_functions_folder/")

#load the function that loads all the libraries and sources
source(paste0(location_of_functions_folder, "load_ar_libraries_and_sources_function.R"))

#paste together the location of the data files - we don't load in the first file, but we need this location for the end
location_of_data_files <-
  paste0(location_of_main_folder, "/ar_data_files_to_load/")

#run the function, pointing it towards the functions folder
load_ar_libraries_and_sources_function(
  location_of_functions_folder=location_of_functions_folder,
  location_of_data_files=location_of_data_files
)

load_ar_files_function(previous_file_name = "file_21",
  parent_directory = location_of_data_files,
  list_of_data_frames_to_load=list("ar_data"))


load_ar_files_function(previous_file_name = "file_24",
  parent_directory = location_of_data_files,
  list_of_data_frames_to_load=list(
    "male_random_effects_weight_metrics",
    "fema_random_effects_weight_metrics"
    ))

load_ar_files_function(previous_file_name = "file_26",
  parent_directory = location_of_data_files,
  list_of_data_frames_to_load=list(
    "male_random_effects_height_metrics",
    "fema_random_effects_height_metrics"
    ))

```


```{r, define our optimum restrictions manually and extract all of our frames relating to the model with those restrictions for each of both_sexes male and fema}
suffix_of_optimum_bmi_model_restrictions <- #note that we save this suffix for use when we join into the main file
  "_bmi_sitar_min_visits_6_min_age_0.2_max_age_7_df_3"
#then create each one through pasting
name_of_optimum_bmi_model_restrictions_male <-
  paste0("male", suffix_of_optimum_bmi_model_restrictions)
name_of_optimum_bmi_model_restrictions_fema <-
  paste0("fema", suffix_of_optimum_bmi_model_restrictions)
name_of_optimum_bmi_model_restrictions_both_sexes <-
  paste0("both_sexes", suffix_of_optimum_bmi_model_restrictions)

```

```{r}
default_male_colour <- "blue"
default_fema_colour <- "coral"
```


```{r, load our sitar model frames for male}
load(   
     file = paste0("ar_data_files_to_load/list_of_male_sitar_models_bmi.Rdata"))
load(   
     file = paste0("ar_data_files_to_load/list_of_male_overall_fixed_effects_bmi.Rdata"))
load(   
     file = paste0("ar_data_files_to_load/list_of_male_random_effects_bmi.Rdata"))
load(   
     file = paste0("ar_data_files_to_load/list_of_male_patient_data_with_sitar_predictions_bmi.Rdata"))
load(   
     file = paste0("ar_data_files_to_load/list_of_male_individual_patient_random_effects_for_curves_bmi.Rdata"))
load(   
     file = paste0("ar_data_files_to_load/list_of_male_fitting_results_bmi.Rdata"))
load(   
     file = paste0("ar_data_files_to_load/list_of_male_error_messages_bmi.Rdata"))
```


```{r, extract our optimum fits for male from the lists}
male_sitar_model <-
  list_of_male_sitar_models_bmi[[name_of_optimum_bmi_model_restrictions_male]]
male_overall_fixed_effects_bmi <-
  list_of_male_overall_fixed_effects_bmi[[name_of_optimum_bmi_model_restrictions_male]]
male_random_effects_bmi <-
  list_of_male_random_effects_bmi[[name_of_optimum_bmi_model_restrictions_male]]
male_patient_data_with_sitar_predictions_bmi <-
  list_of_male_patient_data_with_sitar_predictions_bmi[[name_of_optimum_bmi_model_restrictions_male]]
male_individual_patient_random_effects_for_curves_bmi <-
  list_of_male_individual_patient_random_effects_for_curves_bmi[[name_of_optimum_bmi_model_restrictions_male]]
male_fitting_results_bmi <-
  list_of_male_fitting_results_bmi[[name_of_optimum_bmi_model_restrictions_male]]
male_error_messages_bmi <-
  list_of_male_error_messages_bmi[[name_of_optimum_bmi_model_restrictions_male]]

```

```{r, extract the spline basis function from the male model}
summary(male_sitar_model)
sink("str.text")
str(male_sitar_model)
sink()
male_sitar_model$ns$terms
male_sitar_model$ns$terms
male_sitar_model$ns$terms[[2]]

ns(2, knots = c(`33.33333%` = -0.240970184687664, `66.66667%` = 0.392378522561007
), Bound = c(-1.35645340181585, 0.928988641355438))
```

```{r, extract the spline basis for male and formulate table for sitar model}
# Get the predvars attribute
predvars <- attr(male_sitar_model$ns$terms, "predvars")

# Extract knots and boundary knots
# Extract from the call directly
spline_call <- attr(male_sitar_model$ns$terms, "predvars")[[3]]

# Evaluate components
internal_knots_male <- eval(spline_call$knots)
boundary_knots_male <- eval(spline_call$Boundary.knots)

library(splines)

# x-values used in the model
x <- seq(0, 7 ,by=0.1)

# Rebuild the spline basis matrix exactly as used in the model
spline_basis_male <- ns(
  x,
  knots = internal_knots_male,
  Boundary.knots = boundary_knots_male,
  intercept = FALSE
)


df_plot <- data.frame(
  x = x,
  spline_basis_male
) %>%
  pivot_longer(-x, names_to = "basis", values_to = "value")

ggplot(df_plot, aes(x = x, y = value, color = basis)) +
  geom_line() +
  labs(title = "Spline Basis Functions from sitar Model") +
  theme_minimal()


dir.create("SITAR_model_parameters")
sitar_coefficients_male <- 
  summary(male_sitar_model)$tTable
#coef(male_sitar_model) gives you all the random effects and takes ages!

#extract standard deviation of random effects
std_dev_random_effects <- 
  (VarCorr(male_sitar_model)[, "StdDev"])

fixed_effects_male <-
  fixed.effects(male_sitar_model)


decimal_places <- 3

sitar_model_parameters_bmi_male <-
data.frame(

  sitar_internal_knots = paste0(
    round(internal_knots_male[[1]], digits=decimal_places),
    "\n",
    round(internal_knots_male[[2]], digits=decimal_places)),
    
  sitar_boundary_knots = paste0(
    round(boundary_knots_male[[1]], digits=decimal_places),
    "\n",
    round(boundary_knots_male[[2]], digits=decimal_places)),
  
  sitar_fixed_s1 = 
    round(fixed_effects_male[["s1"]], digits=decimal_places),
  
  sitar_fixed_s2 = 
    round(fixed_effects_male[["s2"]], digits=decimal_places),
  
  sitar_fixed_s3 = 
    round(fixed_effects_male[["s3"]], digits=decimal_places),
  
  sitar_fixed_s4 = 
    round(NA, digits=decimal_places),
#    round(fixed_effects_male[["s4"]], digits=decimal_places),
  
  sitar_fixed_s5 = 
    round(NA, digits=decimal_places),
#    round(fixed_effects_male[["s5"]], digits=decimal_places),
  
  sitar_fixed_s6 = 
    round(NA, digits=decimal_places),
#    round(fixed_effects_male[["s6"]], digits=decimal_places),
  
  sitar_fixed_a = 
    round(fixed_effects_male[["a"]], digits=decimal_places),

  sitar_fixed_b = 
    round(fixed_effects_male[["b"]], digits=decimal_places),

  sitar_fixed_c = 
    round(fixed_effects_male[["c"]], digits=decimal_places),
    
  sitar_random_a_se = 
    round(as.numeric(std_dev_random_effects[["a"]]), digits=decimal_places),
    
  sitar_random_b_se = 
    round(as.numeric(std_dev_random_effects[["b"]]), digits=decimal_places),
    
  sitar_random_c_se = 
    round(as.numeric(std_dev_random_effects[["c"]]), digits=decimal_places)
)

sitar_model_parameters_bmi_male_t <- 
  rownames_to_column(as.data.frame(t(sitar_model_parameters_bmi_male)))
write.csv(
  sitar_model_parameters_bmi_male_t,
  "SITAR_model_parameters/sitar_model_parameters_bmi_male.csv")

ft <- flextable(sitar_model_parameters_bmi_male_t)
  
  # Customize the table appearance
  ft <- ft %>%
    theme_vanilla() %>%
    align(align = "center", part = "header") %>%
    align(align = "center", part = "body") %>%  
    autofit()
  
  # Define paragraph formatting with centered alignment
  centered_paragraph <- fp_par(text.align = "center")
  
  doc <- read_docx() %>%
    body_add_flextable(ft) 
  
  print(
    doc, 
    target = file.path(paste0("SITAR_model_parameters/sitar_model_parameters_bmi_male_t", ".docx")))

```

```{r}
# Step 1: Create sequence of ages
age_seq <- seq(log(0.2), log(7), length.out = 200)

# Step 2: Recreate spline basis
basis_matrix <- ns(age_seq, knots = c(internal_knots_male[[1]], internal_knots_male[[2]]), Boundary.knots = c(boundary_knots_male[[1]], boundary_knots_male[[2]]), intercept = FALSE)

# Step 3: Plug in fixed effect coefficients
beta <- c(fixed_effects_male[[1]], fixed_effects_male[[2]], fixed_effects_male[[3]])  # from paper

# Step 4: Calculate fitted y values
fitted_y <- as.vector(basis_matrix %*% beta)

# Step 5: Plot
plot(age_seq, fitted_y, type = "l", lwd = 2,
     xlab = "Age", ylab = "Predicted size", main = "Reconstructed SITAR Fixed Effects Curve")
```





```{r, use our random effects curve frames to calculate salient metrics of growth for interpretation on the absolute scale for male}
#add the bmi velocity
male_individual_patient_random_effects_for_curves_bmi <- 
  male_individual_patient_random_effects_for_curves_bmi %>%
        mutate(
          years_to_next_reading = 
            lead(age) - age,
          bmi_to_next_reading = 
            lead(random_sitar_prediction) - random_sitar_prediction,
          bmi_velocity_to_next_reading = 
            bmi_to_next_reading / years_to_next_reading,
          lead_id =
            lead(id))

#correct to NA if the lead_id is different for years_to_next_reading
male_individual_patient_random_effects_for_curves_bmi$years_to_next_reading <-
  ifelse(male_individual_patient_random_effects_for_curves_bmi$lead_id!=
           male_individual_patient_random_effects_for_curves_bmi$id,
         NA,
         male_individual_patient_random_effects_for_curves_bmi$years_to_next_reading)
#correct to NA if the lead_id is different for bmi_to_next_reading
male_individual_patient_random_effects_for_curves_bmi$bmi_to_next_reading <-
  ifelse(male_individual_patient_random_effects_for_curves_bmi$lead_id!=
           male_individual_patient_random_effects_for_curves_bmi$id,
         NA,
         male_individual_patient_random_effects_for_curves_bmi$bmi_to_next_reading)
#correct to NA if the lead_id is different for bmi_velocity_to_next_reading
male_individual_patient_random_effects_for_curves_bmi$bmi_velocity_to_next_reading <-
  ifelse(male_individual_patient_random_effects_for_curves_bmi$lead_id!=
           male_individual_patient_random_effects_for_curves_bmi$id,
         NA,
         male_individual_patient_random_effects_for_curves_bmi$bmi_velocity_to_next_reading)
      
#calculate the salient metrics for this patient
#instead of metrics around puberty, we want to calculate the first adiposity peak and then the adiposity rebound. Note that the first peak may not work dependent on when the random effects are rendered from and what the degrees of freedom of the model is
# Find first peak and trough, returning corresponding age using our custom built function
male_inflections <- 
  find_first_peak_trough_by_id(
    male_individual_patient_random_effects_for_curves_bmi, 
    id_col = "id", 
    value_col = "random_sitar_prediction", 
    age_col = "age")

#take out the whole row with bmi at 5.9 years
male_individual_patient_random_effects_at_five_point_nine <-
  subset(male_individual_patient_random_effects_for_curves_bmi,
         age>5.9 & age < 6.0)[,c(
           "id",
           "age",
           "random_sitar_prediction"
         )]
#then rename the random_sitar_prediction as sitar_bmi_at_five_point_nine
names(male_individual_patient_random_effects_at_five_point_nine)[
  names(male_individual_patient_random_effects_at_five_point_nine)=="random_sitar_prediction"] <- 
  "sitar_bmi_at_five_point_nine"
#then rename the precise_age_at_bmi_when_five_point_nine
names(male_individual_patient_random_effects_at_five_point_nine)[
  names(male_individual_patient_random_effects_at_five_point_nine)=="age"] <- 
  "precise_age_at_bmi_when_five_point_nine"

#take out the whole row with bmi at 19.3 years
male_individual_patient_random_effects_at_eighteen_point_four <-
  subset(male_individual_patient_random_effects_for_curves_bmi,
         age>18.3 & age < 18.4)[,c(
           "id",
           "age",
           "random_sitar_prediction"
         )]
#then rename the random_sitar_prediction as sitar_bmi_at_eighteen_point_four
names(male_individual_patient_random_effects_at_eighteen_point_four)[
  names(male_individual_patient_random_effects_at_eighteen_point_four)=="random_sitar_prediction"] <- 
  "sitar_bmi_at_eighteen_point_four"
#then rename the precise_age_at_bmi_when_five_point_nine
names(male_individual_patient_random_effects_at_eighteen_point_four)[
  names(male_individual_patient_random_effects_at_eighteen_point_four)=="age"] <- 
  "precise_age_at_bmi_when_eighteen_point_four"
```

```{r, join all our calculated metrics into the overall random effects frame to have them available next to a b and c for male}
#first we start by only extracting the id a b and c from the random effects frame. This way if we run this file multiple times, we don't get stacking of extra columns adding each thing again and again
male_random_effects_bmi <-
  male_random_effects_bmi[, 1:4]
if (is.null(male_random_effects_bmi$a_)){
male_random_effects_bmi <-
dplyr::rename(
  male_random_effects_bmi, 
    c("a_bmi"="a", 
      "b_bmi"="b",
      "c_bmi"="c"))
}
male_inflections$id <-
  as.character(male_inflections$id)
male_random_effects_bmi_metrics <-
  left_join(
    male_random_effects_bmi, 
    male_inflections,
    by = join_by(id))

male_individual_patient_random_effects_at_five_point_nine$id <-
  as.character(male_individual_patient_random_effects_at_five_point_nine$id)
male_random_effects_bmi_metrics <-
  left_join(
    male_random_effects_bmi_metrics, 
    male_individual_patient_random_effects_at_five_point_nine,
    by = join_by(id))

male_individual_patient_random_effects_at_eighteen_point_four$id <-
  as.character(male_individual_patient_random_effects_at_eighteen_point_four$id)
male_random_effects_bmi_metrics <-
  left_join(
    male_random_effects_bmi_metrics, 
    male_individual_patient_random_effects_at_eighteen_point_four,
    by = join_by(id))
```

```{r, calculate summary statistics of adiposity peak and rebound male}
male_inflections_summary <-
  t(
male_inflections %>%
  dplyr::summarise(
    n_adiposity_peak = sum(!is.na(adiposity_peak_age)),
    median_adiposity_peak_age = median(adiposity_peak_age, na.rm=T),
    mean_adiposity_peak_age = mean(adiposity_peak_age, na.rm=T),
    sd_adiposity_peak_age = sd(adiposity_peak_age, na.rm=T),
    mean_adiposity_peak_bmi = mean(adiposity_peak_bmi, na.rm=T),
    sd_adiposity_peak_bmi = sd(adiposity_peak_bmi, na.rm=T),
    n_adiposity_rebound = sum(!is.na(adiposity_rebound_age)),
    median_adiposity_rebound_age = median(adiposity_rebound_age, na.rm=T),
    mean_adiposity_rebound_age = mean(adiposity_rebound_age, na.rm=T),
    sd_adiposity_rebound_age = sd(adiposity_rebound_age, na.rm=T),
    mean_adiposity_rebound_bmi = mean(adiposity_rebound_bmi, na.rm=T),
    sd_adiposity_rebound_bmi = sd(adiposity_rebound_bmi, na.rm=T)
  ))
colnames(male_inflections_summary) <- "male_inflection_summary"


```


```{r, do NOT calculate zscores for age from these metrics for male}
#we can't directly calculate z scores for bmi from age from either anthroplus or zscorer, so just put in some placeholders
#we can stukk assess for spurious bmis
male_random_effects_bmi_metrics$sitar_bmi_at_five_point_nine <-
  ifelse(male_random_effects_bmi_metrics$sitar_bmi_at_five_point_nine < 1 |
           male_random_effects_bmi_metrics$sitar_bmi_at_five_point_nine > 120,
         NA,
         male_random_effects_bmi_metrics$sitar_bmi_at_five_point_nine)
male_random_effects_bmi_metrics$sitar_bmi_at_eighteen_point_four <-
  ifelse(male_random_effects_bmi_metrics$sitar_bmi_at_eighteen_point_four < 1 |
           male_random_effects_bmi_metrics$sitar_bmi_at_eighteen_point_four > 120,
         NA,
         male_random_effects_bmi_metrics$sitar_bmi_at_eighteen_point_four)
#give us an indicator variable also telling us these bmis are spurious
male_random_effects_bmi_metrics$spurious_sitar_bmis <-
  ifelse(
    is.na(male_random_effects_bmi_metrics$sitar_bmi_at_five_point_nine) |
    is.na(male_random_effects_bmi_metrics$sitar_bmi_at_eighteen_point_four) ,
    1,
    0
  )

print("Note that we can't calculate bmi z score for age from anthroplus using just the bmi. We tried using the package zscorer instead but that doesn't work either using just bmi. You can calculate from anthro and anthroplus, but you have to put in the height and the weight not the bmi directly")

male_random_effects_bmi_metrics$who_z_bmi_five_point_nine <-
  "have_to_calculate_using_height_and_weight"

male_random_effects_bmi_metrics$who_z_bmi_eighteen_point_four <-
  "have_to_calculate_using_height_and_weight"


```



```{r, replace the version of our random effects data within our list for male}
list_of_male_random_effects_bmi[[name_of_optimum_bmi_model_restrictions_male]] <-
  male_random_effects_bmi_metrics
```

```{r, save our list of random effects again for male}
#we can save this list here again, because when we load it above if we rerun the file, we remove the calculated columns
save(list_of_male_random_effects_bmi,   
     file = paste0("ar_data_files_to_load/list_of_male_random_effects_bmi.Rdata"))
```










```{r, load our sitar model frames for fema}
load(   
     file = paste0("ar_data_files_to_load/list_of_fema_sitar_models_bmi.Rdata"))
load(   
     file = paste0("ar_data_files_to_load/list_of_fema_overall_fixed_effects_bmi.Rdata"))
load(   
     file = paste0("ar_data_files_to_load/list_of_fema_random_effects_bmi.Rdata"))
load(   
     file = paste0("ar_data_files_to_load/list_of_fema_patient_data_with_sitar_predictions_bmi.Rdata"))
load(   
     file = paste0("ar_data_files_to_load/list_of_fema_individual_patient_random_effects_for_curves_bmi.Rdata"))
load(   
     file = paste0("ar_data_files_to_load/list_of_fema_fitting_results_bmi.Rdata"))
load(   
     file = paste0("ar_data_files_to_load/list_of_fema_error_messages_bmi.Rdata"))
```


```{r, extract our optimum fits for fema from the lists}
fema_sitar_model <-
  list_of_fema_sitar_models_bmi[[name_of_optimum_bmi_model_restrictions_fema]]
fema_overall_fixed_effects_bmi <-
  list_of_fema_overall_fixed_effects_bmi[[name_of_optimum_bmi_model_restrictions_fema]]
fema_random_effects_bmi <-
  list_of_fema_random_effects_bmi[[name_of_optimum_bmi_model_restrictions_fema]]
fema_patient_data_with_sitar_predictions_bmi <-
  list_of_fema_patient_data_with_sitar_predictions_bmi[[name_of_optimum_bmi_model_restrictions_fema]]
fema_individual_patient_random_effects_for_curves_bmi <-
  list_of_fema_individual_patient_random_effects_for_curves_bmi[[name_of_optimum_bmi_model_restrictions_fema]]
fema_fitting_results_bmi <-
  list_of_fema_fitting_results_bmi[[name_of_optimum_bmi_model_restrictions_fema]]
fema_error_messages_bmi <-
  list_of_fema_error_messages_bmi[[name_of_optimum_bmi_model_restrictions_fema]]

```


```{r, extract the spline basis for fema and formulate table for sitar model estimates}
# Get the predvars attribute
predvars <- attr(fema_sitar_model$ns$terms, "predvars")

# Extract knots and boundary knots
# Extract from the call directly
spline_call <- attr(fema_sitar_model$ns$terms, "predvars")[[3]]

# Evaluate components
internal_knots_fema <- eval(spline_call$knots)
boundary_knots_fema <- eval(spline_call$Boundary.knots)

library(splines)

# x-values used in the model
x <- seq(0, 7 ,by=0.1)

# Rebuild the spline basis matrix exactly as used in the model
spline_basis_fema <- ns(
  x,
  knots = internal_knots_fema,
  Boundary.knots = boundary_knots_fema,
  intercept = FALSE
)


df_plot <- data.frame(
  x = x,
  spline_basis_fema
) %>%
  pivot_longer(-x, names_to = "basis", values_to = "value")

ggplot(df_plot, aes(x = x, y = value, color = basis)) +
  geom_line() +
  labs(title = "Spline Basis Functions from sitar Model") +
  theme_minimal()


dir.create("SITAR_model_parameters")
sitar_coefficients_fema <- 
  summary(fema_sitar_model)$tTable
#coef(fema_sitar_model) gives you all the random effects and takes ages!

#extract standard deviation of random effects
std_dev_random_effects <- 
  (VarCorr(fema_sitar_model)[, "StdDev"])

fixed_effects_fema <-
  fixed.effects(fema_sitar_model)


decimal_places <- 3

sitar_model_parameters_bmi_fema <-
data.frame(

  sitar_internal_knots = paste0(
    round(internal_knots_fema[[1]], digits=decimal_places),
    "\n",
    round(internal_knots_fema[[2]], digits=decimal_places)),
    
  sitar_boundary_knots = paste0(
    round(boundary_knots_fema[[1]], digits=decimal_places),
    "\n",
    round(boundary_knots_fema[[2]], digits=decimal_places)),
  
  sitar_fixed_s1 = 
    round(fixed_effects_fema[["s1"]], digits=decimal_places),
  
  sitar_fixed_s2 = 
    round(fixed_effects_fema[["s2"]], digits=decimal_places),
  
  sitar_fixed_s3 = 
    round(fixed_effects_fema[["s3"]], digits=decimal_places),
  
  sitar_fixed_s4 = 
    round(NA, digits=decimal_places),
#    round(fixed_effects_fema[["s4"]], digits=decimal_places),
  
  sitar_fixed_s5 = 
    round(NA, digits=decimal_places),
#    round(fixed_effects_fema[["s5"]], digits=decimal_places),
  
  sitar_fixed_s6 = 
    round(NA, digits=decimal_places),
#    round(fixed_effects_fema[["s6"]], digits=decimal_places),
  
  sitar_fixed_a = 
    round(fixed_effects_fema[["a"]], digits=decimal_places),

  sitar_fixed_b = 
    round(fixed_effects_fema[["b"]], digits=decimal_places),

  sitar_fixed_c = 
    round(fixed_effects_fema[["c"]], digits=decimal_places),
    
  sitar_random_a_se = 
    round(as.numeric(std_dev_random_effects[["a"]]), digits=decimal_places),
    
  sitar_random_b_se = 
    round(as.numeric(std_dev_random_effects[["b"]]), digits=decimal_places),
    
  sitar_random_c_se = 
    round(as.numeric(std_dev_random_effects[["c"]]), digits=decimal_places)
)

sitar_model_parameters_bmi_fema_t <- 
  rownames_to_column(as.data.frame(t(sitar_model_parameters_bmi_fema)))
write.csv(
  sitar_model_parameters_bmi_fema_t,
  "SITAR_model_parameters/sitar_model_parameters_bmi_fema.csv")

ft <- flextable(sitar_model_parameters_bmi_fema_t)
  
  # Customize the table appearance
  ft <- ft %>%
    theme_vanilla() %>%
    align(align = "center", part = "header") %>%
    align(align = "center", part = "body") %>%  
    autofit()
  
  # Define paragraph formatting with centered alignment
  centered_paragraph <- fp_par(text.align = "center")
  
  doc <- read_docx() %>%
    body_add_flextable(ft) 
  
  print(
    doc, 
    target = file.path(paste0("SITAR_model_parameters/sitar_model_parameters_bmi_fema_t", ".docx")))

```


```{r, use our random effects curve frames to calculate salient metrics of growth for interpretation on the absolute scale for fema}
#add the bmi velocity
fema_individual_patient_random_effects_for_curves_bmi <- 
  fema_individual_patient_random_effects_for_curves_bmi %>%
        mutate(
          years_to_next_reading = 
            lead(age) - age,
          bmi_to_next_reading = 
            lead(random_sitar_prediction) - random_sitar_prediction,
          bmi_velocity_to_next_reading = 
            bmi_to_next_reading / years_to_next_reading,
          lead_id =
            lead(id))

#correct to NA if the lead_id is different for years_to_next_reading
fema_individual_patient_random_effects_for_curves_bmi$years_to_next_reading <-
  ifelse(fema_individual_patient_random_effects_for_curves_bmi$lead_id!=
           fema_individual_patient_random_effects_for_curves_bmi$id,
         NA,
         fema_individual_patient_random_effects_for_curves_bmi$years_to_next_reading)
#correct to NA if the lead_id is different for bmi_to_next_reading
fema_individual_patient_random_effects_for_curves_bmi$bmi_to_next_reading <-
  ifelse(fema_individual_patient_random_effects_for_curves_bmi$lead_id!=
           fema_individual_patient_random_effects_for_curves_bmi$id,
         NA,
         fema_individual_patient_random_effects_for_curves_bmi$bmi_to_next_reading)
#correct to NA if the lead_id is different for bmi_velocity_to_next_reading
fema_individual_patient_random_effects_for_curves_bmi$bmi_velocity_to_next_reading <-
  ifelse(fema_individual_patient_random_effects_for_curves_bmi$lead_id!=
           fema_individual_patient_random_effects_for_curves_bmi$id,
         NA,
         fema_individual_patient_random_effects_for_curves_bmi$bmi_velocity_to_next_reading)
      
#calculate the salient metrics for this patient
#instead of metrics around puberty, we want to calculate the first adiposity peak and then the adiposity rebound. Note that the first peak may not work dependent on when the random effects are rendered from and what the degrees of freedom of the model is
# Find first peak and trough, returning corresponding age using our custom built function
fema_inflections <- 
  find_first_peak_trough_by_id(
    fema_individual_patient_random_effects_for_curves_bmi, 
    id_col = "id", 
    value_col = "random_sitar_prediction", 
    age_col = "age")

#take out the whole row with bmi at 5.9 years
fema_individual_patient_random_effects_at_five_point_nine <-
  subset(fema_individual_patient_random_effects_for_curves_bmi,
         age>5.9 & age < 6.0)[,c(
           "id",
           "age",
           "random_sitar_prediction"
         )]
#then rename the random_sitar_prediction as sitar_bmi_at_five_point_nine
names(fema_individual_patient_random_effects_at_five_point_nine)[
  names(fema_individual_patient_random_effects_at_five_point_nine)=="random_sitar_prediction"] <- 
  "sitar_bmi_at_five_point_nine"
#then rename the precise_age_at_bmi_when_five_point_nine
names(fema_individual_patient_random_effects_at_five_point_nine)[
  names(fema_individual_patient_random_effects_at_five_point_nine)=="age"] <- 
  "precise_age_at_bmi_when_five_point_nine"

#take out the whole row with bmi at 19.3 years
fema_individual_patient_random_effects_at_eighteen_point_four <-
  subset(fema_individual_patient_random_effects_for_curves_bmi,
         age>18.3 & age < 18.4)[,c(
           "id",
           "age",
           "random_sitar_prediction"
         )]
#then rename the random_sitar_prediction as sitar_bmi_at_eighteen_point_four
names(fema_individual_patient_random_effects_at_eighteen_point_four)[
  names(fema_individual_patient_random_effects_at_eighteen_point_four)=="random_sitar_prediction"] <- 
  "sitar_bmi_at_eighteen_point_four"
#then rename the precise_age_at_bmi_when_five_point_nine
names(fema_individual_patient_random_effects_at_eighteen_point_four)[
  names(fema_individual_patient_random_effects_at_eighteen_point_four)=="age"] <- 
  "precise_age_at_bmi_when_eighteen_point_four"
```


```{r, calculate summary statistics of adiposity peak and rebound fema}
fema_inflections_summary <-
  t(
fema_inflections %>%
  dplyr::summarise(
    n_adiposity_peak = sum(!is.na(adiposity_peak_age)),
    median_adiposity_peak_age = median(adiposity_peak_age, na.rm=T),
    mean_adiposity_peak_age = mean(adiposity_peak_age, na.rm=T),
    sd_adiposity_peak_age = sd(adiposity_peak_age, na.rm=T),
    mean_adiposity_peak_bmi = mean(adiposity_peak_bmi, na.rm=T),
    sd_adiposity_peak_bmi = sd(adiposity_peak_bmi, na.rm=T),
    n_adiposity_rebound = sum(!is.na(adiposity_rebound_age)),
    median_adiposity_rebound_age = median(adiposity_rebound_age, na.rm=T),
    mean_adiposity_rebound_age = mean(adiposity_rebound_age, na.rm=T),
    sd_adiposity_rebound_age = sd(adiposity_rebound_age, na.rm=T),
    mean_adiposity_rebound_bmi = mean(adiposity_rebound_bmi, na.rm=T),
    sd_adiposity_rebound_bmi = sd(adiposity_rebound_bmi, na.rm=T)
  ))
colnames(fema_inflections_summary) <- "fema_inflection_summary"


```

```{r, bind male and female inflections to print}
both_sexes_inflections_summary <-
  cbind(male_inflections_summary, fema_inflections_summary)
```



```{r, join all our calculated metrics into the overall random effects frame to have them available next to a b and c for fema}
#first we start by only extracting the id a b and c from the random effects frame. This way if we run this file multiple times, we don't get stacking of extra columns adding each thing again and again
fema_random_effects_bmi <-
  fema_random_effects_bmi[, 1:4]
if (is.null(fema_random_effects_bmi$a_)){
fema_random_effects_bmi <-
dplyr::rename(
  fema_random_effects_bmi, 
    c("a_bmi"="a", 
      "b_bmi"="b",
      "c_bmi"="c"))
}
fema_inflections$id <-
  as.character(fema_inflections$id)
fema_random_effects_bmi_metrics <-
  left_join(
    fema_random_effects_bmi, 
    fema_inflections,
    by = join_by(id))

fema_individual_patient_random_effects_at_five_point_nine$id <-
  as.character(fema_individual_patient_random_effects_at_five_point_nine$id)
fema_random_effects_bmi_metrics <-
  left_join(
    fema_random_effects_bmi_metrics, 
    fema_individual_patient_random_effects_at_five_point_nine,
    by = join_by(id))

fema_individual_patient_random_effects_at_eighteen_point_four$id <-
  as.character(fema_individual_patient_random_effects_at_eighteen_point_four$id)
fema_random_effects_bmi_metrics <-
  left_join(
    fema_random_effects_bmi_metrics, 
    fema_individual_patient_random_effects_at_eighteen_point_four,
    by = join_by(id))
```


```{r, do NOT calculate zscores for age from these metrics for fema}
#we can't directly calculate z scores for bmi from age from either anthroplus or zscorer, so just put in some placeholders
#we can stukk assess for spurious bmis
fema_random_effects_bmi_metrics$sitar_bmi_at_five_point_nine <-
  ifelse(fema_random_effects_bmi_metrics$sitar_bmi_at_five_point_nine < 1 |
           fema_random_effects_bmi_metrics$sitar_bmi_at_five_point_nine > 120,
         NA,
         fema_random_effects_bmi_metrics$sitar_bmi_at_five_point_nine)
fema_random_effects_bmi_metrics$sitar_bmi_at_eighteen_point_four <-
  ifelse(fema_random_effects_bmi_metrics$sitar_bmi_at_eighteen_point_four < 1 |
           fema_random_effects_bmi_metrics$sitar_bmi_at_eighteen_point_four > 120,
         NA,
         fema_random_effects_bmi_metrics$sitar_bmi_at_eighteen_point_four)
#give us an indicator variable also telling us these bmis are spurious
fema_random_effects_bmi_metrics$spurious_sitar_bmis <-
  ifelse(
    is.na(fema_random_effects_bmi_metrics$sitar_bmi_at_five_point_nine) |
    is.na(fema_random_effects_bmi_metrics$sitar_bmi_at_eighteen_point_four) ,
    1,
    0
  )

print("Note that we can't calculate bmi z score for age from anthroplus. We tried using the package zscorer instead but that doesn't work either")

fema_random_effects_bmi_metrics$who_z_bmi_five_point_nine <-
  "calculate_using_height_and_weight"

fema_random_effects_bmi_metrics$who_z_bmi_eighteen_point_four <-
  "calculate_using_height_and_weight"


```


```{r, replace the version of our random effects data within our list for fema}
list_of_fema_random_effects_bmi[[name_of_optimum_bmi_model_restrictions_fema]] <-
  fema_random_effects_bmi_metrics
```

```{r, save our list of random effects again for fema}
#we can save this list here again, because when we load it above if we rerun the file, we remove the calculated columns
save(list_of_fema_random_effects_bmi,   
     file = paste0("ar_data_files_to_load/list_of_fema_random_effects_bmi.Rdata"))
```

```{r, report proportions under five or other ages}
sink("SITAR_model_parameters/proportions_adiposity_rebound_before_five.txt", split=T)
cat("\n")
cat("Number of male with adiposity rebound before age 5")
cat("\n")
sum(male_random_effects_bmi_metrics$adiposity_rebound_age < 5) /
  length(!is.na(male_random_effects_bmi_metrics$adiposity_rebound_age)) * 100
cat("\n")
cat("Number of fema with adiposity rebound before age 5")
cat("\n")
sum(fema_random_effects_bmi_metrics$adiposity_rebound_age < 5) /
  length(!is.na(fema_random_effects_bmi_metrics$adiposity_rebound_age)) * 100
sink()
```






```{r, load our sitar model frames for both_sexes}
load(   
     file = paste0("ar_data_files_to_load/list_of_both_sexes_sitar_models_bmi.Rdata"))
load(   
     file = paste0("ar_data_files_to_load/list_of_both_sexes_overall_fixed_effects_bmi.Rdata"))
load(   
     file = paste0("ar_data_files_to_load/list_of_both_sexes_random_effects_bmi.Rdata"))
load(   
     file = paste0("ar_data_files_to_load/list_of_both_sexes_patient_data_with_sitar_predictions_bmi.Rdata"))
load(   
     file = paste0("ar_data_files_to_load/list_of_both_sexes_individual_patient_random_effects_for_curves_bmi.Rdata"))
load(   
     file = paste0("ar_data_files_to_load/list_of_both_sexes_fitting_results_bmi.Rdata"))
load(   
     file = paste0("ar_data_files_to_load/list_of_both_sexes_error_messages_bmi.Rdata"))
```


```{r, extract our optimum fits for both_sexes from the lists}

both_sexes_sitar_model <-
  list_of_both_sexes_sitar_models_bmi[[name_of_optimum_bmi_model_restrictions_both_sexes]]
both_sexes_overall_fixed_effects_bmi <-
  list_of_both_sexes_overall_fixed_effects_bmi[[name_of_optimum_bmi_model_restrictions_both_sexes]]
both_sexes_random_effects_bmi <-
  list_of_both_sexes_random_effects_bmi[[name_of_optimum_bmi_model_restrictions_both_sexes]]
both_sexes_patient_data_with_sitar_predictions_bmi <-
  list_of_both_sexes_patient_data_with_sitar_predictions_bmi[[name_of_optimum_bmi_model_restrictions_both_sexes]]
both_sexes_individual_patient_random_effects_for_curves_bmi <-
  list_of_both_sexes_individual_patient_random_effects_for_curves_bmi[[name_of_optimum_bmi_model_restrictions_both_sexes]]
both_sexes_fitting_results_bmi <-
  list_of_both_sexes_fitting_results_bmi[[name_of_optimum_bmi_model_restrictions_both_sexes]]
both_sexes_error_messages_bmi <-
  list_of_both_sexes_error_messages_bmi[[name_of_optimum_bmi_model_restrictions_both_sexes]]

```


```{r, use our random effects curve frames to calculate salient metrics of growth for interpretation on the absolute scale for both_sexes}
#add the bmi velocity
both_sexes_individual_patient_random_effects_for_curves_bmi <- 
  both_sexes_individual_patient_random_effects_for_curves_bmi %>%
        mutate(
          years_to_next_reading = 
            lead(age) - age,
          bmi_to_next_reading = 
            lead(random_sitar_prediction) - random_sitar_prediction,
          bmi_velocity_to_next_reading = 
            bmi_to_next_reading / years_to_next_reading,
          lead_id =
            lead(id))

#correct to NA if the lead_id is different for years_to_next_reading
both_sexes_individual_patient_random_effects_for_curves_bmi$years_to_next_reading <-
  ifelse(both_sexes_individual_patient_random_effects_for_curves_bmi$lead_id!=
           both_sexes_individual_patient_random_effects_for_curves_bmi$id,
         NA,
         both_sexes_individual_patient_random_effects_for_curves_bmi$years_to_next_reading)
#correct to NA if the lead_id is different for bmi_to_next_reading
both_sexes_individual_patient_random_effects_for_curves_bmi$bmi_to_next_reading <-
  ifelse(both_sexes_individual_patient_random_effects_for_curves_bmi$lead_id!=
           both_sexes_individual_patient_random_effects_for_curves_bmi$id,
         NA,
         both_sexes_individual_patient_random_effects_for_curves_bmi$bmi_to_next_reading)
#correct to NA if the lead_id is different for bmi_velocity_to_next_reading
both_sexes_individual_patient_random_effects_for_curves_bmi$bmi_velocity_to_next_reading <-
  ifelse(both_sexes_individual_patient_random_effects_for_curves_bmi$lead_id!=
           both_sexes_individual_patient_random_effects_for_curves_bmi$id,
         NA,
         both_sexes_individual_patient_random_effects_for_curves_bmi$bmi_velocity_to_next_reading)
      
#calculate the salient metrics for this patient
#instead of metrics around puberty, we want to calculate the first adiposity peak and then the adiposity rebound. Note that the first peak may not work dependent on when the random effects are rendered from and what the degrees of freedom of the model is
# Find first peak and trough, returning corresponding age using our custom built function
both_sexes_inflections <- 
  find_first_peak_trough_by_id(
    both_sexes_individual_patient_random_effects_for_curves_bmi, 
    id_col = "id", 
    value_col = "random_sitar_prediction", 
    age_col = "age")

#take out the whole row with bmi at 5.9 years
both_sexes_individual_patient_random_effects_at_five_point_nine <-
  subset(both_sexes_individual_patient_random_effects_for_curves_bmi,
         age>5.9 & age < 6.0)[,c(
           "id",
           "age",
           "random_sitar_prediction"
         )]
#then rename the random_sitar_prediction as sitar_bmi_at_five_point_nine
names(both_sexes_individual_patient_random_effects_at_five_point_nine)[
  names(both_sexes_individual_patient_random_effects_at_five_point_nine)=="random_sitar_prediction"] <- 
  "sitar_bmi_at_five_point_nine"
#then rename the precise_age_at_bmi_when_five_point_nine
names(both_sexes_individual_patient_random_effects_at_five_point_nine)[
  names(both_sexes_individual_patient_random_effects_at_five_point_nine)=="age"] <- 
  "precise_age_at_bmi_when_five_point_nine"

#take out the whole row with bmi at 19.3 years
both_sexes_individual_patient_random_effects_at_eighteen_point_four <-
  subset(both_sexes_individual_patient_random_effects_for_curves_bmi,
         age>18.3 & age < 18.4)[,c(
           "id",
           "age",
           "random_sitar_prediction"
         )]
#then rename the random_sitar_prediction as sitar_bmi_at_eighteen_point_four
names(both_sexes_individual_patient_random_effects_at_eighteen_point_four)[
  names(both_sexes_individual_patient_random_effects_at_eighteen_point_four)=="random_sitar_prediction"] <- 
  "sitar_bmi_at_eighteen_point_four"
#then rename the precise_age_at_bmi_when_five_point_nine
names(both_sexes_individual_patient_random_effects_at_eighteen_point_four)[
  names(both_sexes_individual_patient_random_effects_at_eighteen_point_four)=="age"] <- 
  "precise_age_at_bmi_when_eighteen_point_four"
```

```{r, join all our calculated metrics into the overall random effects frame to have them available next to a b and c for both_sexes}
#first we start by only extracting the id a b and c from the random effects frame. This way if we run this file multiple times, we don't get stacking of extra columns adding each thing again and again
both_sexes_random_effects_bmi <-
  both_sexes_random_effects_bmi[, 1:4]
if (is.null(both_sexes_random_effects_bmi$a_)){
both_sexes_random_effects_bmi <-
dplyr::rename(
  both_sexes_random_effects_bmi, 
    c("a_bmi"="a", 
      "b_bmi"="b",
      "c_bmi"="c"))
}
both_sexes_inflections$id <-
  as.character(both_sexes_inflections$id)
both_sexes_random_effects_bmi_metrics <-
  left_join(
    both_sexes_random_effects_bmi, 
    both_sexes_inflections,
    by = join_by(id))

both_sexes_individual_patient_random_effects_at_five_point_nine$id <-
  as.character(both_sexes_individual_patient_random_effects_at_five_point_nine$id)
both_sexes_random_effects_bmi_metrics <-
  left_join(
    both_sexes_random_effects_bmi_metrics, 
    both_sexes_individual_patient_random_effects_at_five_point_nine,
    by = join_by(id))

both_sexes_individual_patient_random_effects_at_eighteen_point_four$id <-
  as.character(both_sexes_individual_patient_random_effects_at_eighteen_point_four$id)
both_sexes_random_effects_bmi_metrics <-
  left_join(
    both_sexes_random_effects_bmi_metrics, 
    both_sexes_individual_patient_random_effects_at_eighteen_point_four,
    by = join_by(id))
```



```{r, do NOT calculate zscores for age from these metrics for both_sexes}
#we can't directly calculate z scores for bmi from age from either anthroplus or zscorer, so just put in some placeholders
#we can stukk assess for spurious bmis
both_sexes_random_effects_bmi_metrics$sitar_bmi_at_five_point_nine <-
  ifelse(both_sexes_random_effects_bmi_metrics$sitar_bmi_at_five_point_nine < 1 |
           both_sexes_random_effects_bmi_metrics$sitar_bmi_at_five_point_nine > 120,
         NA,
         both_sexes_random_effects_bmi_metrics$sitar_bmi_at_five_point_nine)
both_sexes_random_effects_bmi_metrics$sitar_bmi_at_eighteen_point_four <-
  ifelse(both_sexes_random_effects_bmi_metrics$sitar_bmi_at_eighteen_point_four < 1 |
           both_sexes_random_effects_bmi_metrics$sitar_bmi_at_eighteen_point_four > 120,
         NA,
         both_sexes_random_effects_bmi_metrics$sitar_bmi_at_eighteen_point_four)
#give us an indicator variable also telling us these bmis are spurious
both_sexes_random_effects_bmi_metrics$spurious_sitar_bmis <-
  ifelse(
    is.na(both_sexes_random_effects_bmi_metrics$sitar_bmi_at_five_point_nine) |
    is.na(both_sexes_random_effects_bmi_metrics$sitar_bmi_at_eighteen_point_four) ,
    1,
    0
  )

print("Note that we can't calculate bmi z score for age from anthroplus. We tried using the package zscorer instead but that doesn't work either")

both_sexes_random_effects_bmi_metrics$who_z_bmi_five_point_nine <-
  "calculate_using_height_and_weight"

both_sexes_random_effects_bmi_metrics$who_z_bmi_eighteen_point_four <-
  "calculate_using_height_and_weight"


```


```{r, replace the version of our random effects data within our list for both_sexes}
list_of_both_sexes_random_effects_bmi[[name_of_optimum_bmi_model_restrictions_both_sexes]] <-
  both_sexes_random_effects_bmi_metrics
```

```{r, save our list of random effects again for both_sexes into our original list}
#we can save this list here again, because when we load it above if we rerun the file, we remove the calculated columns
save(list_of_both_sexes_random_effects_bmi,   
     file = paste0("ar_data_files_to_load/list_of_both_sexes_random_effects_bmi.Rdata"))
```



















************************************
plot sitar fixed and random effects over raw data for bmi
************************************

```{r, plot individual patient sitar fits over patient raw data}
for (each_group in c(
  "male",
  "fema",
  "both_sexes"
)){
  


#default to both_sexes
all_patient_data <-
  both_sexes_sitar_model$data
random_effects_curve_data <-
  both_sexes_individual_patient_random_effects_for_curves_bmi
fixed_effects_curve_data <-
  both_sexes_overall_fixed_effects_bmi
fixed_effects_colour<-"darkgreen"
name_of_model <-
  name_of_optimum_bmi_model_restrictions_both_sexes

if (each_group=="male"){
  fixed_effects_colour <- "blue"
all_patient_data <-
  male_sitar_model$data
random_effects_curve_data <-
  male_individual_patient_random_effects_for_curves_bmi
fixed_effects_curve_data <-
  male_overall_fixed_effects_bmi
name_of_model <-
  name_of_optimum_bmi_model_restrictions_male
}
if (each_group=="fema"){
  fixed_effects_colour<-"red"
all_patient_data <-
  fema_sitar_model$data
random_effects_curve_data <-
  fema_individual_patient_random_effects_for_curves_bmi
fixed_effects_curve_data <-
  fema_overall_fixed_effects_bmi
name_of_model <-
  name_of_optimum_bmi_model_restrictions_fema
}


#then plot it 
all_patient_plot <- 
  ggplot(data=fixed_effects_curve_data, 
         aes(x=age, 
             y=bmi)) + 
  geom_point(data=all_patient_data,
    aes(x=age_to_use,
        y=bmi_using_interpolations), 
    size=2,
    alpha=0.2, 
    colour="black") +
  geom_line(data=random_effects_curve_data,
    aes(
      x=age,
      y=random_sitar_prediction,
      group=id), 
    alpha=0.1, 
    linewidth=0.5,
    colour="black") +
  geom_line(
    aes(), 
    linewidth=1.5,
    linetype="longdash",
    alpha=0.8, 
    colour=fixed_effects_colour) +
  coord_cartesian(
    xlim=c(0,7),
    ylim=c(0,50)
    ) +
  labs(title=name_of_model,
       subtitle="Dashed line = Fixed Effects, Solid line = Patient Random Effects",
       y= "BMI (kg/m2)",
       x= "Age (years)") +
  themepowerpointtitle
all_patient_plot
dir.create(
  paste0("all_patient_sitar_plots")
  )
dir.create(
  paste0("all_patient_sitar_plots/", 
         name_of_model)
  )
cat(paste0("printing ", each_group, "\n"))
ggsave(filename=paste0(each_group, "_all.png"), 
       path=
         paste0(
         "all_patient_sitar_plots/", 
         name_of_model),
       plot = all_patient_plot, 
       device="png",  
       width=10, height=5, 
       limitsize=F)
}

```








***********************************
Plot individual ggplots of sitar optimum model fit for each of male fema and both_sexes along with original patient data
***********************************

this will loop around and plot patients individually, so this will take a while


``{r}
for (each_group in c(
  "male",
  "fema",
  "both_sexes"
)){
  


###default to both_sexes
all_patient_data <-
  both_sexes_sitar_model$data
random_effects_curve_data <-
  both_sexes_individual_patient_random_effects_for_curves_bmi
fixed_effects_curve_data <-
  both_sexes_overall_fixed_effects_bmi
fixed_effects_colour<-"darkgreen"
name_of_model <-
  name_of_optimum_bmi_model_restrictions_both_sexes

if (each_group=="male"){
  fixed_effects_colour <- "blue"
all_patient_data <-
  male_sitar_model$data
random_effects_curve_data <-
  male_individual_patient_random_effects_for_curves_bmi
fixed_effects_curve_data <-
  male_overall_fixed_effects_bmi
name_of_model <-
  name_of_optimum_bmi_model_restrictions_male
}
if (each_group=="fema"){
  fixed_effects_colour<-"red"
all_patient_data <-
  fema_sitar_model$data
random_effects_curve_data <-
  fema_individual_patient_random_effects_for_curves_bmi
fixed_effects_curve_data <-
  fema_overall_fixed_effects_bmi
name_of_model <-
  name_of_optimum_bmi_model_restrictions_fema
}

###then we loop around the patient ids
for (each_patient in c(
  unique(all_patient_data$id)
)){
  
###each_patient <- 557 #practice patient
  #take out the patient data
  individual_patient_data <-
    subset(all_patient_data, id==each_patient)
  individual_random_effects_curve <-
    subset(random_effects_curve_data, id==each_patient)
  
###then plot it
individual_patient_plot <- 
  ggplot(data=fixed_effects_curve_data, 
         aes(x=age, 
             y=bmi)) + 
  geom_line(
    aes(), 
    linewidth=1.5,
    linetype="longdash",
    alpha=0.5, 
    colour=fixed_effects_colour) +
  geom_point(data=individual_patient_data,
    aes(x=age_to_use,
        y=bmi_using_interpolations), 
    size=2,
    alpha=0.5, 
    colour="black") +
  geom_line(data=individual_random_effects_curve,
    aes(
      x=age,
      y=random_sitar_prediction), 
    alpha=0.5, 
    linewidth=1.5,
    colour="black") +
  coord_cartesian(
    xlim=c(0,7),
    ylim=c(0,50)
    ) +
  labs(title=name_of_model,
       subtitle="Dashed line = Fixed Effects, Solid line = Patient Random Effects",
       y= "BMI (kg/m2)",
       x= "Age (years)") +
  themewithlegend

dir.create(
  paste0("individual_patient_sitar_plots")
  )
dir.create(
  paste0("individual_patient_sitar_plots/", 
         name_of_model)
  )
cat(paste0("printing ", each_group, " specifically the patient ", each_patient, "\n"))

ggsave(filename=paste0("id_", each_patient, ".png"), 
       path=
         paste0(
         "individual_patient_sitar_plots/", 
         name_of_model),
       plot = individual_patient_plot, 
       device="png",  
       width=10, height=5, 
       limitsize=F)
}
}
``




```{r, summary stats of data points and patients for BMI model}
sink("Summary_of_data_into_SITAR_BMI_models.txt", split=T)
print("Number of data points used in male SITAR BMI model")
nrow(male_sitar_model$data)
print("Number of patients used in male SITAR BMI model")
length(unique(male_sitar_model$data$id))

print("Number of data points used in fema SITAR BMI model")
nrow(fema_sitar_model$data)
print("Number of patients used in fema SITAR BMI model")
length(unique(fema_sitar_model$data$id))

print("Number of data points used in both_sexes SITAR BMI model")
nrow(both_sexes_sitar_model$data)
print("Number of patients used in both_sexes SITAR BMI model")
length(unique(both_sexes_sitar_model$data$id))
sink()
```

```{r, calculate R2 for sitar models}
sink("Summary_of_r2_from_SITAR_BMI_models.txt", split=T)
print("R² for male BMI SITAR model:")
residual_variance_male <- male_sitar_model$sigma^2
random_variance_male <- sum(as.numeric(VarCorr(male_sitar_model)[, "Variance"]))
fitted_values_male <- fitted(male_sitar_model, level = 0)  # Fitted values without random effects
fixed_variance_male <- var(fitted_values_male)
cat("Marginal:")
(r2_marginal_male_bmi <- 
  fixed_variance_male / 
  (fixed_variance_male + random_variance_male + residual_variance_male))
cat("Conditional:")
(r2_conditional_male_bmi <- 
  (fixed_variance_male + random_variance_male) / 
  (fixed_variance_male + random_variance_male + residual_variance_male))

print("R² for fema BMI SITAR model:")
residual_variance_fema <- fema_sitar_model$sigma^2
random_variance_fema <- sum(as.numeric(VarCorr(fema_sitar_model)[, "Variance"]))
fitted_values_fema <- fitted(fema_sitar_model, level = 0)  # Fitted values without random effects
fixed_variance_fema <- var(fitted_values_fema)
cat("Marginal:")
(r2_marginal_fema_bmi <- 
  fixed_variance_fema / 
  (fixed_variance_fema + random_variance_fema + residual_variance_fema))
cat("Conditional:")
(r2_conditional_fema_bmi <- 
  (fixed_variance_fema + random_variance_fema) / 
  (fixed_variance_fema + random_variance_fema + residual_variance_fema))

print("R² for both_sexes BMI SITAR model:")
residual_variance_both_sexes <- both_sexes_sitar_model$sigma^2
random_variance_both_sexes <- sum(as.numeric(VarCorr(both_sexes_sitar_model)[, "Variance"]))
fitted_values_both_sexes <- fitted(both_sexes_sitar_model, level = 0)  # Fitted values without random effects
fixed_variance_both_sexes <- var(fitted_values_both_sexes)
cat("Marginal:")
(r2_marginal_both_sexes_bmi <- 
  fixed_variance_both_sexes / 
  (fixed_variance_both_sexes + random_variance_both_sexes + residual_variance_both_sexes))
cat("Conditional:")
(r2_conditional_both_sexes_bmi <- 
  (fixed_variance_both_sexes + random_variance_both_sexes) / 
  (fixed_variance_both_sexes + random_variance_both_sexes + residual_variance_both_sexes))
sink()
```

```{r, calculating age at adiposity rebound from fixed effects}
male_overall_fixed_effects_bmi$adiposity_rebound_age[1]
fema_overall_fixed_effects_bmi$adiposity_rebound_age[1]


cat("Simple description of BMI at adiposity rebound in male patients\n")
cat(paste0(
           round(male_overall_fixed_effects_bmi$adiposity_rebound_age[1], digits=2),
           ("\n("),
           round(male_overall_fixed_effects_bmi$adiposity_rebound_bmi[1], digits=2),
           (")")
     ))

cat("Simple description of BMI at adiposity rebound in fema patients\n")
cat(paste0(
           round(fema_overall_fixed_effects_bmi$adiposity_rebound_age[1], digits=2),
           ("\n("),
           round(fema_overall_fixed_effects_bmi$adiposity_rebound_bmi[1], digits=2),
           (")")
     ))
```


```{r, summary statistics for age at sitar adiposity rebound by random effects}
descr(male_random_effects_bmi_metrics$adiposity_rebound_age)

cat("Simple description of BMI at adiposity rebound in male patients\n")
cat(paste0(
           round(median(male_random_effects_bmi_metrics$adiposity_rebound_age, na.rm=T), digits=2),
           ("\n("),
           round(as.numeric(sd(male_random_effects_bmi_metrics$adiposity_rebound_age, na.rm=T)), digits=2),
           (")")
     ))

cat("Simple description of BMI at adiposity rebound in fema patients\n")
cat(paste0(
           round(median(fema_random_effects_bmi_metrics$adiposity_rebound_age, na.rm=T), digits=2),
           ("\n("),
           round(as.numeric(sd(fema_random_effects_bmi_metrics$adiposity_rebound_age, na.rm=T)), digits=2),
           (")")
     ))
```

```{r, summary statistics for BMI at sitar adiposity rebound}
descr(male_random_effects_bmi_metrics$adiposity_rebound_bmi)

cat("Simple description of age at adiposity rebound in male patients\n")
cat(paste0(
           round(median(male_random_effects_bmi_metrics$adiposity_rebound_bmi, na.rm=T), digits=2),
           ("\n("),
           round(as.numeric(sd(male_random_effects_bmi_metrics$adiposity_rebound_bmi, na.rm=T)), digits=2),
           (")")
     ))

cat("Simple description of age at adiposity rebound in fema patients\n")
cat(paste0(
           round(median(fema_random_effects_bmi_metrics$adiposity_rebound_bmi, na.rm=T), digits=2),
           ("\n("),
           round(as.numeric(sd(fema_random_effects_bmi_metrics$adiposity_rebound_bmi, na.rm=T)), digits=2),
           (")")
     ))


```

```{r, how does age at adiposity rebound predict final height}
#to do this we need to join 

male_random_effects_height_and_bmi <- left_join(
  male_random_effects_height_metrics,
  male_random_effects_bmi_metrics,
  by = join_by(id)
)
male_random_effects_weight_height_and_bmi <- left_join(
  male_random_effects_height_and_bmi,
  male_random_effects_weight_metrics,
  by = join_by(id)
)

fema_random_effects_height_and_bmi <- left_join(
  fema_random_effects_height_metrics,
  fema_random_effects_bmi_metrics,
  by = join_by(id)
)
fema_random_effects_weight_height_and_bmi <- left_join(
  fema_random_effects_height_and_bmi,
  fema_random_effects_weight_metrics,
  by = join_by(id)
)
```

```{r, now we have joined our random effects we can create sitar derived bmi from the sitar weight and height}
male_random_effects_weight_height_and_bmi$sitar_derived_bmi_at_age_18 <-
  male_random_effects_weight_height_and_bmi$sitar_weight_at_age_18 / ((male_random_effects_weight_height_and_bmi$sitar_height_at_age_18)/100)^2

fema_random_effects_weight_height_and_bmi$sitar_derived_bmi_at_age_18 <-
  fema_random_effects_weight_height_and_bmi$sitar_weight_at_age_18 / ((fema_random_effects_weight_height_and_bmi$sitar_height_at_age_18)/100)^2
```

```{r, we also create sitar derived bmi z score at 18}
print("Could recode this above to give us sitar derived bmi z score at all ages")

male_random_effects_weight_height_and_bmi$who_z_sitar_derived_bmi_at_18 <-
  anthroplus::anthroplus_zscores(
   sex =                
     1,
   age_in_months =      
     18 * 12,
   height_in_cm =       
     male_random_effects_weight_height_and_bmi$sitar_height_at_age_18,
   weight_in_kg =       
     male_random_effects_weight_height_and_bmi$sitar_weight_at_age_18
)$zbfa

fema_random_effects_weight_height_and_bmi$who_z_sitar_derived_bmi_at_18 <-
  anthroplus::anthroplus_zscores(
   sex =                
     2,
   age_in_months =      
     18 * 12,
   height_in_cm =       
     fema_random_effects_weight_height_and_bmi$sitar_height_at_age_18,
   weight_in_kg =       
     fema_random_effects_weight_height_and_bmi$sitar_weight_at_age_18
)$zbfa

```



```{r, age at adiposity rebound to predict BMI at 18}
ggplot(data=male_random_effects_weight_height_and_bmi, 
       aes(x=adiposity_rebound_age, y=sitar_derived_bmi_at_age_18)) + geom_point() + geom_smooth()
ggplot(data=fema_random_effects_weight_height_and_bmi, 
       aes(x=adiposity_rebound_age, y=sitar_derived_bmi_at_age_18)) + geom_point() + geom_smooth()
print("Proof that later adiposity rebound predicts healthier BMI:")
summary(lm(data=male_random_effects_weight_height_and_bmi, 
   formula=sitar_derived_bmi_at_age_18~adiposity_rebound_age))
summary(lm(data=fema_random_effects_weight_height_and_bmi, 
   formula=sitar_derived_bmi_at_age_18~adiposity_rebound_age))
```

```{r, age at adiposity rebound to predict weight at 18}
ggplot(data=male_random_effects_weight_height_and_bmi, 
       aes(x=adiposity_rebound_age, y=sitar_weight_at_age_18)) + geom_point() + geom_smooth()
ggplot(data=fema_random_effects_weight_height_and_bmi, 
       aes(x=adiposity_rebound_age, y=sitar_weight_at_age_18)) + geom_point() + geom_smooth()

print("Proof that later adiposity rebound predicts healthier weight:")
summary(lm(data=male_random_effects_weight_height_and_bmi, 
   formula=sitar_weight_at_age_18~adiposity_rebound_age))
summary(lm(data=fema_random_effects_weight_height_and_bmi, 
   formula=sitar_weight_at_age_18~adiposity_rebound_age))
```

```{r, age at adiposity rebound to predict height at 18}
ggplot(data=male_random_effects_weight_height_and_bmi, 
       aes(x=adiposity_rebound_age, y=sitar_height_at_age_18)) + geom_point() + geom_smooth()
ggplot(data=fema_random_effects_weight_height_and_bmi, 
       aes(x=adiposity_rebound_age, y=sitar_height_at_age_18)) + geom_point() + geom_smooth()

print("Proof that later adiposity rebound does not predict height:")
summary(lm(data=male_random_effects_weight_height_and_bmi, 
   formula=sitar_height_at_age_18~adiposity_rebound_age))
summary(lm(data=fema_random_effects_weight_height_and_bmi, 
   formula=sitar_height_at_age_18~adiposity_rebound_age))
```

```{r, function to calculate bmi rmse}
calculate_bmi_rmse <- 
  function(model, data) {
    predictions <- predict(model, newdata = data, type = "response")
    actuals <- data$bmi_using_interpolations
    sqrt(mean((predictions - actuals)^2))
  }
```


```{r, calculate bmi rmse}
male_bmi_rmse <-
calculate_bmi_rmse(
  model=male_sitar_model, 
  data=male_sitar_model$data)
fema_bmi_rmse <-
calculate_bmi_rmse(
  model=fema_sitar_model, 
  data=fema_sitar_model$data)
cat(paste0("Male BMI RMSE is ", male_bmi_rmse, "\n"))
cat(paste0("Fema BMI RMSE is ", fema_bmi_rmse))
```


```{r, summary statistics for sitar derived bmi at 18}
descr(male_random_effects_weight_height_and_bmi$sitar_derived_bmi_at_age_18)

cat("Simple description of SITAR derived bmi at 18 in male patients\n")
cat(
  paste0(
    round(
      mean(
        male_random_effects_weight_height_and_bmi$sitar_derived_bmi_at_age_18, na.rm=T), digits=2),
    ("\n("),
    round(
      as.numeric(
        sd(
          male_random_effects_weight_height_and_bmi$sitar_derived_bmi_at_age_18, na.rm=T)), digits=2),
    (")")
  ))

cat("Simple description of SITAR predicted bmi at 18 in fema patients\n")
cat(
  paste0(
    round(
      mean(
        fema_random_effects_weight_height_and_bmi$sitar_derived_bmi_at_age_18, na.rm=T), digits=2),
    ("\n("),
    round(
      as.numeric(
        sd(
          fema_random_effects_weight_height_and_bmi$sitar_derived_bmi_at_age_18, na.rm=T)), digits=2),
    (")")
  ))
```


```{r, summary statistics for bmi z-score at 18}
descr(male_random_effects_weight_height_and_bmi$who_z_sitar_derived_bmi_at_18)

cat("Simple description of SITAR predicted bmi z-score at 18 in male patients\n")
cat(
  paste0(
    round(
      mean(
        male_random_effects_weight_height_and_bmi$who_z_sitar_derived_bmi_at_18, na.rm=T), digits=2),
    ("\n("),
    round(
      as.numeric(
        sd(
          male_random_effects_weight_height_and_bmi$who_z_sitar_derived_bmi_at_18, na.rm=T)), digits=2),
    (")\n")
  ))

cat("Simple description of SITAR predicted bmi z-score at 18 in fema patients\n")
cat(
  paste0(
    round(
      mean(
        fema_random_effects_weight_height_and_bmi$who_z_sitar_derived_bmi_at_18, na.rm=T), digits=2),
    ("\n("),
    round(
      as.numeric(
        sd(
          fema_random_effects_weight_height_and_bmi$who_z_sitar_derived_bmi_at_18, na.rm=T)), digits=2),
    (")\n")
  ))
```


``{r, function to regress growth metrics to predict height and weight at 18, produce doc table and graph of both sexes}
HERE I AM - THIS FUNCTION IS ALMOST READY
RETURN THE PLOT AS WELL AS A VARIABLE SO THAT IF YOU WANT YOU CAN GRID THE PLOTS IN R ALTHOUGH LIKELY NOT NECESSARY. EASY TO RETURN THOUGH
ENSURE THEYRE SAVING PROPERLY
RUN THEM THROUGH ALL THE DIFFERENT PERMUTATIONS AND COMBINE IN ILLUSTRATOR
PROBABLY WANT TO COMBINE THE TABLES IN WORD
MAY AS WELL RETURN THE TABLES TO THE GLOBAL ENVIRONMENT IN R ALSO USING X VARIABLE AND Y VARIABLE TO NAME THEM
``


```{r, function to regress growth metrics to predict height and weight at 18, produce doc table and graph of both sexes}
#HERE I AM - WEIRD PROBLEM HAPPENING WITH THE DIRECTORIES
lm_growth_function <- 
  function (
    male_data_to_regress,
    fema_data_to_regress,
    directory_to_save,
    x_variable, 
    y_variable,
    my_xlim,
    my_ylim,
    my_x_breaks,
    my_y_breaks,
    alpha_for_points,
    decimal_places,
    decimal_places_p
    ){ 

    
sub_directory_to_save <- paste0(
  paste0(y_variable, "__on__", x_variable))


# Create directory (even if R thinks it exists)
dir.create(
  paste0(
    directory_to_save, 
    "/",
    sub_directory_to_save), 
    recursive = TRUE, showWarnings = TRUE)


sub_directory_file_path <- 
  paste0(
    directory_to_save, 
    "/",
    sub_directory_to_save)
  
  male_model <-
    lm(
      data = male_data_to_regress,
      formula = as.formula(
        paste0(
          y_variable,
          " ~ ",
          x_variable
        )
      )
    )
  
  male_number_in_model <- 
    length(predict(male_model))
  
  #extract male intercept
  male_intercept <- 
    coef(male_model)[["(Intercept)"]]
  # Extract standard error of the intercept
  male_intercept_se <- 
    summary(male_model)$coefficients["(Intercept)", "Std. Error"]
  # Extract p for the intercept
  male_intercept_p <- 
    summary(male_model)$coefficients["(Intercept)", "Pr(>|t|)"]
  #extract male slope
  male_slope <- 
    coef(male_model)[[x_variable]]
  # Extract standard error of the intercept
  male_slope_se <- 
    summary(male_model)$coefficients[x_variable, "Std. Error"]
  # Extract p for the slope
  male_slope_p <- 
    summary(male_model)$coefficients[x_variable, "Pr(>|t|)"]
  # Extract the r2 of the model
  male_model_r2 <- 
    summary(male_model)$r.squared
  male_model_r <-
    ifelse(
      male_slope>0,
      male_model_r2^0.5,
      -male_model_r2^0.5)
      
    #calculate the f statistics so we can get the overall model p
  male_model_f <- summary(male_model)$fstatistic
  # Calculate the overall model p-value using the F-statistic
  male_model_p <- pf(
    male_model_f["value"],
    male_model_f["numdf"],
    male_model_f["dendf"],
    lower.tail = FALSE
  )
  
  fema_model <-
    lm(
      data = fema_data_to_regress,
      formula = as.formula(
        paste0(
          y_variable,
          " ~ ",
          x_variable
        )
      )
    )
  
  fema_number_in_model <- 
    length(predict(fema_model))

  #extract fema intercept
  fema_intercept <- 
    coef(fema_model)[["(Intercept)"]]
  # Extract standard error of the intercept
  fema_intercept_se <- 
    summary(fema_model)$coefficients["(Intercept)", "Std. Error"]
  # Extract p for the intercept
  fema_intercept_p <- 
    summary(fema_model)$coefficients["(Intercept)", "Pr(>|t|)"]
  #extract fema slope
  fema_slope <- 
    coef(fema_model)[[x_variable]]
  # Extract standard error of the intercept
  fema_slope_se <- 
    summary(fema_model)$coefficients[x_variable, "Std. Error"]
  # Extract p for the slope
  fema_slope_p <- 
    summary(fema_model)$coefficients[x_variable, "Pr(>|t|)"]
  # Extract the r2 of the model
  fema_model_r2 <- 
    summary(fema_model)$r.squared
  fema_model_r <-
    ifelse(
      fema_slope>0,
      fema_model_r2^0.5,
      -fema_model_r2^0.5)
  #calculate the f statistics so we can get the overall model p
  fema_model_f <- summary(fema_model)$fstatistic
  # Calculate the overall model p-value using the F-statistic
  fema_model_p <- pf(
    fema_model_f["value"],
    fema_model_f["numdf"],
    fema_model_f["dendf"],
    lower.tail = FALSE
  )
  
  results_frame_separate_sex_columns <- 
    data.frame(
      
      sex = 
        c("Male", "Female"),
      
      n = 
        c(
          male_number_in_model,
          fema_number_in_model
        ),
      
      intercept = 
        c(#male
          paste0(
            round(male_intercept, digits=decimal_places), 
            "\n (",
            round((male_intercept - 1.96*male_intercept_se), digits=decimal_places),
            " to ",
            round((male_intercept + 1.96*male_intercept_se), digits=decimal_places),
            ")",
            "\n [",
            round((male_intercept_p), digits=decimal_places_p),
            "]"
          )
          ,
          #fema
          paste0(
            round(fema_intercept, digits=decimal_places), 
            "\n (",
            round((fema_intercept - 1.96*fema_intercept_se), digits=decimal_places),
            " to ",
            round((fema_intercept + 1.96*fema_intercept_se), digits=decimal_places),
            ")",
            "\n [",
            round((fema_intercept_p), digits=decimal_places_p),
            "]"
          )
        ),
      
      slope = 
        c(#male
          paste0(
            round(male_slope, digits=decimal_places), 
            "\n (",
            round((male_slope - 1.96*male_slope_se), digits=decimal_places),
            " to ",
            round((male_slope + 1.96*male_slope_se), digits=decimal_places),
            ")",
            "\n [",
            round((male_slope_p), digits=decimal_places_p),
            "]"
          )
          ,
          #fema
          paste0(
            round(fema_slope, digits=decimal_places), 
            "\n (",
            round((fema_slope - 1.96*fema_slope_se), digits=decimal_places),
            " to ",
            round((fema_slope + 1.96*fema_slope_se), digits=decimal_places),
            ")",
            "\n [",
            round((fema_slope_p), digits=decimal_places_p),
            "]"
          )
        ),

      r_squared = 
        c(
          round((male_model_r2), digits=decimal_places_p),
          round((fema_model_r2), digits=decimal_places_p)
          ),
      
      r = 
        c(
          round((male_model_r), digits=decimal_places_p),
          round((fema_model_r), digits=decimal_places_p)
          ),
      
      model_p = 
        c(
          round((male_model_p), digits=decimal_places_p),
          round((fema_model_p), digits=decimal_places_p)
          )
      )
    

# Transpose
results_frame_separate_sex_columns_t <- as.data.frame(t(results_frame_separate_sex_columns))
  
  # Save to CSV 
  write.csv(
    results_frame_separate_sex_columns_t, 
    file = paste0(
      directory_to_save, 
      "/",
      sub_directory_to_save, 
      "/", 
      y_variable, 
      "__on__", 
      x_variable, 
      "_summary.csv"), 
    row.names = T)
  
  #save to .docx
  
  ft <- flextable(rownames_to_column(results_frame_separate_sex_columns_t))
  
  # Customize the table appearance
  ft <- ft %>%
    theme_vanilla() %>%
    align(align = "center", part = "header") %>%
    align(align = "center", part = "body") %>%  
    fontsize(size = 8, part = "all") %>%
    autofit()
  
  # Define paragraph formatting with centered alignment
  centered_paragraph <- fp_par(text.align = "center")
  
  doc <- read_docx() %>%
    body_add_flextable(ft) 
  
  print(
    doc, 
    target = file.path(
      paste0(
         directory_to_save, 
      "/",
      sub_directory_to_save, 
      "/", 
      y_variable, 
      "__on__", 
      x_variable,
      "_summary.docx"
      )))

  
    results_frame_male_then_fema <- 
    data.frame(
      
      n_male = 
          male_number_in_model
        ,
      
      intercept_male = 
          paste0(
            round(male_intercept, digits=decimal_places), 
            "\n (",
            round((male_intercept - 1.96*male_intercept_se), digits=decimal_places),
            " to ",
            round((male_intercept + 1.96*male_intercept_se), digits=decimal_places),
            ")",
            "\n [",
            round((male_intercept_p), digits=decimal_places_p),
            "]"
          )
          ,
      
      slope_male = 
          paste0(
            round(male_slope, digits=decimal_places), 
            "\n (",
            round((male_slope - 1.96*male_slope_se), digits=decimal_places),
            " to ",
            round((male_slope + 1.96*male_slope_se), digits=decimal_places),
            ")",
            "\n [",
            round((male_slope_p), digits=decimal_places_p),
            "]"
          )
          ,

      r_squared_male = 
          round((male_model_r2), digits=decimal_places_p),
        
      model_p_male = 
          round((male_model_p), digits=decimal_places_p),
      
      n_fema = 
          fema_number_in_model
        ,
      
      intercept_fema = 
          paste0(
            round(fema_intercept, digits=decimal_places), 
            "\n (",
            round((fema_intercept - 1.96*fema_intercept_se), digits=decimal_places),
            " to ",
            round((fema_intercept + 1.96*fema_intercept_se), digits=decimal_places),
            ")",
            "\n [",
            round((fema_intercept_p), digits=decimal_places_p),
            "]"
          )
          ,
      
      slope_fema = 
          paste0(
            round(fema_slope, digits=decimal_places), 
            "\n (",
            round((fema_slope - 1.96*fema_slope_se), digits=decimal_places),
            " to ",
            round((fema_slope + 1.96*fema_slope_se), digits=decimal_places),
            ")",
            "\n [",
            round((fema_slope_p), digits=decimal_places_p),
            "]"
          )
          ,

      r_squared_fema = 
          round((fema_model_r2), digits=decimal_places_p),
        
      model_p_fema = 
          round((fema_model_p), digits=decimal_places_p)
      
      )
    

# Do not transpose this one
#results_frame_male_then_fema_t <- as.data.frame(t(results_frame_male_then_fema))
  
  # Save to CSV 
  write.csv(
    results_frame_male_then_fema, 
    file = paste0(
      directory_to_save, 
      "/",
      sub_directory_to_save, 
      "/", 
      y_variable, 
      "__on__", 
      x_variable, 
      "_summary.csv"), 
    row.names = T)
  
  #save to .docx
  
  ft <- flextable(rownames_to_column(results_frame_male_then_fema))
  
  # Customize the table appearance
  ft <- ft %>%
    theme_vanilla() %>%
    align(align = "center", part = "header") %>%
    align(align = "center", part = "body") %>%  
    fontsize(size = 6, part = "all") %>%
    autofit()
  ft <- set_table_properties(ft, layout = "autofit", width = 1)
  
  # Define paragraph formatting with centered alignment
  centered_paragraph <- fp_par(text.align = "center")
  
  doc <- read_docx() %>%
    body_add_flextable(ft) 
  
  print(
    doc, 
    target = file.path(
      paste0(
         directory_to_save, 
      "/",
      sub_directory_to_save, 
      "/", 
      y_variable, 
      "__on__", 
      x_variable,
      "_summary_wide.docx"
      )))

  
  
  regression_plot <- 
    ggplot() +
    
    geom_point(
      data=male_data_to_regress,
        aes(
          x = .data[[x_variable]],
          y = .data[[y_variable]]
          ),
      colour=default_male_colour,
      alpha=alpha_for_points
    ) +
    
    geom_smooth(
      data=male_data_to_regress,
        aes(
          x = .data[[x_variable]],
          y = .data[[y_variable]]
          ),
      method="lm",
      formula = 'y ~ x',
      se=F,
      colour=default_male_colour
    ) +
    
    geom_point(
      data=fema_data_to_regress,
        aes(
          x = .data[[x_variable]],
          y = .data[[y_variable]]
          ),
      colour=default_fema_colour,
      alpha=alpha_for_points
    ) +
    
    geom_smooth(
      data=fema_data_to_regress,
        aes(
          x = .data[[x_variable]],
          y = .data[[y_variable]]
          ),
      formula = 'y ~ x',
      method="lm",
      se=F,
      colour=default_fema_colour
    ) +
    
    coord_cartesian(
      ylim=my_ylim,
      xlim=my_xlim
    ) +
      
    scale_x_continuous(breaks=my_x_breaks) +
    
    scale_y_continuous(breaks=my_y_breaks) +
    
    themepowerpointtitle

  print(regression_plot)
  
  ggsave(filename=
           paste0( 
             y_variable,
             "__on__",
             x_variable,
             ".png"), 
       path=
         paste0(
           sub_directory_file_path),
       plot = regression_plot, 
       device="png",  
       width=10, 
       height=5, 
       limitsize=F)

  ggsave(filename=
           paste0( 
             y_variable,
             "__on__",
             x_variable,
             "_blank.png"), 
       path=
         paste0(
           sub_directory_file_path),
       plot = regression_plot + 
        theme(axis.title=element_blank(), 
              plot.title=element_blank(), 
              plot.subtitle=element_blank()), 
       device="png",  
       width=10, 
       height=5, 
       limitsize=F)
  
  
  # Optionally also return the table for use in R
  return(list(
    results_frame_separate_sex_columns,
    regression_plot
    ))
}

```

```{r, run the linear regression function}
male_data_to_regress <- male_random_effects_weight_height_and_bmi
fema_data_to_regress <- fema_random_effects_weight_height_and_bmi
directory_to_save <- "linear_regression_growth_to_18"
alpha_for_points <- 0.5
my_xlim <- c(0,10)
my_ylim <- c(0,120)
my_x_breaks <- seq(0, 10, by = 2)
my_y_breaks <- seq(20, 140, by = 20)
decimal_places <- 3
decimal_places_p <- 6



for (y_variable in c(
  
  "sitar_weight_at_age_18",
  "sitar_height_at_age_18"
  
)){

for (x_variable in c(
  
  "adiposity_rebound_age",
  "adiposity_rebound_bmi",
  "age_at_latest_peak_height_velocity",
  "height_at_latest_peak_height_velocity"
  
)){
    
    #set the limits based on height or weight
  
  if(grepl(x=y_variable, pattern="sitar_weight_at_age_18")){
      my_ylim <- c(40,120)
      my_y_breaks <- seq(40, 120, by = 20)
    } else if (grepl("sitar_height_at_age_18", y_variable)) {
      my_ylim <- c(120, 200)
      my_y_breaks <- seq(120, 200, by = 20)
    } else {
      my_ylim <- NULL
      my_y_breaks <- NULL
    }

  if(grepl(x=x_variable, pattern="adiposity_rebound_age")){
      my_xlim <- c(0,10)
      my_x_breaks <- seq(0, 10, by = 1)
    } else if (grepl("adiposity_rebound_bmi", x_variable)) {
      my_xlim <- c(12, 24)
      my_x_breaks <- seq(12, 24, by = 2)
    } else if (grepl("age_at_latest_peak_height_velocity", x_variable)) {
      my_xlim <- c(2, 18)
      my_x_breaks <- seq(2, 18, by = 2)
    } else if (grepl("height_at_latest_peak_height_velocity", x_variable)) {
      my_xlim <- c(90, 180)
      my_x_breaks <- seq(90, 180, by = 10)
    } else {
      my_xlim <- NULL
      my_x_breaks <- NULL
    }
  
lm_growth_function_result <-
lm_growth_function(
  x_variable=x_variable,
  y_variable=y_variable,
  directory_to_save=directory_to_save,
  alpha_for_points=alpha_for_points,
  my_xlim=my_xlim,
  my_ylim=my_ylim,
  my_x_breaks=my_x_breaks,
  my_y_breaks=my_y_breaks,
  male_data_to_regress=male_data_to_regress,
  fema_data_to_regress=fema_data_to_regress,
  decimal_places = decimal_places,
  decimal_places_p=decimal_places_p
)

    # Create a name based on x and y
    result_name <- paste0("lm_result_", y_variable, "_on_", x_variable)
    
    # Assign to global environment
    assign(result_name, lm_growth_function_result, envir = .GlobalEnv)

}}
```


```{r}
ar_data_dob_to_join <-
  unique(
    ar_data[,c("id", "dob_to_use", "Centre.Name...Centre")]
  )
ar_data_dob_to_join$id <- as.character(ar_data_dob_to_join$id)
ar_data_dob_to_join$dob_to_model <- as.numeric(ar_data_dob_to_join$dob_to_use)

male_random_effects_weight_height_bmi_and_dob <-
  left_join(
    male_random_effects_weight_height_and_bmi, ar_data_dob_to_join, by = join_by(id)
  )

fema_random_effects_weight_height_bmi_and_dob <-
  left_join(
    fema_random_effects_weight_height_and_bmi, ar_data_dob_to_join, by = join_by(id)
  )

```

```{r}
ggplot(data=male_random_effects_weight_height_bmi_and_dob, aes(x=dob_to_use, y=sitar_height_at_age_18)) +
  geom_point() +
  geom_smooth(method="lm")

ggplot(data=fema_random_effects_weight_height_bmi_and_dob, aes(x=dob_to_use, y=sitar_height_at_age_18)) +
  geom_point() +
  geom_smooth(method="lm")

ggplot(data=male_random_effects_weight_height_bmi_and_dob, aes(x=dob_to_use, y=sitar_weight_at_age_18)) +
  geom_point() +
  geom_smooth(method="lm")

ggplot(data=fema_random_effects_weight_height_bmi_and_dob, aes(x=dob_to_use, y=sitar_weight_at_age_18)) +
  geom_point() +
  geom_smooth(method="lm")
```


```{r}
ggplot(data=male_random_effects_weight_height_bmi_and_dob, 
       aes(x=dob_to_use, y=age_at_latest_peak_height_velocity)) +
  geom_point() +
  geom_smooth(method="lm")

ggplot(data=fema_random_effects_weight_height_bmi_and_dob, 
       aes(x=dob_to_use, y=age_at_latest_peak_height_velocity)) +
  geom_point() +
  geom_smooth(method="lm")

ggplot(data=male_random_effects_weight_height_bmi_and_dob, 
       aes(x=dob_to_use, y=adiposity_rebound_age)) +
  geom_point() +
  geom_smooth(method="lm")

ggplot(data=fema_random_effects_weight_height_bmi_and_dob, 
       aes(x=dob_to_use, y=adiposity_rebound_age)) +
  geom_point() +
  geom_smooth(method="lm")
```
```{r, adiposity rebound age proving to faisal hasnt changed with time}

male_model <-
  lmer(  adiposity_rebound_age ~
       dob_to_model + 
       (1 | Centre.Name...Centre), 
       data=male_random_effects_weight_height_bmi_and_dob)

fema_model <-
  lmer(  adiposity_rebound_age ~
       dob_to_model + 
       (1 | Centre.Name...Centre), 
       data=fema_random_effects_weight_height_bmi_and_dob)

summary(male_model)
summary(fema_model)
```

```{r, adiposity rebound bmi proving to faisal hasnt changed with time}

male_model <-
  lmer(  adiposity_rebound_bmi ~
       dob_to_model + 
       (1 | Centre.Name...Centre), 
       data=male_random_effects_weight_height_bmi_and_dob)

fema_model <-
  lmer(  adiposity_rebound_bmi ~
       dob_to_model + 
       (1 | Centre.Name...Centre), 
       data=fema_random_effects_weight_height_bmi_and_dob)

summary(male_model)
summary(fema_model)
```


```{r, age_at_latest_peak_height_velocity DONT prove to faisal that it hasnt changed with time}


male_model <-
  lmer(  age_at_latest_peak_height_velocity ~
       dob_to_model + 
       (1 | Centre.Name...Centre), 
       data=male_random_effects_weight_height_bmi_and_dob)

fema_model <-
  lmer(  age_at_latest_peak_height_velocity ~
       dob_to_model + 
       (1 | Centre.Name...Centre), 
       data=fema_random_effects_weight_height_bmi_and_dob)

summary(male_model)
summary(fema_model)
```


```{r, end of file so save all the listed dataframes into the parent directory}
rm(ar_data)
save_ar_files_function(
  parent_directory=location_of_data_files,
  parent_file="file_28")
Sys.time()
```